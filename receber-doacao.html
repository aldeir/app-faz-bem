<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receber Doação - App Faz Bem</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/icons/icon-192x192.png" type="image/png">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #modal-placeholder { position: fixed; inset: 0; z-index: 50; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Cabeçalho (será carregado dinamicamente) -->
    <header id="app-header"></header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 md:p-6 max-w-4xl">

        <!-- Loader Principal -->
        <div id="loader" class="flex justify-center items-center h-64">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Container do Formulário (inicialmente oculto) -->
        <div id="form-container" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
                
                <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                    <i class="fas fa-box-open text-3xl text-blue-600 mr-4"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Confirmar Recebimento de Doação</h1>
                        <p class="text-gray-500">Verifique os itens e confirme as quantidades recebidas.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div>
                        <h3 class="font-semibold text-gray-700"><i class="fas fa-bullhorn mr-2 text-blue-500"></i>Campanha</h3>
                        <p id="campaign-name" class="text-gray-900 font-bold text-lg">-</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700"><i class="fas fa-user-heart mr-2 text-blue-500"></i>Doador(a)</h3>
                        <p id="donor-name" class="text-gray-900">-</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Data do Agendamento</h3>
                        <p id="schedule-date" class="text-gray-900">-</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Itens da Doação</h2>
                    <div id="items-list" class="space-y-4"></div>
                </div>

                <div class="mb-8">
                    <label for="observations" class="block text-lg font-bold text-gray-800 mb-2">Observações (Opcional)</label>
                    <textarea id="observations" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: O doador entregou um item extra..."></textarea>
                </div>

                <div class="flex flex-col md:flex-row justify-end items-center gap-4 pt-6 border-t border-gray-200">
                     <button onclick="window.history.back()" class="w-full md:w-auto px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    <button id="confirm-button" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition">
                        <i class="fas fa-check-circle mr-2"></i>Confirmar Recebimento
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Placeholder -->
    <div id="modal-placeholder"></div>

    <!-- Scripts do Firebase (Compatibilidade) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Script principal da página -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO (INTEGRADAS) ---
        // Cole aqui o conteúdo do seu arquivo firebaseConfig
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicializa o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Constantes de coleções (integradas)
        const USUARIOS = 'usuarios';
        const CAMPANHAS = 'campanhas';
        const AGENDAMENTOS = 'agendamentos';
        const NOTIFICACOES = 'notificacoes';

        // --- FUNÇÕES ESSENCIAIS (INTEGRADAS) ---

        function showModal(title, message, confirmText = 'Ok', cancelText = null, onConfirm = null) {
            const modalContainer = document.getElementById('modal-placeholder');
            if (!modalContainer) return;
            const modalId = 'feedback-modal';
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-bold text-gray-800 mb-3">${title}</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                        </div>
                        <div class="flex justify-center gap-4 p-4 bg-gray-50 rounded-b-2xl">
                            ${cancelText ? `<button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">${cancelText}</button>` : ''}
                            <button id="modal-confirm-btn" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">${confirmText}</button>
                        </div>
                    </div>
                </div>`;
            modalContainer.innerHTML = modalHTML;

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const closeModal = () => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) modalElement.remove();
            };

            confirmBtn.onclick = () => {
                if (onConfirm) onConfirm();
                closeModal();
            };

            if (cancelBtn) cancelBtn.onclick = closeModal;
        }

        async function getUserProfile(uid) {
            if (!uid) return null;
            try {
                const userRef = db.collection(USUARIOS).doc(uid);
                const userSnap = await userRef.get();
                return userSnap.exists ? userSnap.data() : null;
            } catch (error) {
                console.error("Erro ao buscar perfil do usuário:", error);
                return null;
            }
        }

        async function loadHeader() {
            const headerContainer = document.getElementById('app-header');
            if (!headerContainer) return;

            auth.onAuthStateChanged(async (user) => {
                const profile = user ? await getUserProfile(user.uid) : null;
                const role = profile?.role;

                let navLinks = '<a href="index.html" class="text-gray-700 hover:text-blue-600 font-medium">Início</a>';
                if (role === 'entidade') {
                    navLinks += '<a href="admin.html" class="text-gray-700 hover:text-blue-600 font-medium">Painel</a>';
                    navLinks += '<a href="gerenciar-campanhas.html" class="text-gray-700 hover:text-blue-600 font-medium">Campanhas</a>';
                } else if (role === 'superadmin') {
                    navLinks += '<a href="superadmin.html" class="text-gray-700 hover:text-blue-600 font-medium">Painel Geral</a>';
                }

                const headerHTML = `
                    <nav class="bg-white shadow-md p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <a href="index.html" class="text-xl font-bold text-blue-600">App Faz Bem</a>
                            <div class="hidden md:flex items-center space-x-6">${navLinks}</div>
                            <div class="flex items-center space-x-4">
                                ${user ? `<a href="configuracoes.html" class="text-gray-600 hover:text-blue-600"><i class="fas fa-cog"></i></a><button onclick="firebase.auth().signOut().then(() => window.location.href='index.html')" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600">Sair</button>` : `<a href="login.html" class="font-semibold text-blue-600 hover:text-blue-700">Entrar</a>`}
                            </div>
                        </div>
                    </nav>`;
                headerContainer.innerHTML = headerHTML;
            });
        }

        // --- LÓGICA PRINCIPAL DA PÁGINA ---

        const loader = document.getElementById('loader');
        const formContainer = document.getElementById('form-container');
        const campaignNameEl = document.getElementById('campaign-name');
        const donorNameEl = document.getElementById('donor-name');
        const scheduleDateEl = document.getElementById('schedule-date');
        const itemsListEl = document.getElementById('items-list');
        const observationsEl = document.getElementById('observations');
        const confirmButton = document.getElementById('confirm-button');

        let agendamentoId = null;
        let agendamentoData = null;
        let currentUserProfile = null;

        loadHeader();
        
        const urlParams = new URLSearchParams(window.location.search);
        agendamentoId = urlParams.get('id');

        if (!agendamentoId) {
            showErrorAndRedirect("ID do agendamento não encontrado na URL.");
            return;
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserProfile = await getUserProfile(user.uid);
                if (currentUserProfile && (currentUserProfile.role === 'entidade' || currentUserProfile.role === 'superadmin')) {
                    await loadDonationDetails();
                } else {
                    showErrorAndRedirect("Acesso negado. Você não tem permissão para ver esta página.");
                }
            } else {
                showErrorAndRedirect("Você precisa estar logado para acessar esta página.", "login.html");
            }
        });

        async function loadDonationDetails() {
            try {
                const agendamentoRef = db.collection(AGENDAMENTOS).doc(agendamentoId);
                const agendamentoSnap = await agendamentoRef.get();

                if (!agendamentoSnap.exists) {
                    showErrorAndRedirect("Agendamento não encontrado.");
                    return;
                }

                agendamentoData = agendamentoSnap.data();

                if (agendamentoData.status === 'recebido') {
                    showErrorAndRedirect("Esta doação já foi confirmada anteriormente.");
                    return;
                }

                const donorSnap = await db.collection(USUARIOS).doc(agendamentoData.doadorId).get();
                const campaignSnap = await db.collection(CAMPANHAS).doc(agendamentoData.campanhaId).get();

                if (!donorSnap.exists || !campaignSnap.exists) {
                    showErrorAndRedirect("Não foi possível carregar os detalhes do doador ou da campanha.");
                    return;
                }
                
                const donorData = donorSnap.data();
                const campaignData = campaignSnap.data();

                campaignNameEl.textContent = campaignData.titulo;
                donorNameEl.textContent = donorData.nome;
                scheduleDateEl.textContent = new Date(agendamentoData.dataAgendamento.seconds * 1000).toLocaleDateString('pt-BR', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });

                renderItemsList(agendamentoData.itens);
                
                loader.classList.add('hidden');
                formContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao carregar detalhes da doação: ", error);
                showErrorAndRedirect("Ocorreu um erro ao carregar as informações. Tente novamente.");
            }
        }

        function renderItemsList(items) {
            itemsListEl.innerHTML = '';
            items.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-gray-100 p-3 rounded-lg border';
                itemEl.innerHTML = `
                    <div class="md:col-span-5 font-semibold text-gray-800"><i class="fas fa-gift text-gray-500 mr-2"></i><span>${item.nome}</span></div>
                    <div class="md:col-span-3"><label class="text-sm font-medium text-gray-600">Qtd. Prometida</label><p class="font-bold text-lg text-gray-800">${item.quantidade}</p></div>
                    <div class="md:col-span-4"><label for="item-qty-${index}" class="text-sm font-medium text-gray-600">Qtd. Recebida</label><input type="number" id="item-qty-${index}" data-item-name="${item.nome}" value="${item.quantidade}" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"></div>
                `;
                itemsListEl.appendChild(itemEl);
            });
        }

        confirmButton.addEventListener('click', () => {
            showModal(
                'Confirmação', 
                'Você tem certeza que deseja confirmar o recebimento dos itens? Esta ação não pode ser desfeita.',
                'Confirmar', 'Cancelar', handleConfirmation
            );
        });
        
        async function handleConfirmation() {
            confirmButton.disabled = true;
            confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';

            try {
                const batch = db.batch();
                const agendamentoRef = db.collection(AGENDAMENTOS).doc(agendamentoId);
                const itensRecebidos = Array.from(itemsListEl.querySelectorAll('input[type="number"]')).map(input => ({
                    nome: input.dataset.itemName,
                    quantidade: parseInt(input.value, 10) || 0
                }));

                batch.update(agendamentoRef, {
                    status: 'recebido',
                    dataRecebimento: new Date(),
                    observacoes: observationsEl.value,
                    itensRecebidos: itensRecebidos,
                    confirmadoPor: {
                        uid: auth.currentUser.uid,
                        nome: currentUserProfile.nome,
                        role: currentUserProfile.role
                    }
                });

                const campanhaRef = db.collection(CAMPANHAS).doc(agendamentoData.campanhaId);
                const campanhaSnap = await campanhaRef.get();
                const campanhaData = campanhaSnap.data();
                
                // Lógica de atualização de estoque mais robusta
                const novosItensCampanha = [...campanhaData.itens];
                let houveAlteracao = false;
                itensRecebidos.forEach(itemRecebido => {
                    const itemIndex = novosItensCampanha.findIndex(i => i.nome === itemRecebido.nome);
                    if (itemIndex > -1) {
                        novosItensCampanha[itemIndex].arrecadado = (novosItensCampanha[itemIndex].arrecadado || 0) + itemRecebido.quantidade;
                        houveAlteracao = true;
                    }
                });
                if(houveAlteracao) {
                    batch.update(campanhaRef, { itens: novosItensCampanha });
                }

                const notificacaoDoadorRef = db.collection(NOTIFICACOES).doc();
                batch.set(notificacaoDoadorRef, {
                    userId: agendamentoData.doadorId,
                    titulo: "Doação Recebida!",
                    mensagem: `Sua doação para a campanha "${campanhaData.titulo}" foi recebida com sucesso. Muito obrigado!`,
                    data: new Date(),
                    lida: false,
                    link: `/minhas-entregas.html?id=${agendamentoId}`
                });

                await batch.commit();

                showModal('Sucesso!', 'A doação foi confirmada e o estoque da campanha foi atualizado.', 'Ok', null, () => {
                    window.location.href = currentUserProfile.role === 'superadmin' ? 'gerenciar-agendamentos-global.html' : 'gerenciar-agendamentos.html';
                });

            } catch (error) {
                console.error("Erro ao confirmar recebimento: ", error);
                showModal('Erro', 'Não foi possível confirmar o recebimento. Por favor, tente novamente.');
                confirmButton.disabled = false;
                confirmButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirmar Recebimento';
            }
        }

        function showErrorAndRedirect(message, redirectPage = 'index.html') {
            loader.classList.add('hidden');
            showModal('Atenção', message, 'Ok', null, () => {
                window.location.href = redirectPage;
            });
        }
    });
    </script>
</body>
</html>
