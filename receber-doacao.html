<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Doações Recebidas - App Faz Bem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .item-row:hover { background-color: #f9fafb; }
        .truncate-2-lines {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <main class="container mx-auto p-4">
        <div id="loading-view" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">A carregar as suas doações...</p>
            </div>
        </div>

        <div id="donations-view" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Gerenciar Doações</h1>
                <button onclick="window.openQrModal()" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300 flex items-center justify-center w-full sm:w-auto">
                    <i class="fas fa-qrcode mr-2"></i> Ler QR Code da Doação
                </button>
            </div>

            <!-- Abas de Navegação -->
            <div class="border-b border-gray-200 mb-6">
                <nav id="tabs-container" class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button data-tab="pending" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Pendentes</button>
                    <button data-tab="overdue" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Vencidos</button>
                    <button data-tab="completed" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico (Recebidos)</button>
                </nav>
            </div>

            <div id="donations-container" class="space-y-8"></div>
            <div id="no-donations-message" class="text-center py-10 hidden">
                <i class="fas fa-box-open text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Nenhum item encontrado nesta categoria.</p>
            </div>
            <div id="pagination-container" class="mt-8 text-center"></div>
        </div>
    </main>

    <!-- Modal Genérico -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold">Detalhes</h3>
                <button onclick="window.closeModal()" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>
    
    <!-- Modal QR Code -->
    <div id="qr-code-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Ler QR Code da Doação</h3>
                <button onclick="window.closeQrModal()" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="qr-reader" style="width: 100%;"></div>
                <div id="qr-reader-results" class="mt-4 text-center"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script type="module">
        import { db, auth, paths } from './app-config.js';
        import { collection, query, where, getDocs, getDoc, doc, updateDoc } from './firebase-services.js';
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';

        const loadingView = document.getElementById('loading-view');
        const donationsView = document.getElementById('donations-view');
        const donationsContainer = document.getElementById('donations-container');
        const noDonationsMessage = document.getElementById('no-donations-message');
        const detailsModal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const qrCodeModal = document.getElementById('qr-code-modal');
        const tabsContainer = document.getElementById('tabs-container');
        const paginationContainer = document.getElementById('pagination-container');
        
        let html5QrCode;
        let allDonationsData = [];
        let profilesCache = new Map();
        let campaignsCache = new Map();
        let completedItemsPage = 1;
        const ITEMS_PER_PAGE = 10;

        async function initializeApp() {
            await injectHeader();
            const userSession = await getCurrentUser();
            if (userSession?.profile?.role === 'entidade' && auth.currentUser) {
                await loadAllDonationsForEntity(auth.currentUser.uid);
            } else {
                window.location.href = 'index.html';
            }
        }

        async function loadAllDonationsForEntity(entityId) {
            loadingView.classList.remove('hidden');
            donationsView.classList.add('hidden');
            
            try {
                const donationsQuery = query(collection(db, paths.donations), where('entityId', '==', entityId));
                const querySnapshot = await getDocs(donationsQuery);
                
                allDonationsData = [];
                for (const donationDoc of querySnapshot.docs) {
                    allDonationsData.push({ id: donationDoc.id, ...donationDoc.data() });
                }

                await renderItemsByStatus();
            } catch (error) {
                console.error("Erro ao carregar doações: ", error);
            } finally {
                loadingView.classList.add('hidden');
                donationsView.classList.remove('hidden');
            }
        }

        async function renderItemsByStatus(filterDonationId = null) {
            donationsContainer.innerHTML = '';
            paginationContainer.innerHTML = '';
            const activeTab = tabsContainer.querySelector('.tab-button.active').dataset.tab;
            const now = new Date();

            let itemsToDisplay = [];
            let sourceDonations = filterDonationId ? allDonationsData.filter(d => d.id === filterDonationId) : allDonationsData;

            sourceDonations.forEach(donation => {
                donation.items.forEach((item, index) => {
                    itemsToDisplay.push({ ...item, donationId: donation.id, itemIndex: index, donorId: donation.donorId, campaignId: donation.campaignId, scheduledAt: donation.scheduledAt?.toDate() });
                });
            });

            let filteredItems = itemsToDisplay.filter(item => {
                const isOverdue = item.scheduledAt < now;
                switch (activeTab) {
                    case 'pending': return item.status === 'pending' && !isOverdue;
                    case 'overdue': return item.status === 'pending' && isOverdue;
                    case 'completed': return item.status !== 'pending'; // Mostra recebidos, cancelados, etc.
                    default: return false;
                }
            });

            if (filteredItems.length === 0) {
                noDonationsMessage.style.display = 'block';
                return;
            }
            noDonationsMessage.style.display = 'none';

            // Paginação para a aba de histórico
            const itemsForCurrentPage = (activeTab === 'completed') 
                ? filteredItems.slice(0, completedItemsPage * ITEMS_PER_PAGE)
                : filteredItems;

            const itemsByCampaign = itemsForCurrentPage.reduce((acc, item) => {
                if (!acc[item.campaignId]) acc[item.campaignId] = [];
                acc[item.campaignId].push(item);
                return acc;
            }, {});

            for (const campaignId in itemsByCampaign) {
                let campaignData;
                if (campaignsCache.has(campaignId)) {
                    campaignData = campaignsCache.get(campaignId);
                } else {
                    const campaignDoc = await getDoc(doc(db, paths.campaignDoc(campaignId)));
                    campaignData = campaignDoc.exists() ? {id: campaignDoc.id, ...campaignDoc.data()} : { id: campaignId, title: 'Campanha Desconhecida' };
                    campaignsCache.set(campaignId, campaignData);
                }
                
                const campaignCard = await createCampaignCard(campaignData, itemsByCampaign[campaignId]);
                if (campaignCard) {
                    donationsContainer.appendChild(campaignCard);
                }
            }

            // Renderiza o botão "Carregar Mais" se necessário
            if (activeTab === 'completed' && filteredItems.length > itemsForCurrentPage.length) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.textContent = 'Carregar Mais Itens';
                loadMoreBtn.className = 'bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition';
                loadMoreBtn.onclick = () => {
                    completedItemsPage++;
                    renderItemsByStatus();
                };
                paginationContainer.appendChild(loadMoreBtn);
            }
        }

        async function createCampaignCard(campaign, items) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-6';
            
            const itemsHtml = await Promise.all(items.map(async item => {
                let donorName = 'Doador Anônimo';
                if (profilesCache.has(item.donorId)) {
                    donorName = profilesCache.get(item.donorId).displayName;
                } else {
                    const donorDoc = await getDoc(doc(db, paths.userDoc(item.donorId)));
                    if (donorDoc.exists()) {
                        const donorData = donorDoc.data();
                        profilesCache.set(item.donorId, donorData);
                        donorName = donorData.displayName;
                    }
                }

                const uniqueItemId = `${item.donationId}_${item.itemIndex}`;
                const isCompleted = item.status === 'completed';
                let receivedByText = '';
                if (isCompleted && item.receivedBy) {
                    if (profilesCache.has(item.receivedBy)) {
                        receivedByText = `Recebido por: ${profilesCache.get(item.receivedBy).displayName}`;
                    } else {
                        const receiverDoc = await getDoc(doc(db, paths.userDoc(item.receivedBy)));
                        if(receiverDoc.exists()) {
                            profilesCache.set(item.receivedBy, receiverDoc.data());
                            receivedByText = `Recebido por: ${receiverDoc.data().displayName}`;
                        }
                    }
                }

                return `
                <div id="item-row-${uniqueItemId}" class="item-row flex items-center justify-between p-2 border-b last:border-b-0">
                    <div class="flex items-center space-x-4 flex-grow">
                        <img src="${item.photoURL || 'https://placehold.co/64x64/e2e8f0/e2e8f0?text=Item'}" alt="${item.type}" class="w-16 h-16 rounded-md object-cover">
                        <div>
                            <p class="font-semibold text-gray-800">${item.type}</p>
                            <p class="text-sm text-gray-600">Doador: ${donorName}</p>
                            ${isCompleted ? `<p class="text-xs text-green-600">${receivedByText}</p>` : ''}
                        </div>
                    </div>
                    ${!isCompleted ? `<button onclick="window.confirmItemReception('${item.donationId}', ${item.itemIndex})" class="bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition duration-300">Receber</button>` : ''}
                </div>`;
            }));
            
            if (itemsHtml.join('').trim() === '') return null;

            card.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <div class="flex items-start space-x-4">
                        <img src="${campaign.images?.[0] || 'https://placehold.co/80x80/e2e8f0/e2e8f0?text=Campanha'}" class="w-20 h-20 rounded-lg object-cover flex-shrink-0">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${campaign.title}</h3>
                            <p class="text-sm text-gray-600 mt-1 truncate-2-lines">${campaign.description || ''}</p>
                            <button onclick="window.showCampaignDetails('${campaign.id}')" class="text-sm font-semibold text-blue-600 hover:underline mt-2">Ver Detalhes</button>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">${itemsHtml.join('')}</div>`;
            return card;
        }

        window.openModal = () => detailsModal.style.display = 'flex';
        window.closeModal = () => detailsModal.style.display = 'none';
        
        window.showCampaignDetails = (campaignId) => {
            const campaign = campaignsCache.get(campaignId);
            if (!campaign) return;
            modalTitle.innerText = 'Detalhes da Campanha';
            modalContent.innerHTML = `
                <h3 class="font-bold text-lg text-gray-900">${campaign.title}</h3>
                <p class="text-sm text-gray-500 mt-1">Organizado por: ${campaign.entityName || 'N/A'}</p>
                <p class="mt-4 text-gray-700 whitespace-pre-wrap">${campaign.description}</p>
            `;
            openModal();
        };

        window.confirmItemReception = (donationId, itemIndex) => {
            const donation = allDonationsData.find(d => d.id === donationId);
            const item = donation?.items[itemIndex];
            if (!item) return;

            modalContent.innerHTML = `
                <div class="text-center">
                    <img src="${item.photoURL || 'https://placehold.co/400x400/e2e8f0/e2e8f0?text=Sem+Imagem'}" alt="Foto de ${item.type}" class="w-full h-64 object-contain rounded-md mb-4 bg-gray-100">
                    <p class="font-bold text-lg text-gray-900">${item.type}</p>
                    <p class="text-sm text-gray-600">${item.details} (${item.condition})</p>
                    <p class="mt-4">Você confirma o recebimento deste item?</p>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="window.closeModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-reception-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Sim, Recebido</button>
                </div>
            `;
            openModal();
            document.getElementById('confirm-reception-btn').onclick = () => processItemReception(donationId, itemIndex);
        };
        
        async function processItemReception(donationId, itemIndex) {
            modalContent.innerHTML = '<div class="loader mx-auto"></div><p class="text-center mt-2">Processando...</p>';
            const donationRef = doc(db, paths.donationDoc(donationId));
            try {
                const docSnap = await getDoc(donationRef);
                if (!docSnap.exists()) throw new Error("Doação não encontrada!");

                const currentDonation = docSnap.data();
                const updatedItems = [...currentDonation.items];
                
                updatedItems[itemIndex] = { ...updatedItems[itemIndex], status: 'completed', receivedBy: auth.currentUser.uid, receivedDate: new Date() };
                await updateDoc(donationRef, { items: updatedItems });

                const cachedDonation = allDonationsData.find(d => d.id === donationId);
                if (cachedDonation) cachedDonation.items[itemIndex].status = 'completed';

                await renderItemsByStatus();
                closeModal();
            } catch (error) {
                console.error("Erro ao confirmar recebimento do item: ", error);
            }
        }
        
        window.openQrModal = () => {
            qrCodeModal.style.display = 'flex';
            startQrScanner();
        };

        window.closeQrModal = () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Falha ao parar o scanner.", err));
            }
            qrCodeModal.style.display = 'none';
            document.getElementById('qr-reader-results').innerHTML = '';
            renderItemsByStatus();
        };

        function startQrScanner() {
            const qrReaderElement = document.getElementById('qr-reader');
            const resultsElement = document.getElementById('qr-reader-results');
            qrReaderElement.innerHTML = '';
            resultsElement.innerHTML = 'Aponte a câmera para o QR Code da doação.';
            html5QrCode = new Html5Qrcode("qr-reader");
            const qrCodeSuccessCallback = (decodedText) => {
                html5QrCode.stop();
                const donationExists = allDonationsData.some(d => d.id === decodedText);
                if (donationExists) {
                    resultsElement.innerHTML = `<p class="text-green-600 font-bold">Doação encontrada! Exibindo itens...</p>`;
                    renderItemsByStatus(decodedText);
                    setTimeout(window.closeQrModal, 1500);
                } else {
                    resultsElement.innerHTML = `<p class="text-red-500 font-bold">QR Code inválido ou doação não encontrada!</p>`;
                }
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(() => html5QrCode.start({ facingMode: "user" }, config, qrCodeSuccessCallback)
                .catch(() => resultsElement.innerHTML = `<p class="text-red-500">Erro ao iniciar a câmera.</p>`));
        }

        tabsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button.tab-button');
            if (button) {
                tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                completedItemsPage = 1; // Reseta a paginação ao trocar de aba
                renderItemsByStatus();
            }
        });

        initializeApp();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(reg => {
                    console.log('ServiceWorker registrado com sucesso.', reg);
                }).catch(err => {
                    console.log('Falha ao registrar o ServiceWorker: ', err);
                });
            });
        }
    </script>
</body>
</html>
