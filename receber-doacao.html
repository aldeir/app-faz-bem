<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Recebimentos - App Faz Bem</title>
    
    <meta name="theme-color" content="#22c55e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">

    <link href="/app-faz-bem/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #qr-reader { width: 100%; max-width: 500px; border-radius: 0.75rem; overflow: hidden; }
        .view-toggle-btn.active { background-color: #16a34a; color: white; }
        .view-toggle-btn { background-color: #e5e7eb; color: #374151; }
        .schedule-slot {
            transition: all 0.2s ease-in-out; cursor: pointer; border: 1px solid #d1d5db;
        }
        .schedule-slot:not(:disabled):hover {
            border-color: #3b82f6; transform: translateY(-2px);
        }
        .schedule-slot.active {
            background-color: #3b82f6; color: white; border-color: #2563eb;
            transform: translateY(-2px); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .schedule-slot.active .slot-donors { color: #dbeafe; }
        .schedule-slot:disabled {
            background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <main class="container mx-auto p-4 sm:p-6">
        <div id="loading-view" class="min-h-[calc(100vh-150px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">A carregar agendamentos...</p>
            </div>
        </div>

        <div id="donations-view" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Gerenciar Recebimentos</h1>
                    <p class="text-gray-600 mt-1">Acompanhe as doações agendadas e recebidas.</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="scan-qr-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 0h-4v4m0 12v-4h4m-12 0H4v-4"></path></svg>
                        Ler QR Code
                    </button>
                    <a id="back-link" href="admin.html" class="text-sm font-medium text-gray-600 hover:text-green-600">← Voltar</a>
                </div>
            </div>

            <div class="mb-6 flex justify-center p-1 rounded-lg bg-gray-200 w-full sm:w-auto sm:mx-auto">
                <button id="toggle-agenda-view" class="view-toggle-btn active w-1/2 font-semibold py-2 px-4 rounded-md transition-colors">Visão de Agenda</button>
                <button id="toggle-list-view" class="view-toggle-btn w-1/2 font-semibold py-2 px-4 rounded-md transition-colors">Visão de Lista</button>
            </div>

            <div id="agenda-view">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-day-btn" class="p-2 rounded-full hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-chevron-left fa-lg text-gray-600"></i></button>
                        <h2 id="selected-date-display" class="text-xl font-bold text-center text-gray-700"></h2>
                        <button id="next-day-btn" class="p-2 rounded-full hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-chevron-right fa-lg text-gray-600"></i></button>
                    </div>
                    <div id="schedule-slots-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                    <p id="no-slots-message" class="text-center text-gray-500 py-8 hidden">Nenhum agendamento para este dia.</p>
                </div>
                <div id="items-container" class="mt-8">
                    <h3 id="items-header" class="text-2xl font-bold text-gray-800 mb-4 hidden">Itens Agendados</h3>
                    <div id="items-list" class="space-y-3"></div>
                    <p id="select-slot-prompt" class="text-center text-gray-500 py-10 bg-white rounded-lg shadow-sm">Selecione um horário acima para visualizar os detalhes.</p>
                </div>
            </div>

            <div id="list-view" class="hidden space-y-8"></div>
        </div>
    </main>

    <div id="qr-modal" class="hidden fixed z-40 inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 text-center relative">
            <button id="close-qr-modal-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 z-50">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Leitor de QR Code</h2>
            <div id="qr-reader-container" class="mx-auto">
                <div id="qr-reader"></div>
                <p id="qr-reader-status" class="mt-4 text-sm text-gray-500">Aponte a câmera para o QR Code...</p>
            </div>
            <div id="qr-result-container" class="hidden mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Item Identificado</h3>
                <div id="qr-item-details" class="border rounded-lg p-4 text-left flex items-start space-x-4 bg-gray-50"></div>
                <button id="qr-confirm-reception-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg shadow-md">
                    Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>
    
    <div id="app-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3><div class="mt-2"><div class="text-sm text-gray-600 space-y-2" id="modal-message-body"></div></div></div></div></div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse" id="modal-buttons"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { db, auth, paths } from './app-config.js';
        import { collection, query, where, onSnapshot, getDoc, doc, updateDoc, getDocs } from './firebase-services.js';
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';
        import { showDetailsModal, showAlertModal } from './modal-handler.js';
        import { createNotification } from './notification-service.js';

        const loadingView = document.getElementById('loading-view');
        const donationsView = document.getElementById('donations-view');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const scheduleSlotsGrid = document.getElementById('schedule-slots-grid');
        const noSlotsMessage = document.getElementById('no-slots-message');
        const itemsHeader = document.getElementById('items-header');
        const itemsList = document.getElementById('items-list');
        const selectSlotPrompt = document.getElementById('select-slot-prompt');
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrModal = document.getElementById('qr-modal');
        const closeQrModalBtn = document.getElementById('close-qr-modal-btn');
        const qrReaderContainer = document.getElementById('qr-reader-container');
        const qrResultContainer = document.getElementById('qr-result-container');
        const qrItemDetails = document.getElementById('qr-item-details');
        const qrConfirmBtn = document.getElementById('qr-confirm-reception-btn');
        const qrReaderStatus = document.getElementById('qr-reader-status');
        const toggleAgendaBtn = document.getElementById('toggle-agenda-view');
        const toggleListBtn = document.getElementById('toggle-list-view');
        const agendaView = document.getElementById('agenda-view');
        const listView = document.getElementById('list-view');
        const backLink = document.getElementById('back-link');
        
        let allDonations = [];
        let campaignsData = new Map();
        let campaignTypeSettings = {};
        let availableDates = [];
        let currentDateIndex = -1;
        let html5QrCode;
        let lastScannedDonation = null;

        async function initializeApp() {
            await injectHeader();
            const userSession = await getCurrentUser();
            
            if (userSession?.auth && ['entidade', 'superadmin'].includes(userSession.profile?.role)) {
                const typesSnap = await getDoc(doc(db, paths.configDoc('campaignTypes')));
                campaignTypeSettings = typesSnap.exists() ? typesSnap.data() : {};

                let idToQuery;
                if (userSession.profile.role === 'superadmin') {
                    backLink.href = 'superadmin.html';
                    idToQuery = 'app_faz_bem';
                } else {
                    backLink.href = 'admin.html';
                    idToQuery = userSession.auth.uid;
                }

                await loadAllCampaignsForEntity(idToQuery);
                loadAllDonations(idToQuery);
            } else {
                window.location.href = 'index.html';
            }
        }
        
        async function loadAllCampaignsForEntity(idToQuery) {
            const q = query(collection(db, paths.campaigns), where("entityId", "==", idToQuery));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => campaignsData.set(doc.id, { id: doc.id, ...doc.data() }));
        }

        function loadAllDonations(idToQuery) {
            const q = query(collection(db, paths.donations), where('entityId', '==', idToQuery));
            
            onSnapshot(q, (snapshot) => {
                allDonations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const scheduledDonations = allDonations.filter(d => d.status === 'scheduled');
                const uniqueDates = [...new Set(scheduledDonations.map(d => d.scheduledAt.toDate().toISOString().split('T')[0]))];
                availableDates = uniqueDates.sort();
                
                const todayStr = new Date().toISOString().split('T')[0];
                currentDateIndex = availableDates.findIndex(dateStr => dateStr >= todayStr);
                if (currentDateIndex === -1 && availableDates.length > 0) {
                    currentDateIndex = availableDates.length - 1;
                }

                renderScheduleForSelectedDate();
                if(document.getElementById('list-view').classList.contains('hidden') === false) {
                    renderListView();
                }
                
                if (!loadingView.classList.contains('hidden')) {
                    loadingView.classList.add('hidden');
                    donationsView.classList.remove('hidden');
                }
            });
        }
        
        function renderScheduleForSelectedDate() {
            prevDayBtn.disabled = currentDateIndex <= 0;
            nextDayBtn.disabled = currentDateIndex >= availableDates.length - 1;

            if (currentDateIndex === -1) {
                selectedDateDisplay.textContent = "Nenhum Agendamento";
                noSlotsMessage.style.display = 'block';
                scheduleSlotsGrid.innerHTML = '';
                itemsList.innerHTML = '';
                selectSlotPrompt.style.display = 'block';
                itemsHeader.classList.add('hidden');
                return;
            }

            const selectedDateStr = availableDates[currentDateIndex];
            const selectedDate = new Date(selectedDateStr + 'T00:00:00');
            selectedDateDisplay.textContent = selectedDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
            
            const donationsForDay = allDonations.filter(d => d.status === 'scheduled' && d.scheduledAt.toDate().toISOString().split('T')[0] === selectedDateStr);

            scheduleSlotsGrid.innerHTML = '';
            itemsList.innerHTML = '';
            selectSlotPrompt.style.display = 'block';
            itemsHeader.classList.add('hidden');
            noSlotsMessage.style.display = 'none';

            const slots = donationsForDay.reduce((acc, donation) => {
                const time = donation.scheduledAt.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                if (!acc[time]) acc[time] = { donors: new Set(), items: 0, donations: [] };
                acc[time].donors.add(donation.donorId);
                acc[time].items += (donation.items || []).filter(i => i.status !== 'completed').length;
                acc[time].donations.push(donation);
                return acc;
            }, {});

            const sortedTimes = Object.keys(slots).sort();

            sortedTimes.forEach(time => {
                const slotData = slots[time];
                if (slotData.items === 0) return;
                const isOverdue = new Date(selectedDateStr + 'T' + time) < new Date();
                const slotEl = document.createElement('button');
                slotEl.className = 'schedule-slot p-3 rounded-lg text-left';
                if (isOverdue) slotEl.classList.add('!border-red-500', 'bg-red-50');
                slotEl.innerHTML = `
                    <p class="font-bold text-lg">${time}</p>
                    <p class="slot-donors text-sm text-gray-500">${slotData.donors.size} doador(es)</p>
                    <p class="text-sm font-semibold">${slotData.items} item(ns) pendente(s)</p>
                `;
                slotEl.addEventListener('click', () => {
                    document.querySelectorAll('.schedule-slot.active').forEach(el => el.classList.remove('active'));
                    slotEl.classList.add('active');
                    renderItemsForSlot(slotData.donations, time);
                });
                scheduleSlotsGrid.appendChild(slotEl);
            });
        }

        function renderItemsForSlot(donations, time) {
            selectSlotPrompt.style.display = 'none';
            itemsHeader.classList.remove('hidden');
            itemsHeader.textContent = `Itens agendados para as ${time}`;
            itemsList.innerHTML = '';

            donations.forEach(donation => {
                const donorName = donation.donorName || "Doador Anônimo";
                
                const itemsHtml = (donation.items || []).map((item, index) => {
                    if (item.status === 'completed') return ''; 

                    const campaign = campaignsData.get(donation.campaignId);
                    const typeConfig = campaignTypeSettings[campaign?.type] || { color: 'gray' };
                    const colorMap = { green: 'border-green-500', blue: 'border-blue-500', yellow: 'border-yellow-500', red: 'border-red-500', purple: 'border-purple-500', gray: 'border-gray-500' };
                    const borderColor = colorMap[typeConfig.color] || 'border-gray-500';
                    
                    const isCampaignActive = campaign && campaign.expiresAt.toDate() > new Date();
                    
                    let statusHtml;
                    if (isCampaignActive) {
                        const isOverdue = donation.scheduledAt.toDate() < new Date();
                        const buttonText = isOverdue ? 'Receber (Vencido)' : 'Receber';
                        statusHtml = `<button data-donation-id="${donation.id}" data-item-index="${index}" class="receive-btn bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition">${buttonText}</button>`;
                    } else {
                        statusHtml = `<p class="text-xs text-gray-500 font-semibold">Campanha Encerrada</p>`;
                    }

                    const itemDetailsHtml = generateItemDetailsHtml(item, campaign?.type);

                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between border-l-4 ${borderColor}">
                            <div class="flex items-center space-x-4 flex-grow">
                                <img src="${item.photoURL || 'https://placehold.co/48x48/e2e8f0/e2e8f0?text=Item'}" alt="${item.type}" class="w-12 h-12 rounded-md object-cover">
                                <div class="flex-grow">
                                    <p class="font-semibold text-gray-800">${item.type}</p>
                                    ${itemDetailsHtml}
                                </div>
                            </div>
                            <div class="text-right w-36">${statusHtml}</div>
                        </div>
                    `;
                }).join('');

                if (itemsHtml.trim() !== '') {
                    const donorSection = document.createElement('div');
                    donorSection.innerHTML = `<div class="mb-4"><h4 class="font-bold text-lg text-gray-800">${donorName}</h4><div class="pl-4 mt-2 space-y-2">${itemsHtml}</div></div>`;
                    itemsList.appendChild(donorSection);
                }
            });
        }
        
        // --- INÍCIO DA ALTERAÇÃO ---
        function generateItemDetailsHtml(item, campaignType) {
            let detailsHtml = '<div class="space-y-1">';
            const fieldsConfig = Array.isArray(campaignTypeSettings[campaignType]?.fields) ? campaignTypeSettings[campaignType].fields : Object.values(campaignTypeSettings[campaignType]?.fields || {});
            
            let hasVisibleFields = false;
            fieldsConfig
                .sort((a, b) => (a.order || 0) - (b.order || 0))
                .forEach(field => {
                    const value = item[field.id];
                    const isMediaField = field.type === 'image' || field.type === 'camera' || field.type === 'video';

                    if (value && field.id && field.id !== 'type' && field.id !== 'photoURL' && !isMediaField) {
                        detailsHtml += `<p><strong class="font-semibold">${field.label}:</strong> ${value}</p>`;
                        hasVisibleFields = true;
                    }
                });
            
            if (!hasVisibleFields) {
                detailsHtml += '<p>Nenhum detalhe adicional.</p>';
            }

            detailsHtml += '</div>';
            return detailsHtml;
        }
        // --- FIM DA ALTERAÇÃO ---

        async function processItemReception(donationId, itemIndex) {
            const donationRef = doc(db, paths.donationDoc(donationId));
            const docSnap = await getDoc(donationRef);

            if (docSnap.exists()) {
                const currentDonation = docSnap.data();
                const updatedItems = [...currentDonation.items];
                const item = updatedItems[itemIndex];
                
                if (item.status === 'completed') return;

                item.status = 'completed';
                item.receivedBy = auth.currentUser.uid;
                item.receivedDate = new Date();
                
                const allItemsCompleted = updatedItems.every(i => i.status === 'completed');
                
                const dataToUpdate = { items: updatedItems };
                if (allItemsCompleted) {
                    dataToUpdate.status = 'completed';
                }
                
                await updateDoc(donationRef, dataToUpdate);

                const donorId = currentDonation.donorId;
                const message = `A sua doação do item "${item.type}" para a campanha "${currentDonation.campaignTitle}" foi recebida! Muito obrigado!`;
                await createNotification(donorId, message, 'minhas-entregas.html');
            }
        }
        
        function handleReceiveClick(e) {
            const button = e.target.closest('.receive-btn');
            if (!button) return;
            
            const { donationId, itemIndex } = button.dataset;
            const donation = allDonations.find(d => d.id === donationId);
            if (!donation) return;
            const item = donation.items[itemIndex];
            if (!item) return;

            const campaign = campaignsData.get(donation.campaignId);
            const detailsHtml = generateItemDetailsHtml(item, campaign?.type);

            const modalContentHtml = `
                <div class="text-center">
                    <img src="${item.photoURL || 'https://placehold.co/400x400/e2e8f0/e2e8f0?text=Sem+Imagem'}" class="w-full h-64 object-contain rounded-md mb-4 bg-gray-100">
                    <h4 class="font-bold text-xl">${item.type}</h4>
                    <p class="text-sm text-gray-500 mb-4">Campanha: ${donation.campaignTitle}</p>
                    <div class="text-left text-sm space-y-1 p-2 bg-gray-50 rounded">${detailsHtml}</div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button id="modal-confirm-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Sim, Recebido</button>
                </div>
            `;
            
            showDetailsModal('Confirmar Recebimento', modalContentHtml);
            
            document.getElementById('modal-confirm-btn').onclick = async () => {
                const modal = document.getElementById('app-modal');
                modal.querySelector('#modal-message-body').innerHTML = '<div class="loader mx-auto"></div><p class="text-center mt-2">A processar...</p>';
                await processItemReception(donationId, parseInt(itemIndex));
                modal.classList.add('hidden');
            };
            document.getElementById('modal-cancel-btn').onclick = () => document.getElementById('app-modal').classList.add('hidden');
        }
        
        itemsList.addEventListener('click', handleReceiveClick);
        prevDayBtn.addEventListener('click', () => { if (currentDateIndex > 0) { currentDateIndex--; renderScheduleForSelectedDate(); } });
        nextDayBtn.addEventListener('click', () => { if (currentDateIndex < availableDates.length - 1) { currentDateIndex++; renderScheduleForSelectedDate(); } });
        
        async function processDecodedText(decodedText) {
            qrReaderContainer.classList.add('hidden');
            qrReaderStatus.textContent = 'QR Code lido! A processar...';

            try {
                const [donationId, itemIndexStr] = decodedText.split('|');
                const itemIndex = parseInt(itemIndexStr, 10);
                if (!donationId || isNaN(itemIndex)) throw new Error("QR Code inválido.");

                const donationRef = doc(db, paths.donationDoc(donationId));
                const donationSnap = await getDoc(donationRef);
                if (!donationSnap.exists()) throw new Error("Agendamento não encontrado.");

                lastScannedDonation = { id: donationSnap.id, ...donationSnap.data() };
                const item = lastScannedDonation.items[itemIndex];
                if (!item) throw new Error("Item não encontrado.");

                const campaign = campaignsData.get(lastScannedDonation.campaignId);
                if (campaign && campaign.expiresAt.toDate() < new Date()) {
                    throw new Error("Não é possível receber este item pois a campanha já foi encerrada.");
                }

                if (item.status === 'completed') {
                    await showAlertModal('Item Já Recebido', `Este item (${item.type}) já foi recebido.`);
                    closeAndResetQrModal();
                    return;
                }
                
                const itemDetailsHtml = generateItemDetailsHtml(item, campaign?.type);
                qrItemDetails.innerHTML = `
                    <img src="${item.photoURL || 'https://placehold.co/64x64/e2e8f0/e2e8f0'}" class="w-16 h-16 rounded-md object-cover flex-shrink-0">
                    <div class="flex-grow text-left">
                        <p class="font-bold">${item.type}</p>
                        ${itemDetailsHtml.replace(/text-xs/g, 'text-sm')}
                    </div>
                `;
                
                qrResultContainer.classList.remove('hidden');
                qrConfirmBtn.onclick = () => confirmQrReception(donationId, itemIndex);

            } catch (error) {
                await showAlertModal('Erro na Leitura', error.message);
                closeAndResetQrModal();
            }
        }

        async function confirmQrReception(donationId, itemIndex) {
            qrConfirmBtn.disabled = true;
            qrConfirmBtn.textContent = 'A processar...';
            try {
                await processItemReception(donationId, parseInt(itemIndex));
                await showAlertModal('Sucesso!', 'Recebimento do item confirmado!');
                closeAndResetQrModal();
            } catch (error) {
                await showAlertModal('Erro ao Confirmar', 'Não foi possível confirmar o recebimento.');
            } finally {
                qrConfirmBtn.disabled = false;
                qrConfirmBtn.textContent = 'Confirmar Recebimento';
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => processDecodedText(decodedText)).catch(err => console.error("Falha ao parar o scanner", err));
            }
        }
        function onScanFailure(error) { /* Ignorar intencionalmente */ }

        function startScanner() {
            if (!html5QrCode) { html5QrCode = new Html5Qrcode("qr-reader"); }
            qrReaderStatus.textContent = 'Aponte a câmera para o QR Code...';
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, onScanFailure)
                .catch(err => {
                    qrReaderStatus.textContent = 'Erro ao aceder à câmera. Conceda a permissão e tente novamente.';
                });
        }

        function closeAndResetQrModal() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => {});
            }
            qrModal.classList.add('hidden');
            qrReaderContainer.classList.remove('hidden');
            qrResultContainer.classList.add('hidden');
            qrConfirmBtn.disabled = false;
            qrConfirmBtn.textContent = 'Confirmar Recebimento';
        }

        scanQrBtn.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
            startScanner();
        });
        
        closeQrModalBtn.addEventListener('click', closeAndResetQrModal);
        
        toggleAgendaBtn.addEventListener('click', () => {
            listView.classList.add('hidden');
            agendaView.classList.remove('hidden');
            toggleAgendaBtn.classList.add('active');
            toggleListBtn.classList.remove('active');
        });

        toggleListBtn.addEventListener('click', () => {
            agendaView.classList.add('hidden');
            listView.classList.remove('hidden');
            toggleListBtn.classList.add('active');
            toggleAgendaBtn.classList.remove('active');
            renderListView();
        });

        function renderListView() {
            listView.innerHTML = '';
            const now = new Date();

            const upcoming = allDonations.filter(d => d.status === 'scheduled' && d.scheduledAt.toDate() >= now && (d.items || []).some(i => i.status !== 'completed'));
            const overdue = allDonations.filter(d => d.status === 'scheduled' && d.scheduledAt.toDate() < now && (d.items || []).some(i => i.status !== 'completed'));
            const history = allDonations.filter(d => d.status === 'completed' || (d.items || []).every(i => i.status === 'completed'));
            
            const sections = [
                { title: 'Itens Próximos', data: upcoming, color: 'blue' },
                { title: 'Itens Vencidos', data: overdue, color: 'red' },
                { title: 'Histórico de Itens Recebidos', data: history, color: 'gray' }
            ];

            sections.forEach(section => {
                let itemsHtml = '';
                section.data.forEach(donation => {
                    (donation.items || []).forEach((item, index) => {
                        if ((section.title.includes('Próximos') || section.title.includes('Vencidos')) && item.status === 'completed') return;
                        if (section.title.includes('Histórico') && item.status !== 'completed') return;

                        const campaign = campaignsData.get(donation.campaignId);
                        const typeConfig = campaignTypeSettings[campaign?.type] || { color: 'gray' };
                        const borderColor = `border-${typeConfig.color}-500`;
                        const isCampaignActive = campaign && campaign.expiresAt.toDate() > new Date();
                        
                        let statusHtml = '';
                        if (item.status === 'completed') {
                            statusHtml = `<p class="text-xs text-green-600 font-semibold">Recebido</p>`;
                        } else if (isCampaignActive) {
                            const isOverdue = donation.scheduledAt.toDate() < now;
                            statusHtml = `<button data-donation-id="${donation.id}" data-item-index="${index}" class="receive-btn bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition">${isOverdue ? 'Receber (Vencido)' : 'Receber'}</button>`;
                        } else {
                            statusHtml = `<p class="text-xs text-gray-500 font-semibold">Campanha Encerrada</p>`;
                        }

                        itemsHtml += `
                            <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between border-l-4 ${borderColor}">
                                <div class="flex items-center space-x-4 flex-grow">
                                    <img src="${item.photoURL || 'https://placehold.co/48x48/e2e8f0/e2e8f0?text=Item'}" alt="${item.type}" class="w-12 h-12 rounded-md object-cover">
                                    <div>
                                        <p class="font-semibold text-gray-800">${item.type}</p>
                                        <p class="text-xs text-gray-500">Doador: ${donation.donorName}</p>
                                        <p class="text-xs text-gray-500">Agendado para: ${donation.scheduledAt.toDate().toLocaleDateString('pt-BR')}</p>
                                    </div>
                                </div>
                                <div class="text-right w-36">${statusHtml}</div>
                            </div>`;
                    });
                });
                
                if (itemsHtml.trim() !== '') {
                    const sectionEl = document.createElement('div');
                    sectionEl.innerHTML = `
                        <h2 class="text-xl font-bold text-gray-800 border-b-2 border-${section.color}-500 pb-2 mb-4">${section.title}</h2>
                        <div class="space-y-3">${itemsHtml}</div>
                    `;
                    listView.appendChild(sectionEl);
                }
            });
            listView.addEventListener('click', handleReceiveClick);
        }
        
        initializeApp();
    </script>
</body>
</html>
