<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Doações Recebidas - App Faz Bem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .schedule-slot {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .schedule-slot:hover {
            border-color: #3b82f6; /* blue-500 */
            transform: translateY(-2px);
        }
        .schedule-slot.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #2563eb; /* blue-600 */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .schedule-slot.active .slot-donors { color: #dbeafe; /* blue-100 */ }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <main class="container mx-auto p-4 sm:p-6">
        <div id="loading-view" class="min-h-[calc(100vh-150px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">A carregar agendamentos...</p>
            </div>
        </div>

        <div id="donations-view" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Agenda de Recebimento</h1>
                    <p class="text-gray-600 mt-1">Selecione um dia e um horário para ver os itens agendados.</p>
                </div>
                 <a href="admin.html" class="text-sm font-medium text-gray-600 hover:text-green-600 self-start sm:self-center">← Voltar ao Painel</a>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-day-btn" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-left fa-lg text-gray-600"></i></button>
                    <h2 id="selected-date-display" class="text-xl font-bold text-center text-gray-700"></h2>
                    <button id="next-day-btn" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-right fa-lg text-gray-600"></i></button>
                </div>
                <div id="schedule-slots-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    </div>
                 <p id="no-slots-message" class="text-center text-gray-500 py-8 hidden">Nenhum agendamento para este dia.</p>
            </div>

            <div id="items-container" class="mt-8">
                <h3 id="items-header" class="text-2xl font-bold text-gray-800 mb-4 hidden">Itens Agendados</h3>
                <div id="items-list" class="space-y-3">
                    </div>
                 <p id="select-slot-prompt" class="text-center text-gray-500 py-10 bg-white rounded-lg shadow-sm">Selecione um horário acima para visualizar os detalhes dos itens a serem recebidos.</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { db, auth, paths } from './app-config.js';
        import { collection, query, where, onSnapshot, getDoc, doc, updateDoc, getDocs } from './firebase-services.js';
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';

        const loadingView = document.getElementById('loading-view');
        const donationsView = document.getElementById('donations-view');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const scheduleSlotsGrid = document.getElementById('schedule-slots-grid');
        const noSlotsMessage = document.getElementById('no-slots-message');
        const itemsContainer = document.getElementById('items-container');
        const itemsHeader = document.getElementById('items-header');
        const itemsList = document.getElementById('items-list');
        const selectSlotPrompt = document.getElementById('select-slot-prompt');
        
        let allDonationsData = [];
        let campaignsData = new Map();
        let campaignTypeSettings = {};
        let donationsUnsubscribe = null;
        let selectedDate = new Date();

        async function initializeApp() {
            await injectHeader();
            const userSession = await getCurrentUser();
            if (userSession?.profile?.role === 'entidade' && auth.currentUser) {
                const typesSnap = await getDoc(doc(db, paths.configDoc('campaignTypes')));
                campaignTypeSettings = typesSnap.exists() ? typesSnap.data() : {};
                await loadAllCampaignsForEntity(auth.currentUser.uid);
                loadAllDonationsForEntity(auth.currentUser.uid);
            } else {
                window.location.href = 'index.html';
            }
        }
        
        async function loadAllCampaignsForEntity(entityId) {
            const q = query(collection(db, paths.campaigns), where("entityId", "==", entityId));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => campaignsData.set(doc.id, { id: doc.id, ...doc.data() }));
        }

        function loadAllDonationsForEntity(entityId) {
            if (donationsUnsubscribe) donationsUnsubscribe();
            const q = query(collection(db, paths.donations), where('entityId', '==', entityId), where('status', '==', 'scheduled'));
            
            donationsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allDonationsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderScheduleForSelectedDate();
                
                if (!loadingView.classList.contains('hidden')) {
                    loadingView.classList.add('hidden');
                    donationsView.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Erro ao carregar doações:", error);
                loadingView.innerHTML = `<p class="text-red-500">Ocorreu um erro ao carregar as doações.</p>`;
            });
        }
        
        function renderScheduleForSelectedDate() {
            selectedDate.setHours(0, 0, 0, 0);
            selectedDateDisplay.textContent = selectedDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
            
            const donationsForDay = allDonationsData.filter(d => {
                const donationDate = d.scheduledAt.toDate();
                donationDate.setHours(0, 0, 0, 0);
                return donationDate.getTime() === selectedDate.getTime();
            });

            scheduleSlotsGrid.innerHTML = '';
            itemsList.innerHTML = '';
            selectSlotPrompt.style.display = 'block';
            itemsHeader.classList.add('hidden');
            
            if (donationsForDay.length === 0) {
                noSlotsMessage.style.display = 'block';
                return;
            }
            noSlotsMessage.style.display = 'none';

            const slots = donationsForDay.reduce((acc, donation) => {
                const time = donation.scheduledAt.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                if (!acc[time]) {
                    acc[time] = { donors: new Set(), items: 0, donations: [] };
                }
                acc[time].donors.add(donation.donorId);
                acc[time].items += donation.items.length;
                acc[time].donations.push(donation);
                return acc;
            }, {});

            const sortedTimes = Object.keys(slots).sort();

            sortedTimes.forEach(time => {
                const slotData = slots[time];
                const slotEl = document.createElement('button');
                slotEl.className = 'schedule-slot p-3 rounded-lg text-left';
                slotEl.innerHTML = `
                    <p class="font-bold text-lg">${time}</p>
                    <p class="slot-donors text-sm text-gray-500">${slotData.donors.size} doador(es)</p>
                    <p class="text-sm font-semibold">${slotData.items} item(ns)</p>
                `;
                slotEl.addEventListener('click', () => {
                    document.querySelectorAll('.schedule-slot.active').forEach(el => el.classList.remove('active'));
                    slotEl.classList.add('active');
                    renderItemsForSlot(slotData.donations, time);
                });
                scheduleSlotsGrid.appendChild(slotEl);
            });
        }

        async function renderItemsForSlot(donations, time) {
            selectSlotPrompt.style.display = 'none';
            itemsHeader.classList.remove('hidden');
            itemsHeader.textContent = `Itens agendados para as ${time}`;
            itemsList.innerHTML = '<div class="loader mx-auto"></div>';

            let allItemsHtml = '';
            for (const donation of donations) {
                const donorName = donation.donorName || "Doador Anônimo";
                
                const itemsHtml = await Promise.all(donation.items.map(async (item, index) => {
                    const campaign = campaignsData.get(donation.campaignId);
                    const typeConfig = campaignTypeSettings[campaign?.type] || { color: 'gray' };
                    // TailwindCSS JIT compiler friendly colors
                    const colorMap = { green: 'border-green-500', blue: 'border-blue-500', yellow: 'border-yellow-500', red: 'border-red-500', purple: 'border-purple-500', gray: 'border-gray-500' };
                    const borderColor = colorMap[typeConfig.color] || 'border-gray-500';

                    const isReceived = item.status === 'completed';
                    const canReceive = !isReceived && (campaign?.expiresAt.toDate() > new Date());
                    
                    let statusHtml;
                    if (isReceived) {
                        statusHtml = `<p class="text-xs text-green-600 font-semibold">Recebido</p>`;
                    } else if (canReceive) {
                        statusHtml = `<button data-donation-id="${donation.id}" data-item-index="${index}" class="receive-btn bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700 transition">Receber</button>`;
                    } else {
                        statusHtml = `<p class="text-xs text-gray-500 font-semibold">Campanha Encerrada</p>`;
                    }

                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between border-l-4 ${borderColor}">
                            <div class="flex items-center space-x-4">
                                <img src="${item.photoURL || 'https://placehold.co/48x48/e2e8f0/e2e8f0?text=Item'}" alt="${item.type}" class="w-12 h-12 rounded-md object-cover">
                                <div>
                                    <p class="font-semibold text-gray-800">${item.type}</p>
                                    <p class="text-sm text-gray-500">${campaign?.title || 'Campanha Desconhecida'}</p>
                                </div>
                            </div>
                            <div class="text-right w-28">${statusHtml}</div>
                        </div>
                    `;
                }));

                allItemsHtml += `
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-gray-800">${donorName}</h4>
                        <div class="pl-4 mt-2 space-y-2">
                            ${itemsHtml.join('')}
                        </div>
                    </div>
                `;
            }
            itemsList.innerHTML = allItemsHtml;
        }

        itemsList.addEventListener('click', async (e) => {
            const button = e.target.closest('.receive-btn');
            if (!button) return;
            
            const { donationId, itemIndex } = button.dataset;
            button.disabled = true;
            button.innerHTML = '<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>';

            const donationRef = doc(db, paths.donationDoc(donationId));
            try {
                const docSnap = await getDoc(donationRef);
                if (docSnap.exists()) {
                    const currentDonation = docSnap.data();
                    const updatedItems = [...currentDonation.items];
                    updatedItems[itemIndex].status = 'completed';
                    updatedItems[itemIndex].receivedBy = auth.currentUser.uid;
                    updatedItems[itemIndex].receivedDate = new Date();
                    await updateDoc(donationRef, { items: updatedItems });
                }
            } catch (error) {
                console.error("Erro ao confirmar recebimento: ", error);
                button.disabled = false;
                button.textContent = 'Receber';
            }
        });
        
        prevDayBtn.addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() - 1);
            renderScheduleForSelectedDate();
        });

        nextDayBtn.addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() + 1);
            renderScheduleForSelectedDate();
        });

        initializeApp();
    </script>
</body>
</html>
