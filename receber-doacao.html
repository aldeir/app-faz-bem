<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receber Doações - Faz Bem</title>
    
    <!-- PWA Tags -->
    <meta name="theme-color" content="#22c55e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <main id="page-content">
        <div id="loading-view" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">A carregar agendamentos...</p>
            </div>
        </div>

        <div id="receive-view" class="hidden container mx-auto max-w-4xl p-4 sm:p-6 my-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <h1 id="page-heading" class="text-3xl font-bold text-gray-800">Receber Doações</h1>
                    <p class="text-sm text-gray-500 mt-1">Confirme o recebimento dos itens agendados.</p>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="scan-qr-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 0h-4v4m0 12v-4h4m-12 0H4v-4"></path></svg>
                        Receber via QR Code
                    </button>
                    <a id="back-link" href="admin.html" class="text-sm font-medium text-gray-600 hover:text-green-600">← Voltar ao Painel</a>
                </div>
            </div>
            
            <div id="donations-container" class="space-y-8">
                <p id="no-donations-placeholder" class="hidden text-center text-gray-500 py-10 bg-white rounded-lg shadow">Nenhuma doação agendada encontrada.</p>
            </div>
        </div>
    </main>
    
    <div id="app-modal"></div>
    <!-- Outros modals (QR, Confirmação, etc.) serão adicionados aqui pelo JS se necessário -->


    <script type="module">
        import { db, paths } from './app-config.js';
        import { collection, query, where, onSnapshot, doc, getDoc, runTransaction } from "./firebase-services.js";
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';
        import { showAlertModal, showConfirmationModal } from './modal-handler.js';

        const loadingView = document.getElementById('loading-view');
        const receiveView = document.getElementById('receive-view');
        const donationsContainer = document.getElementById('donations-container');
        const noDonationsPlaceholder = document.getElementById('no-donations-placeholder');
        const pageHeading = document.getElementById('page-heading');
        const backLink = document.getElementById('back-link');

        let currentUserSession = null;

        async function initializeApp() {
            const canProceed = await injectHeader();
            if (!canProceed) {
                loadingView.classList.add('hidden');
                return;
            }
            
            currentUserSession = await getCurrentUser();
            if (currentUserSession && ['superadmin', 'entidade'].includes(currentUserSession.profile?.role)) {
                setupUIForRole(currentUserSession.profile.role);
                loadScheduledDonations(currentUserSession);
            } else {
                window.location.href = 'login.html';
            }
        }

        function setupUIForRole(role) {
            if (role === 'superadmin') {
                pageHeading.textContent = 'Receber Doações (App Faz Bem)';
                backLink.href = 'superadmin.html';
            }
        }

        function loadScheduledDonations(userSession) {
            let q;
            if (userSession.profile.role === 'superadmin') {
                // Superadmin vê apenas as doações destinadas ao "App Faz Bem"
                q = query(collection(db, paths.donations), where("entityId", "==", "app_faz_bem"), where("status", "==", "scheduled"));
            } else {
                // Entidade vê apenas as suas doações
                q = query(collection(db, paths.donations), where("entityId", "==", userSession.auth.uid), where("status", "==", "scheduled"));
            }

            onSnapshot(q, (snapshot) => {
                const donations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDonations(donations);
                loadingView.classList.add('hidden');
                receiveView.classList.remove('hidden');
            });
        }

        function renderDonations(donations) {
            donationsContainer.innerHTML = '';
            if (donations.length === 0) {
                donationsContainer.appendChild(noDonationsPlaceholder);
                noDonationsPlaceholder.classList.remove('hidden');
                return;
            }
            noDonationsPlaceholder.classList.add('hidden');

            const groupedByCampaign = donations.reduce((acc, d) => {
                if (!acc[d.campaignId]) {
                    acc[d.campaignId] = { title: d.campaignTitle, donations: [] };
                }
                acc[d.campaignId].donations.push(d);
                return acc;
            }, {});

            Object.entries(groupedByCampaign).forEach(([campaignId, campaignGroup]) => {
                const campaignSection = document.createElement('div');
                campaignSection.className = 'bg-white rounded-xl shadow-lg p-6';
                
                const groupedByDonor = campaignGroup.donations.reduce((acc, d) => {
                    if (!acc[d.donorId]) {
                        acc[d.donorId] = { donorName: d.donorName, donorPhoto: d.donorPhoto, items: [] };
                    }
                    acc[d.donorId].items.push(...d.items.map((item, index) => ({...item, donationId: d.id, itemIndex: index})));
                    return acc;
                }, {});

                const donorsHtml = Object.entries(groupedByDonor).map(([donorId, donorData]) => `
                    <div class="mt-4 border-t pt-4">
                        <div class="flex items-center space-x-3">
                            <img src="${donorData.donorPhoto || 'https://placehold.co/40x40/e2e8f0/cbd5e0?text=Foto'}" class="w-10 h-10 rounded-full object-cover">
                            <h4 class="font-semibold text-gray-800">${donorData.donorName}</h4>
                        </div>
                        <div class="pl-4 mt-2 space-y-2">
                            ${donorData.items.map(createItemRow).join('')}
                        </div>
                    </div>
                `).join('');

                campaignSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800">${campaignGroup.title}</h2>
                    <div class="mt-4">${donorsHtml}</div>
                `;
                donationsContainer.appendChild(campaignSection);
            });
        }

        function createItemRow(item) {
            const isReceived = item.status === 'received';
            return `
                <div class="flex items-center justify-between p-2 rounded-md ${isReceived ? 'bg-green-50' : 'hover:bg-gray-50'}">
                    <div class="flex items-center space-x-3">
                        <img src="${item.photoURL}" class="w-12 h-12 rounded-md object-cover">
                        <div>
                            <p class="font-medium">${item.type}</p>
                            <p class="text-sm text-gray-500">${item.details} (${item.condition})</p>
                        </div>
                    </div>
                    ${!isReceived ? `
                    <button data-donation-id="${item.donationId}" data-item-index="${item.itemIndex}" class="manual-receive-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-semibold py-1 px-3 rounded-md">
                        Receber
                    </button>` : `<span class="font-bold text-sm text-green-600">✓ Recebido</span>`}
                </div>
            `;
        }

        // A lógica de QR Code e updateItemStatus permanece a mesma, mas agora é chamada a partir dos botões na lista.
        
        initializeApp();
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
