<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerenciar Agendamentos</title>

  <meta name="theme-color" content="#22c55e">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="icon" href="logo.png" type="image/png">

  <!-- CSS do projeto (GitHub Pages) -->
  <link href="/app-faz-bem/style.css" rel="stylesheet">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .avatar-fallback {
      background: #e2e8f0; color: #1f2937;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 600; text-transform: uppercase; border-radius: 9999px;
      width: 40px; height: 40px;
    }
    .chip { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
    .chip-gray { background:#f3f4f6; color:#374151; }
    .chip-green { background:#ecfdf5; color:#065f46; }
    .chip-yellow { background:#fffbeb; color:#92400e; }
    .chip-red { background:#fef2f2; color:#991b1b; }

    /* Modal base */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-backdrop.active { display: flex; }
    .modal-content { width: min(960px, 96vw); max-height: 92vh; background: #fff; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; font-weight: 600; }
    .modal-body { padding: 16px; overflow: auto; }
    .modal-footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; justify-content: flex-end; }
    .btn { border-radius: 8px; padding: 8px 12px; font-size: 14px; }
    .btn-gray { background: #f3f4f6; color:#374151; }
    .btn-red { background: #ef4444; color: #fff; }
    .btn-green { background: #10b981; color: #fff; }
    .btn-blue { background: #2563eb; color: #fff; }
    .btn:hover { filter: brightness(0.96); }

    .keyval { display:flex; gap:8px; align-items:center; font-size:12px; color:#4b5563; }
    .keyval .k { font-weight:600; color:#111827; }

    .code-badge { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#111827; color:#c7d2fe; padding:2px 6px; border-radius:6px; font-size:11px; }

    /* Painel lateral de ocupação */
    .grid-two { display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
    @media (max-width: 900px) { .grid-two { grid-template-columns: 1fr; } }
    .slot { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; }
    .slot.busy { background:#fff7ed; }
    .slot.free { background:#ecfeff; }
    .slot .count { font-weight:700; }

    .list-mini { border:1px solid #e5e7eb; border-radius:8px; padding:8px; background:#fafafa; max-height:240px; overflow:auto; }
    .list-mini li { padding:6px 4px; border-bottom:1px dashed #e5e7eb; }
    .list-mini li:last-child { border-bottom:none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header id="app-header"></header>

  <main class="max-w-7xl mx-auto p-4">
    <div class="mb-4 flex items-center justify-between">
      <a id="backLink" href="admin.html" class="text-sm text-blue-600 hover:underline">&larr; Voltar</a>
      <div class="text-sm text-gray-600 hidden" id="active-entity-filter"></div>
    </div>

    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Gerenciar Agendamentos</h1>
      <a href="receber-doacao.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm shadow-sm">Receber via QR Code</a>
    </div>

    <!-- Filtros -->
    <section class="bg-white rounded-lg shadow-sm p-4 mb-4">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-end">
        <div class="flex-1">
          <label class="block text-xs text-gray-600 mb-1">Busca</label>
          <input id="search-input" type="search" placeholder="Doação, campanha, entidade, doador(a), item..."
                 class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">Status</label>
          <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-green-500 focus:border-green-500">
            <option value="all">Todos</option>
            <option value="pending">Pendentes</option>
            <option value="overdue">Vencidas</option>
            <option value="delivered">Entregues</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">Data inicial</label>
          <input id="date-start" type="date" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">Data final</label>
          <input id="date-end" type="date" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <button id="apply-filters" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Aplicar</button>
        </div>
      </div>
    </section>

    <!-- Cards resumo -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <div class="text-xs text-gray-500">Pendentes</div>
        <div id="metric-pending" class="mt-1 text-2xl font-semibold text-gray-900">0</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <div class="text-xs text-gray-500">Vencidas</div>
        <div id="metric-overdue" class="mt-1 text-2xl font-semibold text-red-600">0</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <div class="text-xs text-gray-500">Entregues (30d)</div>
        <div id="metric-delivered" class="mt-1 text-2xl font-semibold text-green-600">0</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <div class="text-xs text-gray-500">Total</div>
        <div id="metric-total" class="mt-1 text-2xl font-semibold text-blue-600">0</div>
      </div>
    </section>

    <!-- Abas -->
    <nav class="mb-3 border-b border-gray-200">
      <ul class="-mb-px flex space-x-6 text-sm" id="tabs">
        <li><button data-tab="pending" class="tab-btn py-3 border-b-2 border-green-600 text-green-700">Pendentes</button></li>
        <li><button data-tab="overdue" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">Vencidas</button></li>
        <li><button data-tab="delivered" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">Entregues</button></li>
        <li><button data-tab="all" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">Todas</button></li>
      </ul>
    </nav>

    <div id="loading-view" class="bg-white rounded-lg p-6 shadow-sm">Carregando agendamentos...</div>
    <section id="list-view" class="hidden space-y-6"></section>
    <div id="no-data" class="hidden bg-white rounded-lg p-6 shadow-sm text-gray-600">Nenhum registro encontrado.</div>

    <div class="flex justify-center mt-4">
      <button id="load-more" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md">Mostrar mais</button>
    </div>
  </main>

  <!-- Modal: Reagendar / Cancelar disponibilidade -->
  <div id="reschedule-modal" class="modal-backdrop" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">Reagendar / Disponibilidade</div>
      <div class="modal-body grid-two">
        <div>
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Data</label>
              <input id="rs-date" type="date" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Hora</label>
              <input id="rs-time" type="time" class="w-full border border-gray-300 rounded-md px-3 py-2" step="900">
            </div>
          </div>

          <div class="mt-4">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="rs-block-slot" type="checkbox" class="rounded border-gray-300">
              Cancelar disponibilidade deste horário
            </label>
            <p class="text-xs text-gray-500 mt-1">Se marcado, o horário ficará indisponível para novos agendamentos.</p>
          </div>

          <div id="rs-just-wrap" class="hidden mt-3">
            <label class="block text-xs text-gray-600 mb-1">Justificativa</label>
            <textarea id="rs-just" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Explique o motivo da indisponibilidade..."></textarea>
          </div>

          <div id="rs-collision-wrap" class="hidden mt-4">
            <div class="font-semibold text-gray-800 mb-1">Agendamentos neste horário</div>
            <ul id="rs-collision-list" class="list-mini"></ul>
            <p class="text-xs text-gray-500 mt-1">Ao confirmar “Cancelar disponibilidade”, todos os agendamentos acima serão cancelados e os doadores notificados.</p>
          </div>
        </div>

        <div>
          <div class="font-semibold text-gray-800 mb-2">Ocupação do dia</div>
          <div id="rs-occupancy" class="space-y-2">
            <!-- slots renderizados aqui -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="rs-cancel" class="btn btn-gray">Fechar</button>
        <button id="rs-confirm-block" class="btn btn-red hidden">Cancelar disponibilidade</button>
        <button id="rs-confirm" class="btn btn-blue">Reagendar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cancelar doação -->
  <div id="cancel-modal" class="modal-backdrop" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">Cancelar doação</div>
      <div class="modal-body">
        <p class="text-sm text-gray-700">Informe a justificativa para cancelar esta doação. O doador será notificado.</p>
        <div class="mt-3">
          <label class="block text-xs text-gray-600 mb-1">Justificativa</label>
          <textarea id="cn-just" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Ex.: Dados inconsistentes, tentativa de fraude, etc."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cn-cancel" class="btn btn-gray">Fechar</button>
        <button id="cn-confirm" class="btn btn-red">Cancelar doação</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './app-config.js';
    import {
      collection, query, where, onSnapshot, doc, getDoc, updateDoc,
      writeBatch, serverTimestamp, runTransaction
    } from './firebase-services.js';
    import { paths } from './firestore-paths.js';
    import { injectHeader } from './app-header.js';
    import { getCurrentUser } from './auth-service.js';
    import { createNotification } from './notification-service.js';
    import { showAlertModal } from './modal-handler.js';

    const backLink = document.getElementById('backLink');
    const loadingView = document.getElementById('loading-view');
    const listView = document.getElementById('list-view');
    const noView = document.getElementById('no-data');
    const activeEntityFilterEl = document.getElementById('active-entity-filter');

    const metricPending = document.getElementById('metric-pending');
    const metricOverdue = document.getElementById('metric-overdue');
    const metricDelivered = document.getElementById('metric-delivered');
    const metricTotal = document.getElementById('metric-total');

    const tabs = document.getElementById('tabs');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const dateStart = document.getElementById('date-start');
    const dateEnd = document.getElementById('date-end');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const loadMoreBtn = document.getElementById('load-more');

    // Reschedule elements
    const rsModal = document.getElementById('reschedule-modal');
    const rsDate = document.getElementById('rs-date');
    const rsTime = document.getElementById('rs-time');
    const rsBlockSlot = document.getElementById('rs-block-slot');
    const rsJustWrap = document.getElementById('rs-just-wrap');
    const rsJust = document.getElementById('rs-just');
    const rsOccupancy = document.getElementById('rs-occupancy');
    const rsCollisionWrap = document.getElementById('rs-collision-wrap');
    const rsCollisionList = document.getElementById('rs-collision-list');
    const rsBtnClose = document.getElementById('rs-cancel');
    const rsBtnConfirm = document.getElementById('rs-confirm');
    const rsBtnConfirmBlock = document.getElementById('rs-confirm-block');

    // Cancel modal
    const cnModal = document.getElementById('cancel-modal');
    const cnJust = document.getElementById('cn-just');
    const cnBtnClose = document.getElementById('cn-cancel');
    const cnBtnConfirm = document.getElementById('cn-confirm');

    let campaignTypeSettings = {};
    let unsub = null;
    let rawDonations = [];
    let currentTab = 'pending';
    let renderLimitPerDay = 50;
    const dayRenderCount = new Map();

    let session = null;
    let currentEntityId = null;

    // Contexto da ação
    let actionDonationId = null;

    // Helpers base
    function qs(){ return new URLSearchParams(location.search); }
    function asDate(v){ try { return v?.toDate ? v.toDate() : (v ? new Date(v) : null); } catch { return null; } }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : ''; }
    function two(n){ return String(n).padStart(2,'0'); }
    function fmtDateKey(d){ return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`; }
    function sameDay(a,b){ const A=asDate(a), B=asDate(b); return A && B && fmtDateKey(A)===fmtDateKey(B); }
    function hhmm(d){ const x=asDate(d); return `${two(x.getHours())}:${two(x.getMinutes())}`; }

    function formatDateLongBR(date){
      const d = asDate(date); if (!d || isNaN(d)) return '';
      const weekday = cap(new Intl.DateTimeFormat('pt-BR', { weekday:'long' }).format(d));
      const day = new Intl.DateTimeFormat('pt-BR', { day:'2-digit' }).format(d);
      const month = cap(new Intl.DateTimeFormat('pt-BR', { month:'long' }).format(d));
      const year = new Intl.DateTimeFormat('pt-BR', { year:'numeric' }).format(d);
      return `${weekday}, ${day} de ${month} de ${year}`;
    }
    function formatTimeBR(date){
      const d = asDate(date); if (!d || isNaN(d)) return '--:--';
      return new Intl.DateTimeFormat('pt-BR', { hour:'2-digit', minute:'2-digit' }).format(d);
    }
    function escapeHtml(s){
      return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('`','&#096;'); }

    function getEffectiveEntityIds(userSession){
      const queryParams = qs();
      const forced = queryParams.get('entityId') || queryParams.get('entidadeId');
      const ids = [];
      if (forced) ids.push(forced);
      if (userSession?.profile?.entityId) ids.push(userSession.profile.entityId);
      if (userSession?.profile?.id) ids.push(userSession.profile.id);
      if (userSession?.auth?.uid && userSession?.profile?.role === 'entidade') ids.push(userSession.auth.uid);
      return [...new Set(ids)].filter(Boolean);
    }

    const BORDER_COLOR_MAP = {
      green:'border-green-500', blue:'border-blue-500', yellow:'border-yellow-500',
      red:'border-red-500', purple:'border-purple-500', gray:'border-gray-500', default:'border-blue-500'
    };
    function getBorderClass(cfg){ return BORDER_COLOR_MAP[cfg?.color] || BORDER_COLOR_MAP.default; }

    // Campos dinâmicos (detalhes de item)
    function normalizeFieldsConfig(campaignType){
      const cfg = campaignTypeSettings?.[campaignType];
      const fieldsRaw = Array.isArray(cfg?.fields) ? cfg.fields : Object.values(cfg?.fields || {});
      return fieldsRaw.map(f => ({
        id: f.id || f.key || f.name,
        label: f.label || f.title || f.name || f.id || f.key,
        type: (f.type || '').toLowerCase(),
        options: f.options || f.choices || f.values || []
      })).filter(f => f.id && !['type','photoURL','status'].includes(f.id));
    }
    function isLikelyMediaUrl(v){
      if (typeof v !== 'string') return false;
      const s = v.trim().toLowerCase();
      if (!s.startsWith('http')) return false;
      if (s.includes('firebasestorage')) return true;
      return /\.(jpg|jpeg|png|gif|webp|heic|heif|bmp|svg)(\?|$)/i.test(s);
    }
    function isMediaField(field, rawValue){
      const id = (field?.id || '').toLowerCase();
      const label = (field?.label || '').toLowerCase();
      const type = (field?.type || '').toLowerCase();
      const mediaTypes = ['image','camera','video','file','upload','photo','media','picture'];
      const mediaKeywords = ['foto','photo','imagem','image','picture','camera'];
      if (mediaTypes.includes(type)) return true;
      if (mediaKeywords.some(k => id.includes(k) || label.includes(k))) return true;
      if (isLikelyMediaUrl(rawValue)) return true;
      return false;
    }
    function resolveFieldValue(field, raw){
      if (raw === null || raw === undefined || raw === '') return null;
      if (Array.isArray(raw)) return raw.map(v => resolveFieldValue(field, v)).filter(Boolean).join(', ');
      if (typeof raw === 'boolean') return raw ? 'Sim' : 'Não';
      if (['select','radio','dropdown'].includes(field.type)) {
        const opts = field.options || [];
        const m = opts.find(o => String(o.value ?? o.id ?? o.key ?? o.code ?? o.label) === String(raw));
        return m ? (m.label ?? m.name ?? String(raw)) : String(raw);
      }
      if (['date','datetime'].includes(field.type)) {
        const d = asDate(raw);
        return d && !isNaN(d) ? d.toLocaleString('pt-BR') : String(raw);
      }
      if (typeof raw === 'string' && isLikelyMediaUrl(raw)) return null;
      return String(raw);
    }
    function smartLabel(key){
      if (!key) return '';
      const map = { qty:'Quantidade', quantidade:'Quantidade' };
      if (map[key]) return map[key];
      const s = String(key).replace(/[_\-]+/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2');
      return s.charAt(0).toUpperCase()+s.slice(1);
    }
    function fallbackDetailsFromItem(item){
      const ignore = new Set(['type','photoURL','status','id','campaignType','uniqueCode']);
      const lines = [];
      for (const [k,v] of Object.entries(item||{})){
        if (ignore.has(k)) continue;
        if (v === null || v === undefined || v === '') continue;
        if (Array.isArray(v) && v.length===0) continue;
        if (typeof v === 'string' && isLikelyMediaUrl(v)) continue;
        const val = Array.isArray(v) ? v.join(', ') : (typeof v==='boolean'? (v?'Sim':'Não') : String(v));
        lines.push(`<p><strong class="font-semibold">${smartLabel(k)}:</strong> ${escapeHtml(val)}</p>`);
      }
      return `<div class="space-y-1">${lines.length ? lines.join('') : '<p class="text-gray-500">Nenhum detalhe adicional.</p>'}</div>`;
    }
    function extractItemPhotoUrl(item, donationCampaignType){
      if (item?.photoURL && isLikelyMediaUrl(item.photoURL)) return item.photoURL;
      const fields = normalizeFieldsConfig(donationCampaignType);
      for (const f of fields) {
        const v = item?.[f.id];
        if (!v) continue;
        if (Array.isArray(v)) {
          const found = v.find(isLikelyMediaUrl);
          if (found) return found;
        } else if (isMediaField(f, v) && isLikelyMediaUrl(v)) {
          return v;
        }
      }
      return null;
    }
    function generateItemDetailsHtml(item, donationCampaignType){
      const fields = normalizeFieldsConfig(donationCampaignType);
      const codeFrag = item?.uniqueCode ? `<span class="code-badge" title="Código do item">${escapeHtml(item.uniqueCode)}</span>` : '';
      if (!fields.length) return `${codeFrag ? `<div class="mb-1">${codeFrag}</div>` : ''}${fallbackDetailsFromItem(item)}`;
      const filtered = fields.filter(f => !isMediaField(f, item?.[f.id]));
      const lines = filtered.map(f => {
        const v = resolveFieldValue(f, item?.[f.id]);
        if (v === null || v === '') return '';
        return `<p><strong class="font-semibold">${escapeHtml(f.label)}:</strong> ${escapeHtml(v)}</p>`;
      }).filter(Boolean);
      const inner = lines.length ? lines.join('') : fallbackDetailsFromItem(item);
      return `${codeFrag ? `<div class="mb-1">${codeFrag}</div>` : ''}<div class="space-y-1">${inner}</div>`;
    }

    // Status/recebimento
    function isDonationDelivered(d){
      const s = (d.status||'').toLowerCase();
      const done = ['completed','entregue','received'].includes(s);
      const itemsDone = Array.isArray(d.items) && d.items.length>0 && d.items.every(it => (it.status||'').toLowerCase()==='completed');
      return done || itemsDone || Boolean(d.receivedAt || d.entregueEm);
    }
    function getReceiverName(d){
      return d.receivedByName || d.receiverName || d.entreguePara || '';
    }
    function getReceivedAt(d){
      return d.receivedAt || d.entregueEm || d.updatedAt || null;
    }

    // Render básicos
    function renderAvatar(name, photoURL){
      if (photoURL) return `<img src="${escapeAttr(photoURL)}" alt="${escapeAttr(name)}" class="w-10 h-10 rounded-full object-cover border" loading="lazy">`;
      const initial = (name || '?').trim().charAt(0).toUpperCase() || '?';
      return `<div class="avatar-fallback">${escapeHtml(initial)}</div>`;
    }
    function statusChip(d){
      if (isDonationDelivered(d)) return '<span class="chip chip-green">Entregue</span>';
      const when = asDate(d.scheduledAt);
      if (when && when < new Date()) return '<span class="chip chip-red">Vencida</span>';
      return '<span class="chip chip-yellow">Pendente</span>';
    }

    function renderHeader(d){
      const campaignTitle = d.campaignTitle || d.campaign?.title || '';
      const entityTitle = d.entityName || d.entityTitle || '';
      const typeKey = d.campaignType ? ` (${escapeHtml(d.campaignType)})` : '';
      const subtitle = entityTitle ? ` para ${escapeHtml(entityTitle)}` : '';
      return `
        <div class="flex items-center justify-between">
          <div class="text-gray-800">
            <span class="font-semibold">${escapeHtml(campaignTitle)}</span>${subtitle}
            <span class="text-gray-500">${escapeHtml(typeKey)}</span>
          </div>
          ${statusChip(d)}
        </div>
      `;
    }

    function itemDisplayTitle(item, typeCfg){
      return item?.title || item?.name || item?.type || typeCfg?.title || 'Item';
    }

    // Card / Item
    function renderItem(donation, item, donationIndex, itemIndex){
      const campaignTypeKey = donation.campaignType || 'default';
      const typeCfg = campaignTypeSettings?.[campaignTypeKey] || {};
      const borderClass = getBorderClass(typeCfg);
      const title = itemDisplayTitle(item, typeCfg);
      const detailsHtml = generateItemDetailsHtml(item, campaignTypeKey);
      const photoUrl = extractItemPhotoUrl(item, campaignTypeKey);

      const thumb = photoUrl
        ? `<button type="button" class="item-photo-btn" data-d-idx="${donationIndex}" data-i-idx="${itemIndex}" title="Ver detalhes">
             <img src="${escapeAttr(photoUrl)}" alt="Foto do item" class="w-10 h-10 rounded object-cover border" loading="lazy">
           </button>`
        : `<button type="button" class="item-photo-btn" data-d-idx="${donationIndex}" data-i-idx="${itemIndex}" title="Ver detalhes">
             <div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-gray-400">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h4l2-3h6l2 3h4v13H3V7z"/></svg>
             </div>
           </button>`;

      return `
        <div class="bg-white p-3 rounded-lg shadow-sm flex items-start gap-3 border-l-4 ${borderClass}">
          ${thumb}
          <div class="flex-1">
            <div class="font-medium text-gray-900">${escapeHtml(title)}</div>
            <div class="mt-1 text-sm text-gray-700">${detailsHtml}</div>
          </div>
          <div class="text-xs text-gray-500 self-center">
            ${(item.status||'').toLowerCase()==='completed' ? 'Recebido' : 'Pendente'}
          </div>
        </div>
      `;
    }

    function renderCard(donation, donationIndex){
      const donorName = donation.donorName || donation.donor?.name || 'Doador Anônimo';
      const donorPhoto = donation.donor?.photoURL || donation.donorPhoto || '';
      const when = asDate(donation.scheduledAt);
      const timeStr = formatTimeBR(when);
      const receiver = getReceiverName(donation);
      const rAt = getReceivedAt(donation);
      const rAtStr = rAt ? `${formatDateLongBR(rAt)} às ${formatTimeBR(rAt)}` : '';

      const actions = `
        <div class="flex gap-2">
          <button class="chip chip-green" data-action="mark-received" data-id="${escapeAttr(donation.id||'')}">Marcar recebida</button>
          <button class="chip chip-gray" data-action="reschedule" data-id="${escapeAttr(donation.id||'')}">Reagendar</button>
          <button class="chip chip-red" data-action="cancel" data-id="${escapeAttr(donation.id||'')}">Cancelar</button>
        </div>
      `;

      const items = Array.isArray(donation.items) ? donation.items : [];
      const itemsHtml = items.map((it, idx) => renderItem(donation, it, donationIndex, idx)).join('');

      return `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-4 py-3 border-b">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                ${renderAvatar(donorName, donorPhoto)}
                <div>
                  <div class="font-semibold text-gray-900">${escapeHtml(donorName)}</div>
                  <div class="text-sm text-emerald-600">Agendado: ${escapeHtml(timeStr)}</div>
                  ${receiver ? `<div class="text-xs text-gray-500">Recebido por: ${escapeHtml(receiver)}${rAt ? ` — ${escapeHtml(rAtStr)}` : ''}</div>` : ``}
                </div>
              </div>
              ${actions}
            </div>
          </div>
          <div class="p-4">
            ${renderHeader(donation)}
            <div class="mt-3 space-y-3">
              ${itemsHtml || '<p class="text-gray-500">Nenhum item cadastrado.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // Buckets e métricas
    function computeBuckets(list){
      const now = new Date();
      const last30 = addDays(now, -30);
      const buckets = { pending:[], overdue:[], delivered:[], all:[] };
      for (const d of list){
        buckets.all.push(d);
        if (isDonationDelivered(d)) { if (asDate(getReceivedAt(d)) >= last30) buckets.delivered.push(d); continue; }
        const when = asDate(d.scheduledAt);
        if (when && when < now) buckets.overdue.push(d);
        else buckets.pending.push(d);
      }
      return buckets;
    }
    function groupByDate(list, tab){
      const map = new Map();
      for (const d of list){
        const dateFor = tab==='delivered' && getReceivedAt(d) ? getReceivedAt(d) : d.scheduledAt;
        const when = asDate(dateFor);
        if (!when || isNaN(when)) continue;
        const key = when.toISOString().slice(0,10);
        const arr = map.get(key) || [];
        arr.push(d);
        map.set(key, arr);
      }
      return [...map.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
    }

    // Filtros
    function applyFilters(list){
      const q = (searchInput.value||'').trim().toLowerCase();
      const sFilter = statusFilter.value;
      const ds = dateStart.value ? new Date(dateStart.value+'T00:00:00') : null;
      const de = dateEnd.value ? new Date(dateEnd.value+'T23:59:59') : null;

      let filtered = list.slice();

      if (sFilter && sFilter!=='all'){
        const b = computeBuckets(filtered);
        filtered = b[sFilter] || [];
      }

      if (ds || de){
        filtered = filtered.filter(d => {
          const baseDate = (currentTab==='delivered' && getReceivedAt(d)) ? getReceivedAt(d) : d.scheduledAt;
          const when = asDate(baseDate);
          if (!when || isNaN(when)) return false;
          if (ds && when < ds) return false;
          if (de && when > de) return false;
          return true;
        });
      }

      if (q){
        filtered = filtered.filter(d => {
          const donor = (d.donorName||'').toLowerCase();
          const campaign = (d.campaignTitle||'').toLowerCase();
          const entity = (d.entityName||d.entityTitle||'').toLowerCase();
          const items = Array.isArray(d.items) ? d.items : [];
          const itemText = items.map(it => [
            it.title, it.name, it.type,
            ...Object.values(it).filter(v => typeof v==='string' && !isLikelyMediaUrl(v))
          ].filter(Boolean).join(' ')).join(' ').toLowerCase();
          return donor.includes(q) || campaign.includes(q) || entity.includes(q) || itemText.includes(q);
        });
      }
      return filtered;
    }

    function renderList(){
      const bucketsAll = computeBuckets(rawDonations);
      metricPending.textContent = bucketsAll.pending.length;
      metricOverdue.textContent = bucketsAll.overdue.length;
      metricDelivered.textContent = bucketsAll.delivered.length;
      metricTotal.textContent = rawDonations.length;

      const base = currentTab==='all' ? rawDonations : (bucketsAll[currentTab] || []);
      const list = applyFilters(base);
      if (!list.length){
        loadingView.classList.add('hidden');
        listView.classList.add('hidden');
        noView.classList.remove('hidden');
        loadMoreBtn.classList.add('hidden');
        return;
      }

      const grouped = groupByDate(list, currentTab);
      dayRenderCount.clear();

      const html = grouped.map(([key, arr]) => {
        dayRenderCount.set(key, Math.min(arr.length, renderLimitPerDay));
        const dateObj = new Date(key+'T00:00:00');
        const rendered = arr.slice(0, dayRenderCount.get(key))
          .sort((a,b)=> asDate(a.scheduledAt) - asDate(b.scheduledAt))
          .map((d, di) => renderCard(d, di)).join('');
        return `
          <section class="space-y-3">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-gray-800">${formatDateLongBR(dateObj)}</h2>
              <span class="text-xs text-gray-500">${arr.length} registro(s)</span>
            </div>
            ${rendered}
          </section>
        `;
      }).join('');

      listView.innerHTML = html;
      loadingView.classList.add('hidden');
      noView.classList.add('hidden');
      listView.classList.remove('hidden');

      const needsMore = grouped.some(([key, arr]) => dayRenderCount.get(key) < arr.length);
      loadMoreBtn.classList.toggle('hidden', !needsMore);
    }

    function loadMore(){
      const baseAll = currentTab==='all' ? rawDonations : (computeBuckets(rawDonations)[currentTab] || []);
      const list = applyFilters(baseAll);
      const grouped = groupByDate(list, currentTab);
      let updated = false;

      for (const [key, arr] of grouped){
        const cur = dayRenderCount.get(key) || 0;
        if (cur < arr.length){
          dayRenderCount.set(key, Math.min(cur + renderLimitPerDay, arr.length));
          updated = true;
        }
      }
      if (updated){
        const html = grouped.map(([key, arr]) => {
          const dateObj = new Date(key+'T00:00:00');
          const rendered = arr.slice(0, dayRenderCount.get(key))
            .sort((a,b)=> asDate(a.scheduledAt) - asDate(b.scheduledAt))
            .map((d, di) => renderCard(d, di)).join('');
          return `
            <section class="space-y-3">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">${formatDateLongBR(dateObj)}</h2>
                <span class="text-xs text-gray-500">${arr.length} registro(s)</span>
              </div>
              ${rendered}
            </section>
          `;
        }).join('');
        listView.innerHTML = html;
        const needsMore = grouped.some(([key, arr]) => (dayRenderCount.get(key)||0) < arr.length);
        loadMoreBtn.classList.toggle('hidden', !needsMore);
      }
    }

    // Subscrição (Firestore)
    function subscribeDonations(entityIds){
      if (typeof unsub === 'function'){ try{unsub();}catch{} unsub=null; }
      const donationsCol = collection(db, paths.donations);
      let qRef;
      if (entityIds.length === 1) qRef = query(donationsCol, where('entityId','==', entityIds[0]));
      else if (entityIds.length > 1) qRef = query(donationsCol, where('entityId','in', entityIds.slice(0,10)));
      else qRef = query(donationsCol);

      unsub = onSnapshot(qRef, (snap) => {
        rawDonations = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderList();
      }, (err) => {
        console.error('Erro ao ler agendamentos:', err);
        loadingView.classList.add('hidden');
        noView.classList.remove('hidden');
      });
    }

    // ====== AÇÕES RÁPIDAS ======

    // Geração de sequencial por tipo de campanha (para códigos de item)
    async function getNextSequence(prefix){
      const ref = doc(db, 'counters', `items_${prefix}`);
      const out = await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        const cur = snap.exists() ? (snap.data().value || 0) : 0;
        tx.set(ref, { value: cur + 1, updatedAt: serverTimestamp() }, { merge: true });
        return cur + 1;
      });
      return out;
    }

    async function ensureItemCodes(donationRef, donation){
      const campaignKey = (donation.campaignType || 'GEN').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8) || 'GEN';
      let changed = false;
      const items = (donation.items || []).map(it => {
        if (!it || it.uniqueCode) return it;
        changed = true;
        return { ...it, uniqueCode: `${campaignKey}-${String(Math.random()).slice(2,6)}${String(Math.random()).slice(2,4)}` };
      });
      // Se quiser sequência real por campanha, substitua a linha acima por:
      // const seq = await getNextSequence(campaignKey);
      // return { ...it, uniqueCode: `${campaignKey}-${String(seq).padStart(6,'0')}` };
      if (changed){
        await updateDoc(donationRef, { items });
      }
    }

    async function handleMarkReceived(donationId){
      const ok = confirm('Confirmar marcação de recebida?');
      if (!ok) return;

      try {
        const donationRef = doc(db, paths.donationDoc(donationId));
        const snap = await getDoc(donationRef);
        if (!snap.exists()){ await showAlertModal('Erro', 'Doação não encontrada.'); return; }
        const data = snap.data();

        // Garante códigos únicos nos itens (se faltarem)
        await ensureItemCodes(donationRef, data);

        const receiverName = session?.profile?.name || session?.profile?.displayName || 'Equipe';
        const updatedItems = (data.items || []).map(it => ({
          ...it,
          status: 'completed',
          receivedAt: serverTimestamp(),
          receivedBy: session?.auth?.uid || null,
          receivedByName: receiverName
        }));

        await updateDoc(donationRef, {
          status: 'completed',
          receivedAt: serverTimestamp(),
          receivedBy: session?.auth?.uid || null,
          receivedByName: receiverName,
          items: updatedItems
        });

        if (data.donorId){
          const msg = `Sua doação para "${data.campaignTitle || 'campanha'}" foi recebida. Obrigado!`;
          await createNotification(data.donorId, msg, 'minhas-entregas.html');
        }

        await showAlertModal('Sucesso', 'Doação marcada como recebida.');
      } catch (e){
        console.error(e);
        await showAlertModal('Erro', 'Falha ao marcar recebida.');
      }
    }

    // Ocupação de um dia para a entidade corrente
    function computeDayOccupancyFor(dateStr){
      if (!currentEntityId) return { map: new Map(), total: 0 };
      const day = new Date(`${dateStr}T00:00:00`);
      const m = new Map();
      let total = 0;
      for (const d of rawDonations){
        if (d.entityId !== currentEntityId) continue;
        const when = asDate(d.scheduledAt);
        if (!when) continue;
        if (fmtDateKey(when) !== dateStr) continue;
        const key = hhmm(when);
        const arr = m.get(key) || [];
        arr.push(d);
        m.set(key, arr);
        total++;
      }
      return { map: m, total };
    }

    function renderOccupancyPanel(dateStr){
      const { map } = computeDayOccupancyFor(dateStr);
      const times = [...map.keys()].sort();
      if (!times.length){
        rsOccupancy.innerHTML = `<div class="text-sm text-gray-600">Sem agendamentos neste dia.</div>`;
        return;
      }
      rsOccupancy.innerHTML = times.map(t => {
        const arr = map.get(t) || [];
        const cls = arr.length ? 'busy' : 'free';
        const list = arr.slice(0,3).map(x => escapeHtml(x.donorName || 'Doador')).join(', ');
        return `<div class="slot ${cls}">
          <div><span class="font-mono text-gray-900">${t}</span> <span class="text-xs text-gray-500">${list ? ' • ' + list : ''}</span></div>
          <div class="count">${arr.length}</div>
        </div>`;
      }).join('');
    }

    function openRescheduleModal(donationId){
      actionDonationId = donationId;
      rsDate.value = '';
      rsTime.value = '';
      rsBlockSlot.checked = false;
      rsJust.value = '';
      rsJustWrap.classList.add('hidden');
      rsCollisionWrap.classList.add('hidden');
      rsCollisionList.innerHTML = '';
      rsBtnConfirmBlock.classList.add('hidden');
      rsModal.classList.add('active');
      rsModal.setAttribute('aria-hidden','false');
      rsDate.focus();
    }

    function closeRescheduleModal(){
      rsModal.classList.remove('active');
      rsModal.setAttribute('aria-hidden','true');
      actionDonationId = null;
    }

    rsDate.addEventListener('change', () => {
      const v = rsDate.value;
      if (v) renderOccupancyPanel(v);
      // reset colisões ao mudar a data
      rsCollisionWrap.classList.add('hidden');
      rsCollisionList.innerHTML = '';
      rsBtnConfirmBlock.classList.add('hidden');
    });

    rsBlockSlot.addEventListener('change', () => {
      const checked = rsBlockSlot.checked;
      rsJustWrap.classList.toggle('hidden', !checked);
      const hasTime = !!rsTime.value;
      rsBtnConfirmBlock.classList.toggle('hidden', !(checked && hasTime));
      if (!(checked && hasTime)){
        rsCollisionWrap.classList.add('hidden');
      } else {
        // Mostrar colisões se houver
        showCollisionsFor(rsDate.value, rsTime.value);
      }
    });

    rsTime.addEventListener('change', () => {
      const checked = rsBlockSlot.checked;
      rsBtnConfirmBlock.classList.toggle('hidden', !(checked && rsTime.value));
      if (checked && rsTime.value){
        showCollisionsFor(rsDate.value, rsTime.value);
      } else {
        rsCollisionWrap.classList.add('hidden');
        rsCollisionList.innerHTML = '';
      }
    });

    function showCollisionsFor(dateStr, timeStr){
      if (!dateStr || !timeStr){ rsCollisionWrap.classList.add('hidden'); return; }
      const { map } = computeDayOccupancyFor(dateStr);
      const list = map.get(timeStr) || [];
      if (!list.length){
        rsCollisionWrap.classList.add('hidden');
        rsCollisionList.innerHTML = '';
        return;
      }
      rsCollisionWrap.classList.remove('hidden');
      rsCollisionList.innerHTML = list.map(d => {
        const items = (d.items || []).map(it => escapeHtml(it.title || it.name || it.type || 'Item')).join(', ');
        return `<li><span class="font-semibold">${escapeHtml(d.donorName || 'Doador')}</span> — <span class="text-gray-600">${items || 'Sem itens'}</span> <span class="text-xs text-gray-500">(${escapeHtml(d.id)})</span></li>`;
      }).join('');
    }

    rsBtnClose.addEventListener('click', closeRescheduleModal);

    rsBtnConfirm.addEventListener('click', async () => {
      if (!actionDonationId) return;
      const dateStr = rsDate.value;
      const timeStr = rsTime.value;
      if (!dateStr || !timeStr){ await showAlertModal('Atenção', 'Informe data e hora.'); return; }
      try {
        const newDate = new Date(`${dateStr}T${timeStr}:00`);
        const donationRef = doc(db, paths.donationDoc(actionDonationId));
        const snap = await getDoc(donationRef);
        if (!snap.exists()){ await showAlertModal('Erro', 'Doação não encontrada.'); return; }
        const donation = snap.data();

        await updateDoc(donationRef, {
          scheduledAt: newDate,
          status: 'scheduled',
          rescheduledAt: serverTimestamp(),
          rescheduledBy: session?.auth?.uid || null,
          rescheduledByName: session?.profile?.name || session?.profile?.displayName || 'Equipe'
        });

        if (donation.donorId){
          const msg = `Seu agendamento para "${donation.campaignTitle || 'campanha'}" foi reagendado para ${newDate.toLocaleDateString('pt-BR')} às ${newDate.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}.`;
          await createNotification(donation.donorId, msg, 'minhas-entregas.html');
        }

        await showAlertModal('Sucesso', 'Agendamento atualizado.');
        closeRescheduleModal();
      } catch (e){
        console.error(e);
        await showAlertModal('Erro', 'Falha ao reagendar.');
      }
    });

    rsBtnConfirmBlock.addEventListener('click', async () => {
      if (!actionDonationId) return;
      const dateStr = rsDate.value;
      const timeStr = rsTime.value;
      const reason = rsJust.value?.trim();
      if (!dateStr || !timeStr){ await showAlertModal('Atenção', 'Informe data e hora.'); return; }
      if (!reason){ await showAlertModal('Atenção', 'Informe uma justificativa para a indisponibilidade.'); return; }

      try {
        const { map } = computeDayOccupancyFor(dateStr);
        const affected = map.get(timeStr) || [];

        // Cancela todos os agendamentos neste slot (se houver)
        if (affected.length){
          const batch = writeBatch(db);
          for (const d of affected){
            const ref = doc(db, paths.donationDoc(d.id));
            batch.update(ref, {
              status: 'cancelled',
              cancelledAt: serverTimestamp(),
              cancelledBy: session?.auth?.uid || null,
              cancelledByName: session?.profile?.name || session?.profile?.displayName || 'Equipe',
              cancelledReason: reason
            });
          }
          await batch.commit();

          // Notifica todos
          for (const d of affected){
            if (d.donorId){
              const msg = `Indisponibilidade no horário ${timeStr} do dia ${new Date(`${dateStr}T00:00`).toLocaleDateString('pt-BR')}. Motivo: ${reason}. Reagende sua entrega, por favor.`;
              await createNotification(d.donorId, msg, 'minhas-entregas.html');
            }
          }
        }

        // Registra bloqueio do slot (para consultas futuras)
        const blockedRef = doc(db, 'blocked_slots', `${currentEntityId}_${dateStr}_${timeStr}`);
        await updateDoc(blockedRef, {
          entityId: currentEntityId,
          date: dateStr,
          time: timeStr,
          reason,
          blockedBy: session?.auth?.uid || null,
          blockedByName: session?.profile?.name || session?.profile?.displayName || 'Equipe',
          updatedAt: serverTimestamp()
        }).catch(async () => {
          // se não existe, cria
          await updateDoc(blockedRef, { createdAt: serverTimestamp() }).catch(()=>{});
        });

        await showAlertModal('Sucesso', `Disponibilidade do horário ${timeStr} bloqueada.${affected.length ? ' Agendamentos impactados foram cancelados e notificados.' : ''}`);
        closeRescheduleModal();
      } catch (e){
        console.error(e);
        await showAlertModal('Erro', 'Falha ao bloquear disponibilidade.');
      }
    });

    // Cancel donation
    function openCancelModal(donationId){
      actionDonationId = donationId;
      cnJust.value = '';
      cnModal.classList.add('active');
      cnModal.setAttribute('aria-hidden','false');
      cnJust.focus();
    }
    function closeCancelModal(){
      cnModal.classList.remove('active');
      cnModal.setAttribute('aria-hidden','true');
      actionDonationId = null;
    }
    cnBtnClose.addEventListener('click', closeCancelModal);
    cnBtnConfirm.addEventListener('click', async () => {
      if (!actionDonationId) return;
      const reason = cnJust.value?.trim();
      if (!reason){ await showAlertModal('Atenção', 'Informe uma justificativa.'); return; }
      try {
        const donationRef = doc(db, paths.donationDoc(actionDonationId));
        const snap = await getDoc(donationRef);
        if (!snap.exists()){ await showAlertModal('Erro', 'Doação não encontrada.'); return; }
        const donation = snap.data();

        await updateDoc(donationRef, {
          status: 'cancelled',
          cancelledAt: serverTimestamp(),
          cancelledBy: session?.auth?.uid || null,
          cancelledByName: session?.profile?.name || session?.profile?.displayName || 'Equipe',
          cancelledReason: reason
        });

        if (donation.donorId){
          const msg = `Sua doação para "${donation.campaignTitle || 'campanha'}" foi cancelada pela entidade. Motivo: ${reason}`;
          await createNotification(donation.donorId, msg, 'minhas-entregas.html');
        }

        await showAlertModal('Informação', 'Doação cancelada.');
        closeCancelModal();
      } catch (e){
        console.error(e);
        await showAlertModal('Erro', 'Falha ao cancelar a doação.');
      }
    });

    // Eventos UI
    let searchTimer=null;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(renderList, 250);
    });
    applyFiltersBtn.addEventListener('click', renderList);
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn'); if (!btn) return;
      currentTab = btn.getAttribute('data-tab');
      [...tabs.querySelectorAll('.tab-btn')].forEach(el => el.classList.remove('border-green-600','text-green-700'));
      btn.classList.add('border-green-600','text-green-700');
      renderList();
    });
    document.getElementById('load-more').addEventListener('click', loadMore);

    // Detalhes do item (modal simples usando o próprio card)
    listView.addEventListener('click', (ev) => {
      const actionBtn = ev.target.closest('[data-action]');
      if (actionBtn){
        const id = actionBtn.getAttribute('data-id');
        const action = actionBtn.getAttribute('data-action');
        // Log (como no seu console)
        console.log('Ação rápida:', action, 'para doação', id);

        if (action === 'mark-received') handleMarkReceived(id);
        if (action === 'reschedule') openRescheduleModal(id);
        if (action === 'cancel') openCancelModal(id);
        return;
      }
    });

    // Boot
    (async function init(){
      const ok = await injectHeader();
      if (!ok) return;

      session = await getCurrentUser();
      const role = session?.profile?.role;
      if (!session?.auth || !['entidade','superadmin'].includes(role)) {
        window.location.href = '403.html';
        return;
      }
      backLink.href = role === 'superadmin' ? 'superadmin.html' : 'admin.html';

      try {
        const cfg = await getDoc(doc(db, paths.configDoc('campaignTypes')));
        campaignTypeSettings = cfg.exists() ? cfg.data() : {};
      } catch (e) {
        console.error('Erro ao carregar campaignTypes:', e);
      }

      const ids = getEffectiveEntityIds(session);
      currentEntityId = ids[0] || null;

      const forced = qs().get('entityId') || qs().get('entidadeId');
      if (forced) {
        activeEntityFilterEl.classList.remove('hidden');
        activeEntityFilterEl.textContent = `Filtro ativo — entityId: ${forced}`;
      }
      subscribeDonations(ids);
    })();
  </script>
</body>
</html>
