<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Faz Bem</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .cropper-container-modal { max-height: 60vh; }
        #image-to-crop { display: block; max-width: 100%; }
        input[type="file"] { display: none; }
        /* Adicionado para esconder elementos antes do Vue montar */
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-header"></div>

    <div id="app" v-cloak>

        <div v-if="isLoading" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
                <p class="mt-4 text-gray-600">{{ loadingMessage }}</p>
            </div>
        </div>

        <main v-else class="container mx-auto max-w-3xl p-4 sm:p-6 my-8">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-6 sm:p-8">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Meu Perfil de Doador</h1>

                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8 pb-8 border-b">
                        <img :src="profile.photoURL || 'https://placehold.co/128x128/e2e8f0/cbd5e0?text=Foto'" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full object-cover bg-gray-200 border-4 border-white shadow-md">
                        <div>
                            <h2 class="text-xl font-bold text-gray-700">{{ profile.displayName || 'Nome não definido' }}</h2>
                            <p class="text-sm text-gray-500">{{ profile.email }}</p>
                            <label for="photo-upload-input" class="mt-3 inline-block bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg cursor-pointer text-sm transition-colors">
                                Alterar Foto
                            </label>
                            <input id="photo-upload-input" type="file" accept="image/png, image/jpeg, image/webp" @change="handleFileChange">
                        </div>
                    </div>

                    <form @submit.prevent="saveProfile" class="space-y-6">
                        <div>
                            <label for="displayName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="displayName" v-model="profile.displayName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                                <input type="tel" id="phone" v-model="profile.phone" placeholder="(00) 00000-0000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="addressCep" class="block text-sm font-medium text-gray-700">CEP</label>
                                <input type="text" id="addressCep" v-model="profile.address.cep" placeholder="00000-000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                        </div>
                        <div>
                            <label for="addressStreet" class="block text-sm font-medium text-gray-700">Endereço (Rua, Av.)</label>
                            <input type="text" id="addressStreet" v-model="profile.address.street" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>

                        <div class="pt-4 flex justify-end items-center">
                            <span :class="feedback.isError ? 'text-red-600' : 'text-green-600'" class="text-sm mr-4">{{ feedback.message }}</span>
                            <button type="submit" :disabled="isSaving" class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 disabled:bg-gray-400">
                               <span v-if="!isSaving">Salvar Alterações</span>
                               <div v-else class="loader"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="mt-10 bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Minhas Doações</h2>
                    <a href="minhas-entregas.html" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors text-center">
                        Ver Entregas Agendadas
                    </a>
                </div>
                <p class="text-gray-500 text-sm">Acompanhe suas doações agendadas, veja os itens que você se comprometeu a entregar e acesse os QR Codes para a confirmação no dia da entrega.</p>
            </div>
        </main>

        <div v-if="isCropperVisible" class="fixed z-50 inset-0 overflow-y-auto">
             <div class="flex items-center justify-center min-h-screen p-4">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75"></div>
                <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
                    <h2 class="text-xl font-bold text-gray-800">Ajuste sua Foto</h2>
                    <div class="cropper-container-modal bg-gray-100">
                        <img id="image-to-crop" :src="cropperImageSrc">
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button @click="cancelCrop" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button @click="confirmAndUploadCrop" :disabled="isUploading" class="inline-flex items-center px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400">
                            <span v-if="!isUploading">Confirmar e Salvar</span>
                            <div v-else class="loader"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, onAuthStateChanged, getCurrentUser } from './app-config.js';
        import { injectHeader } from './app-header.js';
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const { createApp } = Vue

        createApp({
            // 1. ESTADO DA APLICAÇÃO (DATA)
            // Todos os dados que a página precisa agora vivem aqui.
            data() {
                return {
                    isLoading: true,
                    loadingMessage: 'A carregar...',
                    isSaving: false,
                    isUploading: false,
                    isCropperVisible: false,
                    cropperImageSrc: null,
                    cropper: null,
                    currentUser: null,
                    profile: {
                        displayName: '',
                        email: '',
                        phone: '',
                        photoURL: '',
                        address: {
                            cep: '',
                            street: '',
                        },
                    },
                    feedback: {
                        message: '',
                        isError: false
                    }
                }
            },

            // 2. MÉTODOS (LOGIC)
            // Todas as funções que a página executa.
            methods: {
                async initializePage(user) {
                    this.currentUser = user;
                    this.loadingMessage = 'A carregar perfil...';
                    await injectHeader();
                    await this.loadProfileData();
                    this.isLoading = false;
                },

                async loadProfileData() {
                    const userSession = await getCurrentUser();
                    if (userSession?.profile) {
                        const p = userSession.profile;
                        this.profile.displayName = p.displayName || '';
                        this.profile.email = p.email || '';
                        this.profile.photoURL = p.photoURL || '';
                        this.profile.phone = p.phone || '';
                        this.profile.address.cep = p.address?.cep || '';
                        this.profile.address.street = p.address?.street || '';
                    } else {
                        // Fallback para o perfil do Auth se não houver no Firestore
                        this.profile.displayName = userSession.auth.displayName;
                        this.profile.email = userSession.auth.email;
                        this.profile.photoURL = userSession.auth.photoURL;
                    }
                },

                async saveProfile() {
                    this.isSaving = true;
                    this.showFeedback('');

                    const dataToUpdate = {
                        displayName: this.profile.displayName,
                        phone: this.profile.phone,
                        address: {
                            cep: this.profile.address.cep,
                            street: this.profile.address.street,
                        }
                    };

                    try {
                        const userDocRef = doc(db, "users", this.currentUser.uid);
                        await updateDoc(userDocRef, dataToUpdate);
                        await auth.currentUser.updateProfile({ displayName: dataToUpdate.displayName });
                        this.showFeedback('Perfil atualizado com sucesso!');
                    } catch (error) {
                        console.error("Erro ao atualizar perfil:", error);
                        this.showFeedback('Erro ao salvar. Tente novamente.', true);
                    } finally {
                        this.isSaving = false;
                    }
                },
                
                handleFileChange(e) {
                    const file = e.target.files[0];
                    if (!file || !file.type.startsWith('image/')) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.cropperImageSrc = event.target.result;
                        this.isCropperVisible = true;
                        // O Cropper é inicializado quando o modal se torna visível (ver 'updated' hook)
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                },
                
                initCropper() {
                    if (this.cropper) this.cropper.destroy();
                    const imageElement = document.getElementById('image-to-crop');
                    if(imageElement){
                        this.cropper = new Cropper(imageElement, {
                            aspectRatio: 1,
                            viewMode: 1,
                            background: false,
                            autoCropArea: 0.8
                        });
                    }
                },

                cancelCrop() {
                    this.isCropperVisible = false;
                    this.cropper.destroy();
                    this.cropper = null;
                },
                
                confirmAndUploadCrop() {
                    if (!this.cropper) return;
                    this.isUploading = true;
                    this.showFeedback('');

                    const canvas = this.cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' });
                    canvas.toBlob(async (blob) => {
                        try {
                            const storageRef = ref(storage, `profile_photos/${this.currentUser.uid}.webp`);
                            await uploadBytes(storageRef, blob);
                            const photoURL = await getDownloadURL(storageRef);

                            const userDocRef = doc(db, "users", this.currentUser.uid);
                            await updateDoc(userDocRef, { photoURL });
                            await auth.currentUser.updateProfile({ photoURL });

                            this.profile.photoURL = photoURL; // Atualiza a foto reativamente
                            this.showFeedback('Foto atualizada!', false);
                            this.cancelCrop();
                        } catch (error) {
                            console.error("Erro ao atualizar foto:", error);
                            this.showFeedback('Falha no upload da foto.', true);
                        } finally {
                            this.isUploading = false;
                        }
                    }, 'image/webp', 0.9);
                },

                showFeedback(message, isError = false) {
                    this.feedback.message = message;
                    this.feedback.isError = isError;
                    setTimeout(() => { this.feedback.message = ''; }, 4000);
                }
            },

            // 3. LIFECYCLE HOOKS
            // Código que roda em momentos específicos, como quando a app é criada.
            created() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.initializePage(user);
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            },
            
            updated() {
                // Este hook é chamado depois que o DOM é atualizado.
                // Perfeito para inicializar uma biblioteca como o Cropper.js
                // depois que seu elemento alvo (a imagem) se torna visível.
                if (this.isCropperVisible && !this.cropper) {
                    this.initCropper();
                }
            }
        }).mount('#app')

    </script>
</body>
</html>
