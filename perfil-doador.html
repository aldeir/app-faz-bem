<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Faz Bem</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .cropper-container-modal { max-height: 60vh; }
        #image-to-crop { display: block; max-width: 100%; }
        input[type="file"] { display: none; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-header"></div>

    <div id="app" v-cloak>

        <div v-if="!isReady" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
                <p class="mt-4 text-gray-600">A verificar autenticação...</p>
            </div>
        </div>

        <main v-else class="container mx-auto max-w-3xl p-4 sm:p-6 my-8">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-6 sm:p-8">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Meu Perfil de Doador</h1>

                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8 pb-8 border-b">
                        <img :src="profile.photoURL || 'https://placehold.co/128x128/e2e8f0/cbd5e0?text=Foto'" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full object-cover bg-gray-200 border-4 border-white shadow-md">
                        <div>
                            <h2 class="text-xl font-bold text-gray-700">{{ profile.displayName || 'Nome não definido' }}</h2>
                            <p class="text-sm text-gray-500">{{ profile.email }}</p>
                            <label for="photo-upload-input" class="mt-3 inline-block bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg cursor-pointer text-sm transition-colors">
                                Alterar Foto
                            </label>
                            <input id="photo-upload-input" type="file" accept="image/png, image/jpeg, image/webp" @change="handleFileChange">
                        </div>
                    </div>

                    <form @submit.prevent="saveProfile" class="space-y-6">
                        <div>
                            <label for="displayName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="displayName" v-model="profile.displayName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Telefone</label>
                                <input type="tel" id="phone" v-model="profile.phone" placeholder="(00) 00000-0000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="addressCep" class="block text-sm font-medium text-gray-700">CEP</label>
                                <input type="text" id="addressCep" v-model="profile.address.cep" placeholder="00000-000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                        </div>
                        <div>
                            <label for="addressStreet" class="block text-sm font-medium text-gray-700">Endereço (Rua, Av.)</label>
                            <input type="text" id="addressStreet" v-model="profile.address.street" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>

                        <div class="pt-4 flex justify-end items-center">
                            <span :class="feedback.isError ? 'text-red-600' : 'text-green-600'" class="text-sm mr-4">{{ feedback.message }}</span>
                            <button type="submit" :disabled="isSaving" class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 disabled:bg-gray-400">
                               <span v-if="!isSaving">Salvar Alterações</span>
                               <div v-else class="loader"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="mt-10 bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Minhas Doações</h2>
                    <a href="minhas-entregas.html" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors text-center">
                        Ver Entregas Agendadas
                    </a>
                </div>
                <p class="text-gray-500 text-sm">Acompanhe suas doações agendadas, veja os itens que você se comprometeu a entregar e acesse os QR Codes para a confirmação no dia da entrega.</p>
            </div>
        </main>

        <div v-if="isCropperVisible" class="fixed z-50 inset-0 overflow-y-auto">
             <div class="flex items-center justify-center min-h-screen p-4">
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75"></div>
                <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
                    <h2 class="text-xl font-bold text-gray-800">Ajuste sua Foto</h2>
                    <div class="cropper-container-modal bg-gray-100"><img id="image-to-crop"></div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button @click="cancelCrop" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button @click="confirmAndUploadCrop" :disabled="isUploading" class="inline-flex items-center px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400">
                            <span v-if="!isUploading">Confirmar e Salvar</span>
                            <div v-else class="loader"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importando todas as dependências primeiro
        import { auth, db, storage, onAuthStateChanged, getCurrentUser } from './app-config.js';
        import { injectHeader } from './app-header.js';
        import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Desestruturando o Vue para clareza
        const { createApp, ref: vueRef, onMounted, onUpdated } = Vue;

        // --- ORQUESTRAÇÃO DA INICIALIZAÇÃO ---
        // Esta função garante que tudo aconteça na ordem correta.
        async function initialize() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 1. Usuário está autenticado.
                    await injectHeader(); // 2. Injeta o cabeçalho.
                    const userSession = await getCurrentUser(); // 3. Pega os dados completos do usuário.
                    
                    // 4. SÓ AGORA, com todos os dados prontos, cria e monta a aplicação Vue.
                    createVueApp(user, userSession);
                } else {
                    // Se não houver usuário, redireciona para o login.
                    window.location.href = 'login.html';
                }
            });
        }

        // --- DEFINIÇÃO DA APLICAÇÃO VUE ---
        function createVueApp(user, userSession) {
            createApp({
                // SETUP: A nova forma de definir estado e métodos no Vue 3
                setup() {
                    // --- ESTADO REATIVO ---
                    const isReady = vueRef(false); // Controla a tela de loading inicial
                    const isSaving = vueRef(false);
                    const isUploading = vueRef(false);
                    const isCropperVisible = vueRef(false);
                    const cropperInstance = vueRef(null);
                    
                    const profile = vueRef({
                        displayName: '', email: '', phone: '', photoURL: '',
                        address: { cep: '', street: '' },
                    });
                    
                    const feedback = vueRef({ message: '', isError: false });

                    // --- MÉTODOS ---
                    const showFeedback = (message, isError = false) => {
                        feedback.value.message = message;
                        feedback.value.isError = isError;
                        setTimeout(() => { feedback.value.message = ''; }, 4000);
                    };

                    const saveProfile = async () => {
                        isSaving.value = true;
                        showFeedback('');
                        const dataToUpdate = {
                            displayName: profile.value.displayName,
                            phone: profile.value.phone,
                            address: { ...profile.value.address }
                        };
                        try {
                            const userDocRef = doc(db, "users", user.uid);
                            await updateDoc(userDocRef, dataToUpdate);
                            if (auth.currentUser.displayName !== dataToUpdate.displayName) {
                                await auth.currentUser.updateProfile({ displayName: dataToUpdate.displayName });
                            }
                            showFeedback('Perfil atualizado com sucesso!');
                        } catch (error) {
                            console.error("Erro ao atualizar perfil:", error);
                            showFeedback('Erro ao salvar. Tente novamente.', true);
                        } finally {
                            isSaving.value = false;
                        }
                    };
                    
                    const handleFileChange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imageElement = document.getElementById('image-to-crop');
                            imageElement.src = event.target.result;
                            isCropperVisible.value = true;
                        };
                        reader.readAsDataURL(file);
                        e.target.value = '';
                    };

                    const cancelCrop = () => {
                        isCropperVisible.value = false;
                        if (cropperInstance.value) {
                            cropperInstance.value.destroy();
                            cropperInstance.value = null;
                        }
                    };

                    const confirmAndUploadCrop = () => {
                        if (!cropperInstance.value) return;
                        isUploading.value = true;
                        cropperInstance.value.getCroppedCanvas({ width: 256, height: 256 }).toBlob(async (blob) => {
                            try {
                                const storageRef = ref(storage, `profile_photos/${user.uid}.webp`);
                                await uploadBytes(storageRef, blob);
                                const photoURL = await getDownloadURL(storageRef);
                                await updateDoc(doc(db, "users", user.uid), { photoURL });
                                if (auth.currentUser.photoURL !== photoURL) {
                                     await auth.currentUser.updateProfile({ photoURL });
                                }
                                profile.value.photoURL = photoURL;
                                showFeedback('Foto atualizada!');
                                cancelCrop();
                            } catch (error) {
                                showFeedback('Falha no upload da foto.', true);
                            } finally {
                                isUploading.value = false;
                            }
                        }, 'image/webp');
                    };

                    // --- LIFECYCLE HOOKS ---
                    // onMounted é executado depois que o componente é inserido no DOM.
                    onMounted(() => {
                        if (userSession?.profile) {
                            const p = userSession.profile;
                            profile.value = {
                                displayName: p.displayName || user.displayName || '',
                                email: p.email || user.email || '',
                                phone: p.phone || '',
                                photoURL: p.photoURL || user.photoURL || '',
                                address: {
                                    cep: p.address?.cep || '',
                                    street: p.address?.street || ''
                                }
                            };
                        }
                        isReady.value = true; // Libera a exibição da página
                    });
                    
                    // onUpdated é executado quando o DOM é atualizado.
                    onUpdated(() => {
                        if (isCropperVisible.value && !cropperInstance.value) {
                             const imageElement = document.getElementById('image-to-crop');
                             if(imageElement) {
                                cropperInstance.value = new Cropper(imageElement, {
                                    aspectRatio: 1, viewMode: 1, background: false, autoCropArea: 0.8
                                });
                             }
                        }
                    });

                    // Retorna tudo que o template HTML precisa acessar.
                    return {
                        isReady, isSaving, isUploading, isCropperVisible,
                        profile, feedback, saveProfile, handleFileChange,
                        cancelCrop, confirmAndUploadCrop
                    };
                }
            }).mount('#app');
        }

        // --- PONTO DE ENTRADA DO SCRIPT ---
        initialize();

    </script>
</body>
</html>
