<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faz Bem - Painel do Administrador</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .cropper-container-modal { max-height: 60vh; }
        #image-to-crop { display: block; max-width: 100%; }
        input[type="file"] { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <div id="app-container">
        <div id="access-denied-view" class="hidden min-h-screen flex items-center justify-center">
            <div class="text-center p-4">
                <h1 class="text-4xl font-bold text-red-600">Acesso Negado</h1>
                <p class="text-lg text-gray-700 mt-4">Você não tem permissão para acessar esta página.</p>
                <a href="index.html" class="mt-6 inline-block bg-green-600 text-white px-6 py-2 rounded-lg">Voltar à página inicial</a>
            </div>
        </div>

        <div id="dashboard-view" class="hidden">
            <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div id="main-dashboard-view" class="px-4">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Resumo Geral</h2>
                        <div>
                            <button id="profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2">Meu Perfil</button>
                            <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2">Configurações</button>
                            <a href="criar-campanha.html" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">+ Criar Campanha</a>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <a href="#doadores" id="manage-donors-link" class="block bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow"><h3 class="text-sm font-medium text-gray-500">Doadores</h3><p id="total-donors" class="mt-1 text-3xl font-semibold text-gray-900">0</p></a>
                        <a href="#entidades" id="manage-entities-link" class="block bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow"><h3 class="text-sm font-medium text-gray-500">Entidades Ativas</h3><p id="total-entities" class="mt-1 text-3xl font-semibold text-gray-900">0</p></a>
                        <a href="#entidades" id="manage-pending-entities-link" class="block bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow"><h3 class="text-sm font-medium text-gray-500">Pendentes</h3><p id="total-pending-entities" class="mt-1 text-3xl font-semibold text-yellow-600">0</p></a>
                        <a href="#campanhas" id="manage-campaigns-link" class="block bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow"><h3 class="text-sm font-medium text-gray-500">Campanhas</h3><p id="total-campaigns" class="mt-1 text-3xl font-semibold text-gray-900">0</p></a>
                    </div>
                </div>

                <div id="management-container" class="mt-8 hidden">
                    <!-- Gestão de Doadores -->
                    <div id="donors-management-view" class="px-4 hidden">
                         <button class="back-to-dashboard-btn text-sm font-medium text-gray-600 hover:text-green-600 mb-6">← Voltar</button>
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-800">Gestão de Doadores</h2><input type="search" id="donor-search-input" placeholder="Buscar por nome ou e-mail..." class="w-1/3 px-4 py-2 border rounded-lg"></div>
                        <div id="all-donors-list" class="bg-white rounded-lg shadow"></div>
                    </div>
                    <!-- Gestão de Entidades -->
                    <div id="entities-management-view" class="px-4 hidden">
                         <button class="back-to-dashboard-btn text-sm font-medium text-gray-600 hover:text-green-600 mb-6">← Voltar</button>
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-800">Gestão de Entidades</h2><input type="search" id="entity-search-input" placeholder="Buscar por nome, e-mail, CNPJ..." class="w-1/3 px-4 py-2 border rounded-lg"></div>
                        <div id="all-entities-list" class="bg-white rounded-lg shadow"></div>
                    </div>
                    <!-- Gestão de Campanhas -->
                    <div id="campaigns-management-view" class="px-4 hidden">
                         <button class="back-to-dashboard-btn text-sm font-medium text-gray-600 hover:text-green-600 mb-6">← Voltar</button>
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-800">Gestão de Campanhas</h2><input type="search" id="campaign-search-input" placeholder="Buscar por título..." class="w-1/3 px-4 py-2 border rounded-lg"></div>
                        <div id="all-campaigns-list" class="bg-white rounded-lg shadow"></div>
                    </div>
                </div>

                <!-- Perfil do Superadmin -->
                <div id="profile-view" class="px-4 hidden">
                    <button class="back-to-dashboard-btn text-sm font-medium text-gray-600 hover:text-green-600 mb-6">← Voltar</button>
                    <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Meu Perfil Superadmin</h1>
                        <div class="flex items-center space-x-6 mb-8 pb-8 border-b">
                            <img id="profile-photo-preview" src="https://placehold.co/128x128/e2e8f0/cbd5e0?text=Foto" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md">
                            <div>
                                <h2 id="profile-display-name" class="text-xl font-bold text-gray-700"></h2>
                                <p id="profile-email" class="text-sm text-gray-500"></p>
                                <label for="photo-upload-input" class="mt-3 inline-block bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg cursor-pointer text-sm">Alterar Foto</label>
                                <input id="photo-upload-input" type="file" accept="image/*">
                            </div>
                        </div>
                        <form id="profile-form" class="space-y-6">
                            <div><label for="displayName" class="block text-sm font-medium text-gray-700">Nome de Exibição</label><input type="text" id="displayName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div class="pt-4 flex justify-end items-center">
                                <span id="save-feedback" class="text-sm text-green-600 mr-4"></span>
                                <button type="submit" id="save-profile-btn" class="inline-flex items-center justify-center rounded-md border shadow-sm px-6 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700"><span id="save-btn-text">Salvar</span><div id="save-btn-spinner" class="hidden loader"></div></button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Configurações -->
                <div id="settings-view" class="px-4 hidden">
                    <button class="back-to-dashboard-btn text-sm font-medium text-gray-600 hover:text-green-600 mb-6">← Voltar</button>
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-4">Tipos de Campanha</h3>
                        <div id="campaign-types-list" class="mt-4 space-y-4"></div>
                        <div class="mt-6 pt-6 border-t">
                            <h3 class="text-lg font-medium text-gray-900">Adicionar Novo Tipo</h3>
                            <form id="add-type-form" class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div><label for="new-type-label" class="block text-sm font-medium text-gray-700">Rótulo</label><input type="text" id="new-type-label" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                                <div><label for="new-type-id" class="block text-sm font-medium text-gray-700">ID</label><input type="text" id="new-type-id" readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100"></div>
                                <div><label for="new-type-color" class="block text-sm font-medium text-gray-700">Cor</label><select id="new-type-color" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option value="red">Vermelho</option><option value="orange">Laranja</option><option value="yellow">Amarelo</option><option value="green">Verde</option><option value="blue">Azul</option><option value="purple">Roxo</option><option value="pink">Rosa</option><option value="gray">Cinza</option></select></div>
                                <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-green-700">Adicionar</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-4">Itens por Tipo de Campanha</h3>
                        <div id="item-subtypes-list" class="mt-4 space-y-6"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="app-modal"></div>
    <div id="cropper-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Ajuste a sua Foto</h2>
            <div class="cropper-container-modal bg-gray-100"><img id="image-to-crop"></div>
            <div class="flex justify-end space-x-3 pt-4">
                <button id="cancel-crop-btn" type="button" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                <button id="confirm-crop-btn" type="button" class="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, onAuthStateChanged, ADMIN_EMAIL, firebaseConfig, getCurrentUser, updateProfile } from './app-config.js';
        import { injectHeader } from './app-header.js';
        import { collection, query, onSnapshot, doc, updateDoc, setDoc, where, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { showConfirmationModal, showAlertModal, showDetailsModal } from './modal-handler.js';

        const views = {
            accessDenied: document.getElementById('access-denied-view'),
            dashboard: document.getElementById('dashboard-view'),
            mainDashboard: document.getElementById('main-dashboard-view'),
            management: document.getElementById('management-container'),
            donors: document.getElementById('donors-management-view'),
            entities: document.getElementById('entities-management-view'),
            campaigns: document.getElementById('campaigns-management-view'),
            profile: document.getElementById('profile-view'),
            settings: document.getElementById('settings-view'),
        };
        const lists = {
            donors: document.getElementById('all-donors-list'),
            entities: document.getElementById('all-entities-list'),
            campaigns: document.getElementById('all-campaigns-list'),
            campaignTypes: document.getElementById('campaign-types-list'),
            itemSubtypes: document.getElementById('item-subtypes-list'),
        };
        const searchInputs = {
            donor: document.getElementById('donor-search-input'),
            entity: document.getElementById('entity-search-input'),
            campaign: document.getElementById('campaign-search-input'),
        };
        const profileElements = {
            form: document.getElementById('profile-form'),
            photoPreview: document.getElementById('profile-photo-preview'),
            displayName: document.getElementById('profile-display-name'),
            email: document.getElementById('profile-email'),
            displayNameInput: document.getElementById('displayName'),
            photoUploadInput: document.getElementById('photo-upload-input'),
            saveBtn: document.getElementById('save-profile-btn'),
            saveBtnText: document.getElementById('save-btn-text'),
            saveBtnSpinner: document.getElementById('save-btn-spinner'),
            saveFeedback: document.getElementById('save-feedback'),
        };
        const cropperElements = {
            modal: document.getElementById('cropper-modal'),
            image: document.getElementById('image-to-crop'),
            cancelBtn: document.getElementById('cancel-crop-btn'),
            confirmBtn: document.getElementById('confirm-crop-btn'),
        };

        let allDonorsData = [], allEntitiesData = [], allCampaignsData = [];
        let campaignTypeSettings = {}, itemSubtypesSettings = {};
        let currentUser = null, cropper;

        const showView = (viewKey) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views.dashboard.classList.remove('hidden');
            if (['donors', 'entities', 'campaigns'].includes(viewKey)) {
                views.management.classList.remove('hidden');
                views[viewKey].classList.remove('hidden');
            } else if (views[viewKey]) {
                views[viewKey].classList.remove('hidden');
            } else {
                views.mainDashboard.classList.remove('hidden');
            }
            if(history.pushState) {
                history.pushState(null, null, `#${viewKey}`);
            } else {
                location.hash = `#${viewKey}`;
            }
        };

        function handleHashChange() {
            const hash = window.location.hash.substring(1) || 'mainDashboard';
            showView(hash);
        }

        onAuthStateChanged(auth, async (user) => {
            await injectHeader();
            if (user && user.email === ADMIN_EMAIL) {
                currentUser = user;
                loadAllData();
                setupEventListeners();
                handleHashChange();
                window.addEventListener('hashchange', handleHashChange);
            } else {
                showView('accessDenied');
            }
        });

        function loadAllData() {
            loadDashboardMetrics();
            loadAllDonors();
            loadAllEntities();
            loadAllCampaigns();
            loadSettings();
            loadItemSubtypes();
        }

        const formatPhoneNumber = (phone) => {
            if (!phone || typeof phone !== 'string') return 'N/A';
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11) return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
            if (cleaned.length === 10) return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
            return phone;
        };

        function loadDashboardMetrics() {
            onSnapshot(query(collection(db, "users")), snap => { document.getElementById('total-donors').textContent = snap.size; });
            const entitiesPath = `/artifacts/${firebaseConfig.projectId}/public/data/entidades`;
            onSnapshot(query(collection(db, entitiesPath)), snap => {
                document.getElementById('total-entities').textContent = snap.docs.filter(doc => doc.data().status === 'ativo').length;
                document.getElementById('total-pending-entities').textContent = snap.docs.filter(doc => doc.data().status === 'pendente_aprovacao').length;
            });
            const campaignsPath = `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`;
            onSnapshot(query(collection(db, campaignsPath)), snap => { document.getElementById('total-campaigns').textContent = snap.size; });
        }
        
        function renderDonorsList(donors) {
            lists.donors.innerHTML = '';
            if (donors.length === 0) { lists.donors.innerHTML = `<p class="p-6 text-gray-500">Nenhum doador encontrado.</p>`; return; }
            const statusOrder = { 'ativo': 1, 'bloqueado': 2 };
            donors.sort((a, b) => (statusOrder[a.data().status] || 99) - (statusOrder[b.data().status] || 99));
            donors.forEach(docSnapshot => {
                const user = docSnapshot.data();
                const userId = docSnapshot.id;
                const card = document.createElement('div');
                card.className = 'p-4 border-b';
                const statusColors = { 'ativo': 'bg-green-100 text-green-800', 'bloqueado': 'bg-red-100 text-red-800' };
                const status = user.status || 'ativo';
                const statusColor = statusColors[status];
                let actionButton = (status === 'ativo')
                    ? `<button data-action="block-user" data-uid="${userId}" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">Bloquear</button>`
                    : `<button data-action="unblock-user" data-uid="${userId}" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Desbloquear</button>`;
                card.innerHTML = `<div class="flex justify-between items-center"><div class="flex items-center space-x-4"><img src="${user.photoURL || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Foto'}" class="w-16 h-16 rounded-full object-cover border"><div><h4 class="font-bold">${user.displayName}</h4><p class="text-sm text-gray-600">${user.email}</p></div></div><div class="flex items-center space-x-4"><a href="#" data-action="view-user-details" data-uid="${userId}" class="text-sm text-blue-600 hover:underline">Ver Detalhes</a><span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${statusColor}">${status}</span><div class="w-28 text-right">${actionButton}</div></div></div>`;
                lists.donors.appendChild(card);
            });
        }

        function renderEntitiesList(entities) {
            lists.entities.innerHTML = '';
            if (entities.length === 0) { lists.entities.innerHTML = `<p class="p-6 text-gray-500">Nenhuma entidade encontrada.</p>`; return; }
            const statusOrder = { 'pendente_aprovacao': 1, 'ativo': 2, 'bloqueado': 3 };
            entities.sort((a, b) => (statusOrder[a.data().status] || 99) - (statusOrder[b.data().status] || 99));
            entities.forEach(docSnapshot => {
                const entity = docSnapshot.data();
                const entityId = docSnapshot.id;
                const card = document.createElement('div');
                card.className = 'p-4 border-b';
                const statusColors = { 'pendente_aprovacao': 'bg-yellow-100 text-yellow-800', 'ativo': 'bg-green-100 text-green-800', 'bloqueado': 'bg-red-100 text-red-800' };
                let actionButtons = '';
                switch(entity.status) {
                    case 'pendente_aprovacao': actionButtons = `<div class="flex space-x-2"><button data-action="approve" data-uid="${entityId}" class="bg-green-500 text-white px-3 py-1 rounded text-sm">Aprovar</button><button data-action="reject" data-uid="${entityId}" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Reprovar</button></div>`; break;
                    case 'ativo': actionButtons = `<button data-action="block" data-uid="${entityId}" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm">Bloquear</button>`; break;
                    case 'bloqueado': actionButtons = `<button data-action="unblock" data-uid="${entityId}" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Desbloquear</button>`; break;
                }
                card.innerHTML = `<div class="flex justify-between items-center"><div class="flex items-center space-x-4"><img src="${entity.logoUrl || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Logo'}" class="w-16 h-16 rounded-full object-cover border"><div><h4 class="font-bold">${entity.publicName}</h4><p class="text-sm text-gray-600">${entity.email}</p></div></div><div class="flex items-center space-x-4"><a href="#" data-action="view-details" data-uid="${entityId}" class="text-sm text-blue-600 hover:underline">Ver Detalhes</a><span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${statusColors[entity.status]}">${(entity.status || '').replace(/_/g, ' ')}</span><div class="w-28 text-right">${actionButtons}</div></div></div>`;
                lists.entities.appendChild(card);
            });
        }
        
        function renderCampaignsList(campaigns) {
            lists.campaigns.innerHTML = '';
            if (campaigns.length === 0) { lists.campaigns.innerHTML = `<p class="p-6 text-gray-500">Nenhuma campanha encontrada.</p>`; return; }
            campaigns.sort((a, b) => b.data().createdAt.toMillis() - a.data().createdAt.toMillis());
            campaigns.forEach(doc => {
                const campaign = doc.data();
                const campaignId = doc.id;
                const card = document.createElement('div');
                card.className = 'p-4 border-b';
                const status = campaign.status || 'active';
                const statusColors = { 'active': 'bg-green-100 text-green-800', 'suspended': 'bg-yellow-100 text-yellow-800', 'upcoming': 'bg-blue-100 text-blue-800' };
                let actionButton = '';
                if(status === 'active') { actionButton = `<button data-action="suspend" data-uid="${campaignId}" class="text-red-500 hover:underline text-sm font-medium">Suspender</button>`; }
                else if (status === 'suspended') { actionButton = `<button data-action="reactivate" data-uid="${campaignId}" class="text-green-500 hover:underline text-sm font-medium">Reativar</button>`; }
                card.innerHTML = `<div class="flex justify-between items-center"><div class="flex-grow"><h4 class="font-bold">${campaign.title}</h4><p class="text-sm text-gray-500">por ${campaign.entityName}</p></div><div class="flex items-center space-x-4 ml-4"><a href="#" data-action="view-campaign-details" data-id="${campaignId}" class="text-sm text-blue-600 hover:underline">Ver Detalhes</a><span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${statusColors[status]}">${status}</span><a href="criar-campanha.html?editId=${campaignId}" class="text-blue-500 hover:underline text-sm font-medium">Editar</a><div class="w-20 text-center">${actionButton}</div></div></div>`;
                lists.campaigns.appendChild(card);
            });
        }

        function loadAllDonors() { onSnapshot(query(collection(db, "users")), (snapshot) => { allDonorsData = snapshot.docs; renderDonorsList(allDonorsData); }); }
        function loadAllEntities() { onSnapshot(query(collection(db, `/artifacts/${firebaseConfig.projectId}/public/data/entidades`)), (snapshot) => { allEntitiesData = snapshot.docs; renderEntitiesList(allEntitiesData); }); }
        function loadAllCampaigns() { onSnapshot(query(collection(db, `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`)), (snapshot) => { allCampaignsData = snapshot.docs; renderCampaignsList(allCampaignsData); }); }
        
        function loadSettings() {
            const typesDocRef = doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/configs`, 'campaignTypes');
            onSnapshot(typesDocRef, (docSnap) => {
                campaignTypeSettings = docSnap.exists() ? docSnap.data() : {};
                if (!docSnap.exists()) setDoc(typesDocRef, { 'default': { label: 'Outro', color: 'gray' } });
                renderSettings();
            });
        }
        function renderSettings() { /* ... */ }
        function loadItemSubtypes() { /* ... */ }
        function renderItemSubtypes() { /* ... */ }

        function setupEventListeners() {
            document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => btn.addEventListener('click', () => showView('mainDashboard')));
            document.getElementById('manage-donors-link').addEventListener('click', () => showView('donors'));
            document.getElementById('manage-entities-link').addEventListener('click', () => showView('entities'));
            document.getElementById('manage-pending-entities-link').addEventListener('click', () => showView('entities'));
            document.getElementById('manage-campaigns-link').addEventListener('click', () => showView('campaigns'));
            document.getElementById('profile-btn').addEventListener('click', () => { loadProfileData(); showView('profile'); });
            document.getElementById('settings-btn').addEventListener('click', () => showView('settings'));

            // (Resto dos event listeners)
        }
    </script>
</body>
</html>
