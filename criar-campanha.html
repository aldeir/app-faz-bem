<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Criar Nova Campanha - Faz Bem</title>
    
    <meta name="theme-color" content="#22c55e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    <link rel="icon" href="images/icons/icon-72x72.png" type="image/png">

    <link href="style.css" rel="stylesheet">
    <script src="https://unpkg.com/imask"></script> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #submit-campaign-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .time-slot-checkbox { display: none; }
        .time-slot-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid #d1d5db;
        }
        .time-slot-checkbox:checked + .time-slot-label {
            background-color: #16a34a;
            color: white;
            border-color: #15803d;
            transform: scale(1.05);
        }
        .address-field:disabled {
            background-color: #f3f4f6;
            cursor: wait;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-header"></div>

    <main id="page-content">
        <div id="loading-view" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600">A verificar permissões...</p>
            </div>
        </div>

        <div id="form-view" class="hidden">
            <div class="max-w-5xl mx-auto py-8 px-4">
                <form id="create-campaign-form" class="bg-white p-8 rounded-xl shadow-lg" novalidate>
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 id="form-title" class="text-2xl font-semibold">Detalhes da Campanha</h3>
                        <a href="javascript:history.back()" class="text-sm text-gray-500 hover:text-green-600">← Voltar</a>
                    </div>
                    
                    <div id="entity-info-container" class="mb-6"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-4">
                            <div><label for="campaign-title" class="block text-sm font-medium text-gray-700">Título da Campanha*</label><input type="text" id="campaign-title" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label for="campaign-description" class="block text-sm font-medium text-gray-700">Descrição*</label><textarea id="campaign-description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>
                            <div><label for="campaign-type" class="block text-sm font-medium text-gray-700">Tipo*</label><select id="campaign-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></select></div>
                            <div><label for="campaign-goal" class="block text-sm font-medium text-gray-700">Meta (Unidades)</label><input type="number" id="campaign-goal" placeholder="Ex: 100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div>
                                <label for="campaign-priority" class="block text-sm font-medium text-gray-700">Urgência</label>
                                <select id="campaign-priority" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <option value="normal">Normal</option>
                                    <option value="high">Alta</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="campaign-media-upload" class="block text-sm font-medium text-gray-700">Imagens da Campanha (até 5)</label>
                                <input type="file" id="campaign-media-upload" accept="image/jpeg, image/png, image/webp" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                            </div>
                            <div id="media-preview-container" class="grid grid-cols-3 gap-2"></div>
                            
                            <div class="pt-4 border-t">
                                <label for="campaign-video-upload" class="block text-sm font-medium text-gray-700">Vídeo de Destaque (MP4, Opcional)</label>
                                <input type="file" id="campaign-video-upload" accept="video/mp4" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <div id="video-preview-container" class="mt-2 hidden">
                                    <video id="video-preview" class="w-full rounded-md border bg-gray-100" controls></video>
                                    <p id="video-file-name" class="text-sm text-gray-500 mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="delivery-address-section" class="mt-8 pt-6 border-t">
                        <h3 class="text-xl font-semibold mb-1">Endereço de Entrega das Doações</h3>
                        <p class="text-sm text-gray-500 mb-4">Este será o local onde os doadores deverão entregar os itens.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">
                            <div class="md:col-span-1">
                                <label for="campaign-cep" class="block text-sm font-medium text-gray-700">CEP*</label>
                                <input type="text" id="campaign-cep" required placeholder="00000-000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div class="md:col-span-3">
                                <label for="campaign-logradouro" class="block text-sm font-medium text-gray-700">Logradouro*</label>
                                <input type="text" id="campaign-logradouro" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                            </div>
                            <div class="md:col-span-1">
                                <label for="campaign-numero" class="block text-sm font-medium text-gray-700">Número*</label>
                                <input type="text" id="campaign-numero" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div class="md:col-span-3">
                                <label for="campaign-complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                                <input type="text" id="campaign-complemento" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                             <div class="md:col-span-2">
                                <label for="campaign-bairro" class="block text-sm font-medium text-gray-700">Bairro*</label>
                                <input type="text" id="campaign-bairro" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                            </div>
                            <div class="md:col-span-1">
                                <label for="campaign-cidade" class="block text-sm font-medium text-gray-700">Cidade*</label>
                                <input type="text" id="campaign-cidade" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                            </div>
                            <div class="md:col-span-1">
                                <label for="campaign-estado" class="block text-sm font-medium text-gray-700">Estado*</label>
                                <input type="text" id="campaign-estado" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                            </div>
                            <div class="md:col-span-4">
                                <label for="campaign-telefone" class="block text-sm font-medium text-gray-700">Telefone de Contato (para doadores)</label>
                                <input type="tel" id="campaign-telefone" placeholder="(00) 00000-0000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                        </div>
                    </div>

                    <div id="availability-section" class="mt-8 pt-6 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="campaign-starts-at" class="block text-sm font-medium text-gray-700">Data de Início (Opcional)</label>
                                <input type="date" id="campaign-starts-at" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <p class="text-xs text-gray-500 mt-1">Se deixado em branco, a campanha começa hoje.</p>
                            </div>
                            <div>
                                <label for="campaign-duration" class="block text-sm font-medium text-gray-700">Duração (dias)*</label>
                                <select id="campaign-duration" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="1">1 dia</option><option value="3">3 dias</option><option value="7">7 dias</option><option value="15">15 dias</option><option value="30">30 dias</option></select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="campaign-slots" class="block text-sm font-medium text-gray-700">Doadores por Horário</label>
                                <input type="number" id="campaign-slots" value="1" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <p class="text-xs text-gray-500 mt-1">Quantas pessoas podem agendar no mesmo intervalo.</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6 mb-4">
                            <div>
                                <h3 class="text-xl font-semibold">Grade de Horários</h3>
                                <p class="text-sm text-gray-500">Selecione os dias e horários para recebimento.</p>
                            </div>
                            <button type="button" id="replicate-hours-btn" class="hidden bg-blue-100 text-blue-800 text-xs font-semibold py-2 px-3 rounded-lg hover:bg-blue-200">Replicar horários do 1º dia</button>
                        </div>
                        <div id="availability-days-container" class="space-y-6"></div>
                    </div>

                    <div id="form-error" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div class="mt-8 pt-6 border-t flex justify-end items-center">
                        <span id="submit-feedback" class="text-sm text-green-700 mr-4"></span>
                        <button type="submit" id="submit-campaign-btn" class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-6 py-3 bg-green-600 text-base font-medium text-white hover:bg-green-700">
                           <span id="submit-btn-text">Publicar Campanha</span>
                           <div id="submit-btn-spinner" class="hidden loader"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="app-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3><div class="mt-2"><div class="text-sm text-gray-600 space-y-2" id="modal-message-body"></div></div></div></div></div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse" id="modal-buttons"></div>
        </div>
    </div>
</div>

    <script type="module">
        import { auth, db, storage, ADMIN_EMAIL, paths } from './app-config.js';
        import { collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, Timestamp, storageRef, uploadBytes, getDownloadURL } from "./firebase-services.js";
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';
        
        // Seleção de todos os elementos do DOM
        const pageTitle = document.getElementById('page-title');
        const loadingView = document.getElementById('loading-view');
        const formView = document.getElementById('form-view');
        const entityInfoContainer = document.getElementById('entity-info-container');
        const createCampaignForm = document.getElementById('create-campaign-form');
        const formError = document.getElementById('form-error');
        const submitCampaignBtn = document.getElementById('submit-campaign-btn');
        const mediaUploadInput = document.getElementById('campaign-media-upload');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        const videoUploadInput = document.getElementById('campaign-video-upload');
        const videoPreviewContainer = document.getElementById('video-preview-container');
        const videoPreview = document.getElementById('video-preview');
        const videoFileName = document.getElementById('video-file-name');
        const campaignTypeSelect = document.getElementById('campaign-type');
        const durationSelect = document.getElementById('campaign-duration');
        const startsAtInput = document.getElementById('campaign-starts-at');
        const availabilityContainer = document.getElementById('availability-days-container');
        const replicateBtn = document.getElementById('replicate-hours-btn');

        // ### CAMPOS DE ENDEREÇO ###
        const cepInput = document.getElementById('campaign-cep');
        const logradouroInput = document.getElementById('campaign-logradouro');
        const bairroInput = document.getElementById('campaign-bairro');
        const cidadeInput = document.getElementById('campaign-cidade');
        const estadoInput = document.getElementById('campaign-estado');
        const telefoneInput = document.getElementById('campaign-telefone');

        const urlParams = new URLSearchParams(window.location.search);
        const campaignIdToEdit = urlParams.get('editId');
        const isEditMode = !!campaignIdToEdit;
        let campaignMediaFiles = [];
        let campaignVideoFile = null;
        let allEntities = [];

        // Funções auxiliares (generateTimeSlots, renderEntityHeader, etc.)
        function generateTimeSlots() { let s = []; for (let h = 7; h < 20; h++) { s.push(`${String(h).padStart(2, '0')}:00`); s.push(`${String(h).padStart(2, '0')}:30`); } return s; }
        const renderEntityHeader = (p) => { entityInfoContainer.innerHTML = `<div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400 flex items-center space-x-4"><img src="${p.logoUrl || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Logo'}" class="w-16 h-16 rounded-full object-cover border-2 border-green-200 shrink-0"><div><p class="font-bold text-lg text-green-800">${p.publicName}</p><p class="text-sm text-green-700">Publicando/Editando como Entidade Verificada.</p></div></div>`; };
        const setupEditModeUI = () => { pageTitle.textContent = "Editar Campanha - Faz Bem"; document.getElementById('form-title').textContent = "Editar Detalhes da Campanha"; document.getElementById('submit-btn-text').textContent = "Salvar Alterações"; };
        const showLoadingButton = (l) => { document.getElementById('submit-btn-text').classList.toggle('hidden', l); document.getElementById('submit-btn-spinner').classList.toggle('hidden', !l); submitCampaignBtn.disabled = l; };
        const renderMediaPreview = (urls) => { mediaPreviewContainer.innerHTML = ''; urls.forEach(url => { const img = document.createElement('img'); img.src = url; img.className = 'w-full h-24 object-cover rounded-md border'; mediaPreviewContainer.appendChild(img); }); };
        
        function renderAvailabilityGrid(existingAvailability = {}) {
            const duration = parseInt(durationSelect.value, 10);
            availabilityContainer.innerHTML = '';
            if (isNaN(duration) || duration <= 0) return;

            const timeSlots = generateTimeSlots();
            const startDateValue = startsAtInput.value ? new Date(startsAtInput.value + 'T00:00:00') : new Date();
            startDateValue.setHours(0,0,0,0);

            for (let i = 0; i < duration; i++) {
                const dayDate = new Date(startDateValue);
                dayDate.setDate(startDateValue.getDate() + i);
                const dateString = dayDate.toISOString().split('T')[0];
                const formattedDate = dayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
                
                const existingSlotsForDay = new Set(existingAvailability[dateString] || []);
                const timeSlotsHtml = timeSlots.map(time => {
                    const isChecked = existingSlotsForDay.has(time) ? 'checked' : '';
                    return `<div><input type="checkbox" id="time-${dateString}-${time}" value="${time}" class="time-slot-checkbox" data-day-index="${i}" data-date-string="${dateString}" ${isChecked}><label for="time-${dateString}-${time}" class="time-slot-label block text-center py-2 px-1 rounded-md text-sm">${time}</label></div>`;
                }).join('');

                const dayHtml = `<div class="bg-gray-50 p-4 rounded-lg border"><p class="font-semibold text-gray-800 mb-3">${formattedDate}</p><div class="grid grid-cols-5 sm:grid-cols-8 gap-2">${timeSlotsHtml}</div></div>`;
                availabilityContainer.innerHTML += dayHtml;
            }
            replicateBtn.classList.toggle('hidden', duration <= 1);
        }

        const loadCampaignTypes = async () => {
            const typesDocRef = doc(db, paths.configDoc('campaignTypes'));
            const docSnap = await getDoc(typesDocRef);
            if (docSnap.exists()) {
                const types = docSnap.data();
                campaignTypeSelect.innerHTML = '';
                for (const id in types) {
                    campaignTypeSelect.innerHTML += `<option value="${id}">${types[id].label}</option>`;
                }
            }
        };

        function populateForm(data) {
            document.getElementById('campaign-title').value = data.title || '';
            document.getElementById('campaign-description').value = data.description || '';
            campaignTypeSelect.value = data.type || 'default';
            document.getElementById('campaign-goal').value = data.goal || '';
            document.getElementById('campaign-priority').value = data.priority || 'normal';
            document.getElementById('campaign-slots').value = data.slots || '1';
            
            if (data.deliveryAddress) {
                cepInput.value = data.deliveryAddress.cep || '';
                logradouroInput.value = data.deliveryAddress.logradouro || '';
                document.getElementById('campaign-numero').value = data.deliveryAddress.numero || '';
                document.getElementById('campaign-complemento').value = data.deliveryAddress.complemento || '';
                bairroInput.value = data.deliveryAddress.bairro || '';
                cidadeInput.value = data.deliveryAddress.cidade || '';
                estadoInput.value = data.deliveryAddress.estado || '';
                telefoneInput.value = data.deliveryAddress.telefone || '';
            }
            
            if (data.startsAt) { startsAtInput.value = data.startsAt.toDate().toISOString().split('T')[0]; }
            if (data.durationInDays) { durationSelect.value = data.durationInDays; }
            if (data.images && data.images.length > 0) { renderMediaPreview(data.images); }
            if (data.videoUrl) { videoPreviewContainer.classList.remove('hidden'); videoPreview.src = data.videoUrl; videoFileName.textContent = "Vídeo atual. Envie um novo para substituir."; }
        };
        
        async function fetchAddressFromCEP(cep) {
            const cleanCep = cep.replace(/\D/g, '');
            if (cleanCep.length !== 8) return;

            const addressFields = document.querySelectorAll('.address-field');
            addressFields.forEach(field => field.disabled = true);

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                const data = await response.json();
                if (data.erro) {
                    alert('CEP não encontrado. Por favor, verifique e tente novamente.');
                    return;
                }
                logradouroInput.value = data.logradouro;
                bairroInput.value = data.bairro;
                cidadeInput.value = data.localidade;
                estadoInput.value = data.uf;
                document.getElementById('campaign-numero').focus();
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                alert("Não foi possível buscar o endereço. Por favor, preencha manualmente.");
            } finally {
                addressFields.forEach(field => field.disabled = false);
            }
        }
        cepInput.addEventListener('blur', () => fetchAddressFromCEP(cepInput.value));

        // Event Listeners
        replicateBtn.addEventListener('click', () => {
            const firstDayCheckboxes = document.querySelectorAll('.time-slot-checkbox[data-day-index="0"]');
            const otherCheckboxes = document.querySelectorAll('.time-slot-checkbox:not([data-day-index="0"])');
            const firstDaySelections = new Set();
            firstDayCheckboxes.forEach(cb => {
                if (cb.checked) firstDaySelections.add(cb.value);
            });
            otherCheckboxes.forEach(cb => {
                cb.checked = firstDaySelections.has(cb.value);
            });
        });
        durationSelect.addEventListener('change', () => renderAvailabilityGrid());
        startsAtInput.addEventListener('change', () => renderAvailabilityGrid());
        mediaUploadInput.addEventListener('change', (e) => {
            campaignMediaFiles = Array.from(e.target.files).slice(0, 5);
            if (e.target.files.length > 5) { alert("Máximo de 5 imagens."); }
            renderMediaPreview(campaignMediaFiles.map(file => URL.createObjectURL(file)));
        });
        videoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { campaignVideoFile = null; videoPreviewContainer.classList.add('hidden'); return; }
            campaignVideoFile = file;
            videoPreview.src = URL.createObjectURL(file);
            videoFileName.textContent = file.name;
            videoPreviewContainer.classList.remove('hidden');
        });

        createCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('hidden');
            showLoadingButton(true);
            const user = auth.currentUser;

            try {
                let imageUrls;
                if (campaignMediaFiles.length > 0) {
                    imageUrls = await Promise.all(campaignMediaFiles.map(file => {
                        const fileRef = storageRef(storage, `campaigns/${user.uid}_${Date.now()}_${file.name}`);
                        return uploadBytes(fileRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    }));
                }
                
                let videoUrl;
                if (campaignVideoFile) {
                    const videoRef = storageRef(storage, `campaigns/${user.uid}_${Date.now()}_${campaignVideoFile.name}`);
                    videoUrl = await uploadBytes(videoRef, campaignVideoFile).then(s => getDownloadURL(s.ref));
                }
                
                const durationInDays = parseInt(durationSelect.value, 10);
                const startsAtDate = startsAtInput.value ? new Date(startsAtInput.value + 'T00:00:00') : new Date();
                const startsAt = Timestamp.fromDate(startsAtDate);
                const expiresAt = Timestamp.fromMillis(startsAt.toMillis() + durationInDays * 24 * 60 * 60 * 1000);
                
                const availability = {};
                document.querySelectorAll('.time-slot-checkbox:checked').forEach(cb => {
                    const dateString = cb.dataset.dateString;
                    if (!availability[dateString]) { availability[dateString] = []; }
                    availability[dateString].push(cb.value);
                });
                for (const date in availability) { availability[date].sort(); }
                
                const deliveryAddress = {
                    cep: cepInput.value,
                    logradouro: logradouroInput.value,
                    numero: document.getElementById('campaign-numero').value,
                    complemento: document.getElementById('campaign-complemento').value,
                    bairro: bairroInput.value,
                    cidade: cidadeInput.value,
                    estado: estadoInput.value,
                    telefone: telefoneInput.value
                };

                const dataToSave = {
                    title: document.getElementById('campaign-title').value,
                    description: document.getElementById('campaign-description').value,
                    type: document.getElementById('campaign-type').value,
                    goal: document.getElementById('campaign-goal').value || null,
                    priority: document.getElementById('campaign-priority').value,
                    slots: parseInt(document.getElementById('campaign-slots').value, 10) || 1,
                    durationInDays,
                    disponibilidade: availability,
                    startsAt,
                    expiresAt,
                    status: startsAt.toDate() > new Date() ? 'upcoming' : 'active',
                    deliveryAddress,
                    ...(imageUrls && { images: imageUrls }),
                    ...(videoUrl !== undefined && { videoUrl: videoUrl || null }),
                };

                if (isEditMode) {
                    const campaignRef = doc(db, paths.campaignDoc(campaignIdToEdit));
                    await updateDoc(campaignRef, dataToSave);
                    document.getElementById('submit-feedback').textContent = 'Campanha atualizada!';
                } else {
                    let entityInfo;
                    const entitySelector = document.getElementById('entity-selector');
                    if (entitySelector) {
                        const selectedId = entitySelector.value;
                        entityInfo = (selectedId === 'app_faz_bem') ? 
                            { name: "App Faz Bem", uid: "app_faz_bem" } :
                            { name: allEntities.find(e => e.id === selectedId).publicName, uid: selectedId };
                    } else {
                        const userSession = await getCurrentUser();
                        entityInfo = { name: userSession.profile.publicName, uid: user.uid };
                    }
                    
                    const finalData = {
                        ...dataToSave,
                        entityName: entityInfo.name, creatorId: user.uid, entityId: entityInfo.uid,
                        currentAmount: 0, createdAt: Timestamp.now(),
                    };
                    await addDoc(collection(db, paths.campaigns), finalData);
                    document.getElementById('submit-feedback').textContent = 'Campanha publicada!';
                }
                
                setTimeout(() => { window.location.href = user.email === ADMIN_EMAIL ? 'superadmin.html' : 'admin.html'; }, 2000);

            } catch (error) {
                console.error("Erro ao salvar campanha: ", error);
                formError.textContent = `Erro ao salvar: ${error.message}`;
                formError.classList.remove('hidden');
            } finally {
                showLoadingButton(false);
            }
        });

        async function initializeApp() {
            const canProceed = await injectHeader();
            if (!canProceed) return;

            const userSession = await getCurrentUser();
            if (!userSession || !['superadmin', 'entidade'].includes(userSession.profile?.role)) {
                window.location.href = 'index.html';
                return;
            }

            const user = userSession.auth;
            await loadCampaignTypes();
            let campaignDataForEdit = null;
            
            if (isEditMode) {
                setupEditModeUI();
                document.getElementById('loading-text').textContent = "A carregar dados da campanha...";
                const campaignRef = doc(db, paths.campaignDoc(campaignIdToEdit));
                const campaignSnap = await getDoc(campaignRef);
                if (!campaignSnap.exists()) { alert("Erro: Campanha não encontrada."); window.location.href = 'index.html'; return; }
                campaignDataForEdit = campaignSnap.data();

                if (user.uid !== campaignDataForEdit.creatorId && user.email !== ADMIN_EMAIL) { alert("Erro: Você não tem permissão para editar esta campanha."); window.location.href = 'index.html'; return; }
                
                populateForm(campaignDataForEdit);
                renderAvailabilityGrid(campaignDataForEdit.disponibilidade || {});
            } else {
                renderAvailabilityGrid();
            }

            if (user.email === ADMIN_EMAIL) {
                const q = query(collection(db, paths.entidades), where("status", "==", "ativo"));
                const querySnapshot = await getDocs(q);
                allEntities = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let optionsHtml = '<option value="app_faz_bem">App Faz Bem (Campanha Geral)</option>';
                allEntities.forEach(entity => { optionsHtml += `<option value="${entity.id}">${entity.publicName}</option>`; });
                entityInfoContainer.innerHTML = `<label for="entity-selector" class="block text-sm font-medium text-gray-700 mb-2">Publicar em nome de:</label><select id="entity-selector" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 bg-yellow-50">${optionsHtml}</select>`;
                if (isEditMode) { 
                    const entitySelector = document.getElementById('entity-selector');
                    entitySelector.value = campaignDataForEdit.entityId;
                    entitySelector.disabled = true;
                }
            } else if (userSession.profile?.status === 'ativo') {
                renderEntityHeader(userSession.profile);
            } else {
                alert('Acesso negado.'); window.location.href = 'index.html'; 
            }
            loadingView.classList.add('hidden');
            formView.classList.remove('hidden');

            // ### INICIALIZAÇÃO DAS MÁSCARAS ###
            IMask(cepInput, { mask: '00000-000' });
            IMask(telefoneInput, { mask: '(00) 00000-0000' });
        }

        initializeApp();

    </script>
</body>
</html>
