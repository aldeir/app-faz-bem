<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Criar Nova Campanha - Faz Bem</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .media-preview { max-height: 200px; }
        #submit-campaign-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">
        <div id="loading-view" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600">A verificar permissões...</p>
            </div>
        </div>

        <div id="form-view" class="hidden">
            <nav class="bg-white shadow-sm">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-bold text-green-600">Faz Bem</span>
                            <span id="nav-mode-label" class="font-semibold text-gray-500">Nova Campanha</span>
                        </div>
                        <div class="flex items-center">
                             <a href="javascript:history.back()" class="text-sm text-gray-500 hover:text-green-600">← Voltar</a>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="max-w-5xl mx-auto py-8 px-4">
                <form id="create-campaign-form" class="bg-white p-8 rounded-xl shadow-lg" novalidate>
                    <h3 id="form-title" class="text-2xl font-semibold mb-6 border-b pb-4">Detalhes da Campanha</h3>
                    
                    <div id="entity-info-container" class="mb-6"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-4">
                            <div><label for="campaign-title" class="block text-sm font-medium text-gray-700">Título da Campanha*</label><input type="text" id="campaign-title" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label for="campaign-description" class="block text-sm font-medium text-gray-700">Descrição*</label><textarea id="campaign-description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>
                            <div><label for="campaign-type" class="block text-sm font-medium text-gray-700">Tipo*</label><select id="campaign-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="agasalho">Agasalho</option><option value="alimento">Alimento</option><option value="sangue">Doação de Sangue</option><option value="default">Outro</option></select></div>
                            <div><label for="campaign-goal" class="block text-sm font-medium text-gray-700">Meta (Unidades)</label><input type="number" id="campaign-goal" placeholder="Ex: 100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div>
                                <label for="campaign-starts-at" class="block text-sm font-medium text-gray-700">Data de Início (Opcional)</label>
                                <input type="datetime-local" id="campaign-starts-at" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <p class="text-xs text-gray-500 mt-1">Se deixado em branco, a campanha começa imediatamente.</p>
                            </div>
                            <div><label for="campaign-duration" class="block text-sm font-medium text-gray-700">Duração*</label><select id="campaign-duration" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="86400">1 dia</option><option value="259200">3 dias</option><option value="604800">7 dias</option><option value="1296000">15 dias</option><option value="2592000">30 dias</option></select></div>
                        </div>
                        <div class="space-y-4">
                             <div><label for="campaign-media-upload" class="block text-sm font-medium text-gray-700">Imagens da Campanha (até 5)</label><input type="file" id="campaign-media-upload" accept="image/jpeg, image/png, image/webp" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"><p class="text-xs text-gray-500 mt-1">Modo Edição: Enviar novas imagens substituirá as antigas.</p></div>
                            <div id="media-preview-container" class="grid grid-cols-3 gap-2"></div>
                            <div class="pt-4 border-t">
                                <h4 class="text-lg font-medium text-gray-800 mb-2">Local da Ação (se aplicável)</h4>
                                <div class="space-y-3">
                                    <input type="text" id="campaign-address" placeholder="Endereço (Rua, Av.)" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <input type="text" id="campaign-map-link" placeholder="Link do Google Maps" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <input type="text" id="campaign-hours" placeholder="Horário de funcionamento" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <textarea id="campaign-docs" rows="2" placeholder="Documentos necessários ou outras instruções" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="form-error" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div class="mt-8 pt-6 border-t flex justify-end items-center">
                        <span id="submit-feedback" class="text-sm text-green-700 mr-4"></span>
                        <button type="submit" id="submit-campaign-btn" class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-6 py-3 bg-green-600 text-base font-medium text-white hover:bg-green-700">
                           <span id="submit-btn-text">Publicar Campanha</span>
                           <div id="submit-btn-spinner" class="hidden loader"></div>
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, onAuthStateChanged, getCurrentUser, ADMIN_EMAIL, firebaseConfig } from './app-config.js';
        import { collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const pageTitle = document.getElementById('page-title');
        const loadingView = document.getElementById('loading-view');
        const loadingText = document.getElementById('loading-text');
        const formView = document.getElementById('form-view');
        const formTitle = document.getElementById('form-title');
        const navModeLabel = document.getElementById('nav-mode-label');
        const entityInfoContainer = document.getElementById('entity-info-container');
        const createCampaignForm = document.getElementById('create-campaign-form');
        const formError = document.getElementById('form-error');
        const submitCampaignBtn = document.getElementById('submit-campaign-btn');
        const mediaUploadInput = document.getElementById('campaign-media-upload');
        const mediaPreviewContainer = document.getElementById('media-preview-container');

        const urlParams = new URLSearchParams(window.location.search);
        const campaignIdToEdit = urlParams.get('editId');
        const isEditMode = !!campaignIdToEdit;

        let campaignMediaFiles = [];
        let allEntities = [];

        const setupEditModeUI = () => {
            pageTitle.textContent = "Editar Campanha - Faz Bem";
            navModeLabel.textContent = "Modo de Edição";
            formTitle.textContent = "Editar Detalhes da Campanha";
            document.getElementById('submit-btn-text').textContent = "Salvar Alterações";
            document.getElementById('campaign-duration').disabled = true;
            document.getElementById('campaign-starts-at').disabled = true;
        };

        const showLoadingButton = (isLoading) => {
            document.getElementById('submit-btn-text').classList.toggle('hidden', isLoading);
            document.getElementById('submit-btn-spinner').classList.toggle('hidden', !isLoading);
            submitCampaignBtn.disabled = isLoading;
        };
        
        const renderMediaPreview = (imageUrls) => {
            mediaPreviewContainer.innerHTML = '';
            imageUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'w-full h-24 object-cover rounded-md border';
                mediaPreviewContainer.appendChild(img);
            });
        };

        const populateForm = (data) => {
            document.getElementById('campaign-title').value = data.title || '';
            document.getElementById('campaign-description').value = data.description || '';
            document.getElementById('campaign-type').value = data.type || 'default';
            document.getElementById('campaign-goal').value = data.goal || '';
            if (data.startsAt) {
                const date = data.startsAt.toDate();
                // Formato YYYY-MM-DDTHH:mm
                const formattedDate = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2) + 'T' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2);
                document.getElementById('campaign-starts-at').value = formattedDate;
            }
            document.getElementById('campaign-address').value = data.address?.street || '';
            document.getElementById('campaign-map-link').value = data.address?.mapLink || '';
            document.getElementById('campaign-hours').value = data.operation?.hours || '';
            document.getElementById('campaign-docs').value = data.operation?.requiredDocs || '';
            if (data.images && data.images.length > 0) {
                renderMediaPreview(data.images);
            }
        };

        const initializePage = async (user, userSession) => {
            let campaignDataForEdit = null;
            if (isEditMode) {
                setupEditModeUI();
                loadingText.textContent = "A carregar dados da campanha...";
                
                const campaignRef = doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`, campaignIdToEdit);
                const campaignSnap = await getDoc(campaignRef);

                if (!campaignSnap.exists()) {
                    alert("Erro: Campanha não encontrada.");
                    window.location.href = 'index.html';
                    return;
                }
                
                campaignDataForEdit = campaignSnap.data();
                if (user.uid !== campaignDataForEdit.creatorId && user.email !== ADMIN_EMAIL) {
                    alert("Erro: Você não tem permissão para editar esta campanha.");
                    window.location.href = 'index.html';
                    return;
                }
                
                populateForm(campaignDataForEdit);
            }
            
            if (user.email === ADMIN_EMAIL) {
                const entitiesPath = `/artifacts/${firebaseConfig.projectId}/public/data/entidades`;
                const q = query(collection(db, entitiesPath), where("status", "==", "ativo"));
                const querySnapshot = await getDocs(q);
                allEntities = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let optionsHtml = '<option value="app_faz_bem">App Faz Bem (Campanha Geral)</option>';
                allEntities.forEach(entity => {
                    optionsHtml += `<option value="${entity.id}">${entity.publicName}</option>`;
                });
                entityInfoContainer.innerHTML = `<label for="entity-selector" class="block text-sm font-medium text-gray-700 mb-2">Publicar campanha em nome de:</label><select id="entity-selector" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 bg-yellow-50">${optionsHtml}</select>`;
                
                const entitySelector = document.getElementById('entity-selector');
                if (isEditMode) {
                    entitySelector.value = campaignDataForEdit.entityId;
                    entitySelector.disabled = true;
                }

            } else if (userSession?.profile?.role === 'entidade' && userSession.profile.status === 'ativo') {
                entityInfoContainer.innerHTML = `<div class="p-4 bg-blue-50 rounded-lg flex items-center space-x-4"><img src="${userSession.profile.logoUrl || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Logo'}" class="w-16 h-16 rounded-full object-cover border-2 border-blue-200"><div><p class="font-bold text-lg text-gray-800">${userSession.profile.publicName}</p><p class="text-sm text-gray-600">Publicando/Editando campanha como Entidade Verificada.</p></div></div>`;
            } else {
                alert('Acesso negado. Você precisa ser uma entidade aprovada.');
                window.location.href = 'index.html'; 
            }

            loadingView.classList.add('hidden');
            formView.classList.remove('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userSession = await getCurrentUser();
                initializePage(user, userSession);
            } else {
                window.location.href = 'login.html';
            }
        });

        mediaUploadInput.addEventListener('change', (e) => {
            campaignMediaFiles = Array.from(e.target.files).slice(0, 5);
            const previewUrls = campaignMediaFiles.map(file => URL.createObjectURL(file));
            renderMediaPreview(previewUrls);
        });

        createCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('hidden');
            showLoadingButton(true);

            const user = auth.currentUser;
            const campaignsColPath = `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`;

            try {
                let imageUrls;
                if (campaignMediaFiles.length > 0) {
                    const uploadPromises = campaignMediaFiles.map(file => {
                        const mediaRef = ref(storage, `campaigns/${user.uid}_${Date.now()}_${file.name}`);
                        return uploadBytes(mediaRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });
                    imageUrls = await Promise.all(uploadPromises);
                }

                const dataToSave = {
                    title: document.getElementById('campaign-title').value,
                    description: document.getElementById('campaign-description').value,
                    type: document.getElementById('campaign-type').value,
                    goal: document.getElementById('campaign-goal').value || null,
                    address: {
                        street: document.getElementById('campaign-address').value || null,
                        mapLink: document.getElementById('campaign-map-link').value || null,
                    },
                    operation: {
                        hours: document.getElementById('campaign-hours').value || null,
                        requiredDocs: document.getElementById('campaign-docs').value || null,
                    },
                    ...(imageUrls && { images: imageUrls }),
                };

                if (isEditMode) {
                    const campaignRef = doc(db, campaignsColPath, campaignIdToEdit);
                    await updateDoc(campaignRef, dataToSave);
                    document.getElementById('submit-feedback').textContent = 'Campanha atualizada com sucesso!';
                } else {
                    let entityInfo;
                    const entitySelector = document.getElementById('entity-selector');
                    if (entitySelector) {
                        const selectedId = entitySelector.value;
                        if (selectedId === 'app_faz_bem') {
                            entityInfo = { name: "App Faz Bem", uid: "app_faz_bem" };
                        } else {
                            const selectedEntity = allEntities.find(e => e.id === selectedId);
                            entityInfo = { name: selectedEntity.publicName, uid: selectedId };
                        }
                    } else {
                        const userSession = await getCurrentUser();
                        entityInfo = { name: userSession.profile.publicName, uid: user.uid };
                    }
                    
                    const now = Timestamp.now();
                    const startsAtInput = document.getElementById('campaign-starts-at').value;
                    const startsAt = startsAtInput ? Timestamp.fromDate(new Date(startsAtInput)) : now;
                    const durationInSeconds = parseInt(document.getElementById('campaign-duration').value, 10);
                    const expiresAt = new Timestamp(startsAt.seconds + durationInSeconds, startsAt.nanoseconds);
                    const status = startsAt.toMillis() > now.toMillis() ? 'upcoming' : 'active';

                    const finalData = {
                        ...dataToSave,
                        entityName: entityInfo.name,
                        creatorId: user.uid,
                        entityId: entityInfo.uid,
                        progress: 0,
                        createdAt: now,
                        startsAt: startsAt,
                        expiresAt: expiresAt,
                        status: status,
                    };
                    await addDoc(collection(db, campaignsColPath), finalData);
                    document.getElementById('submit-feedback').textContent = 'Campanha publicada com sucesso!';
                }
                
                setTimeout(() => {
                   window.location.href = user.email === ADMIN_EMAIL ? 'superadmin.html' : 'admin.html';
                }, 2000);

            } catch (error) {
                console.error("Erro ao salvar campanha: ", error);
                formError.textContent = `Erro ao salvar: ${error.message}`;
                formError.classList.remove('hidden');
            } finally {
                showLoadingButton(false);
            }
        });
    </script>
</body>
</html>
