<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title id="page-title">Criar Nova Campanha - Faz Bem</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#22c55e" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0f2917" media="(prefers-color-scheme: dark)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="logo.png">
<link rel="apple-touch-icon" href="logo.png">
<link rel="preconnect" href="https://firestore.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="style.css" rel="stylesheet">
<link href="mobile-enhancements.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter',sans-serif; }
.loader { border:3px solid #f3f3f3; border-top:3px solid #16a34a; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite;}
@keyframes spin { to { transform:rotate(360deg);} }
#submit-campaign-btn:disabled { background:#9ca3af; cursor:not-allowed; }
</style>
</head>
<body class="bg-gray-100">
<div id="global-aria-live" aria-live="polite" data-visually-hidden="true"></div>
<div id="app-header"></div>

<main id="page-content">
    <div id="loading-view" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p id="loading-text" class="mt-4 text-gray-600">A verificar permissões...</p>
        </div>
    </div>

    <div id="form-view" class="hidden">
        <div class="max-w-5xl mx-auto py-8 px-4">
            <form id="create-campaign-form" class="bg-white p-8 rounded-xl shadow-lg" novalidate>
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 id="form-title" class="text-2xl font-semibold">Detalhes da Campanha</h1>
                    <a href="javascript:history.back()" class="text-sm text-gray-500 hover:text-green-600">← Voltar</a>
                </div>
                <div id="entity-info-container" class="mb-6"></div>
                <div id="campaign-type-status-banner"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-4">
                        <div>
                            <label for="campaign-title" class="block text-sm font-medium text-gray-700">Título da Campanha*</label>
                            <input type="text" id="campaign-title" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" autocomplete="off">
                        </div>
                        <div>
                            <label for="campaign-description" class="block text-sm font-medium text-gray-700">Descrição*</label>
                            <textarea id="campaign-description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                        </div>
                        <div>
                            <label for="campaign-type" class="block text-sm font-medium text-gray-700">Tipo*</label>
                            <select id="campaign-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></select>
                        </div>
                        <div>
                            <label for="campaign-goal" class="block text-sm font-medium text-gray-700">Meta (Unidades)</label>
                            <input type="number" id="campaign-goal" placeholder="Ex: 100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="campaign-priority" class="block text-sm font-medium text-gray-700">Urgência</label>
                            <select id="campaign-priority" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="normal">Normal</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="campaign-media-upload" class="block text-sm font-medium text-gray-700">Imagens (até 5)</label>
                            <input type="file" id="campaign-media-upload" accept="image/jpeg,image/png,image/webp" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                        </div>
                        <div id="media-preview-container" class="grid grid-cols-3 gap-2"></div>
                        <div class="pt-4 border-t">
                            <label for="campaign-video-upload" class="block text-sm font-medium text-gray-700">Vídeo Destaque (MP4, opcional)</label>
                            <input type="file" id="campaign-video-upload" accept="video/mp4" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <div id="video-preview-container" class="mt-2 hidden">
                                <video id="video-preview" class="w-full rounded-md border bg-gray-100" controls></video>
                                <p id="video-file-name" class="text-sm text-gray-500 mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="delivery-address-section" class="mt-8 pt-6 border-t">
                    <h2 class="text-xl font-semibold mb-1">Endereço de Entrega</h2>
                    <p class="text-sm text-gray-500 mb-4">Local onde os doadores entregarão os itens.</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">
                        <div class="md:col-span-1">
                            <label for="campaign-cep" class="block text-sm font-medium text-gray-700">CEP*</label>
                            <input type="text" id="campaign-cep" required placeholder="00000-000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" inputmode="numeric">
                        </div>
                        <div class="md:col-span-3">
                            <label for="campaign-logradouro" class="block text-sm font-medium text-gray-700">Logradouro*</label>
                            <input type="text" id="campaign-logradouro" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                        </div>
                        <div class="md:col-span-1">
                            <label for="campaign-numero" class="block text-sm font-medium text-gray-700">Número*</label>
                            <input type="text" id="campaign-numero" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div class="md:col-span-3">
                            <label for="campaign-complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                            <input type="text" id="campaign-complemento" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div class="md:col-span-2">
                            <label for="campaign-bairro" class="block text-sm font-medium text-gray-700">Bairro*</label>
                            <input type="text" id="campaign-bairro" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                        </div>
                        <div class="md:col-span-1">
                            <label for="campaign-cidade" class="block text-sm font-medium text-gray-700">Cidade*</label>
                            <input type="text" id="campaign-cidade" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                        </div>
                        <div class="md:col-span-1">
                            <label for="campaign-estado" class="block text-sm font-medium text-gray-700">Estado*</label>
                            <input type="text" id="campaign-estado" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 address-field">
                        </div>
                        <div class="md:col-span-4">
                            <label for="campaign-telefone" class="block text-sm font-medium text-gray-700">Telefone de Contato</label>
                            <input type="tel" id="campaign-telefone" placeholder="(00) 00000-0000" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" inputmode="tel">
                        </div>
                    </div>
                </div>

                <div id="availability-section" class="mt-8 pt-6 border-t">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="campaign-starts-at" class="block text-sm font-medium text-gray-700">Data de Início (Opcional)</label>
                            <input type="date" id="campaign-starts-at" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                            <p class="text-xs text-gray-500 mt-1">Se vazio, começa hoje.</p>
                        </div>
                        <div>
                            <label for="campaign-duration" class="block text-sm font-medium text-gray-700">Duração (dias)*</label>
                            <select id="campaign-duration" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="1">1 dia</option>
                                <option value="3">3 dias</option>
                                <option value="7">7 dias</option>
                                <option value="15">15 dias</option>
                                <option value="30">30 dias</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="campaign-slots" class="block text-sm font-medium text-gray-700">Doadores por Horário</label>
                            <input type="number" id="campaign-slots" value="1" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3" inputmode="numeric">
                            <p class="text-xs text-gray-500 mt-1">Número de doadores simultâneos por intervalo.</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-6 mb-4">
                        <div>
                            <h2 class="text-xl font-semibold">Grade de Horários</h2>
                            <p class="text-sm text-gray-500">Selecione os dias e horários para recebimento.</p>
                        </div>
                        <button type="button" id="replicate-hours-btn" class="hidden bg-blue-100 text-blue-800 text-xs font-semibold py-2 px-3 rounded-lg hover:bg-blue-200">Replicar horários do 1º dia</button>
                    </div>
                    <div id="availability-days-container" class="space-y-6"></div>
                </div>

                <div id="form-error" class="text-red-600 text-sm mt-4 hidden" aria-live="assertive"></div>
                <div class="mt-8 pt-6 border-t flex justify-end items-center hide-on-mobile">
                    <span id="submit-feedback" class="text-sm text-green-700 mr-4"></span>
                    <button type="submit" id="submit-campaign-btn" class="inline-flex items-center justify-center rounded-md shadow-sm px-6 py-3 bg-green-600 text-base font-medium text-white hover:bg-green-700 btn-touch">
                        <span id="submit-btn-text">Publicar Campanha</span>
                        <div id="submit-btn-spinner" class="hidden loader !w-6 !h-6 !border-2 ml-3"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<div class="toast-container" id="toast-container"></div>

<!-- FAB mobile -->
<div class="fab-bar" id="fab-bar" style="display:none;">
  <button id="fab-scroll-top" class="bg-blue-600 text-white">Topo</button>
  <button id="fab-submit" class="bg-green-600 text-white">Publicar</button>
</div>

<script src="https://unpkg.com/imask"></script>
<script type="module">
import { auth, db, storage, ADMIN_EMAIL, paths } from './app-config.js';
import { collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, Timestamp, storageRef, uploadBytes, getDownloadURL } from "./firebase-services.js";
import { injectHeader } from './app-header.js';
import { guard } from './route-guard.js';

let currentUserSession = null;
let campaignTypesCache = [];
const pageTitle = document.getElementById('page-title');
const loadingView = document.getElementById('loading-view');
const formView = document.getElementById('form-view');
const entityInfoContainer = document.getElementById('entity-info-container');
const campaignTypeStatusBanner = document.getElementById('campaign-type-status-banner');
const createCampaignForm = document.getElementById('create-campaign-form');
const formError = document.getElementById('form-error');
const submitCampaignBtn = document.getElementById('submit-campaign-btn');
const mediaUploadInput = document.getElementById('campaign-media-upload');
const mediaPreviewContainer = document.getElementById('media-preview-container');
const videoUploadInput = document.getElementById('campaign-video-upload');
const videoPreviewContainer = document.getElementById('video-preview-container');
const videoPreview = document.getElementById('video-preview');
const videoFileName = document.getElementById('video-file-name');
const campaignTypeSelect = document.getElementById('campaign-type');
const durationSelect = document.getElementById('campaign-duration');
const startsAtInput = document.getElementById('campaign-starts-at');
const availabilityContainer = document.getElementById('availability-days-container');
const replicateBtn = document.getElementById('replicate-hours-btn');
const cepInput = document.getElementById('campaign-cep');
const logradouroInput = document.getElementById('campaign-logradouro');
const bairroInput = document.getElementById('campaign-bairro');
const cidadeInput = document.getElementById('campaign-cidade');
const estadoInput = document.getElementById('campaign-estado');
const telefoneInput = document.getElementById('campaign-telefone');

const urlParams = new URLSearchParams(window.location.search);
const campaignIdToEdit = urlParams.get('editId');
const isEditMode = !!campaignIdToEdit;
let campaignMediaFiles = [];
let campaignVideoFile = null;
let allEntities = [];

function showToast(msg,type='success'){const c=document.getElementById('toast-container');const el=document.createElement('div');el.className='toast '+type;el.textContent=msg;c.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),350)},3500);}
window.addEventListener('message',e=>{
 if(e.data?.type==='toast') showToast(e.data.message,e.data.status==='success'?'success':'error');
});

function generateTimeSlots(){const s=[];for(let h=7;h<20;h++){s.push(`${String(h).padStart(2,'0')}:00`);s.push(`${String(h).padStart(2,'0')}:30`);}return s;}
function renderEntityHeader(profile) {
    const entityName = profile.dadosEntidade?.nomeFantasia || profile.publicName || 'Nome da Entidade';
    const logoUrl = profile.logoUrl || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Logo';
    entityInfoContainer.innerHTML = `
        <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400 flex items-center space-x-4">
            <img src="${logoUrl}" class="w-16 h-16 rounded-full object-cover border-2 border-green-200 shrink-0">
            <div>
                <p class="font-bold text-lg text-green-800">${entityName}</p>
                <p class="text-sm text-green-700">Publicando como Entidade Verificada.</p>
            </div>
        </div>`;
}
function setupEditModeUI() {
    pageTitle.textContent="Editar Campanha - Faz Bem";
    document.getElementById('form-title').textContent="Editar Detalhes da Campanha";
    document.getElementById('submit-btn-text').textContent="Salvar Alterações";
}
function showLoadingButton(l) {
    document.getElementById('submit-btn-text').classList.toggle('hidden', l);
    document.getElementById('submit-btn-spinner').classList.toggle('hidden', !l);
    submitCampaignBtn.disabled = l;
}
function renderMediaPreview(urls) {
    mediaPreviewContainer.innerHTML='';
    urls.forEach(url=>{
        const img=document.createElement('img');
        img.src=url;
        img.loading='lazy';
        img.className='w-full h-24 object-cover rounded-md border';
        mediaPreviewContainer.appendChild(img);
    });
}

function renderAvailabilityGrid(existingAvailability = {}) {
    const duration = parseInt(durationSelect.value,10);
    availabilityContainer.innerHTML='';
    if(isNaN(duration)||duration<=0) return;
    const timeSlots = generateTimeSlots();
    const startDateValue = startsAtInput.value ? new Date(startsAtInput.value+'T00:00:00') : new Date();
    startDateValue.setHours(0,0,0,0);
    for(let i=0;i<duration;i++){
        const dayDate=new Date(startDateValue);
        dayDate.setDate(startDateValue.getDate()+i);
        const dateString=dayDate.toISOString().split('T')[0];
        const formattedDate=dayDate.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'short'});
        const existingSlotsForDay=new Set(existingAvailability[dateString]||[]);
        const timeSlotsHtml=timeSlots.map(time=>{
            const isChecked= existingSlotsForDay.has(time)? 'checked':'';
            return `<div><input type="checkbox" id="time-${dateString}-${time}" value="${time}" class="time-slot-checkbox" data-day-index="${i}" data-date-string="${dateString}" ${isChecked}><label for="time-${dateString}-${time}" class="time-slot-label block text-center py-2 px-1 rounded-md text-sm">${time}</label></div>`;
        }).join('');
        availabilityContainer.innerHTML += `
            <div class="bg-gray-50 p-4 rounded-lg border">
                <p class="font-semibold text-gray-800 mb-3">${formattedDate}</p>
                <div class="grid grid-cols-5 sm:grid-cols-8 gap-2">${timeSlotsHtml}</div>
            </div>`;
    }
    replicateBtn.classList.toggle('hidden', duration<=1);
}

async function loadCampaignTypes(selectedTypeId=null){
    const typesDocRef = doc(db, paths.configDoc('campaignTypes'));
    const docSnap=await getDoc(typesDocRef);
    campaignTypesCache=[];
    campaignTypeSelect.innerHTML='';
    if(!docSnap.exists()){
        campaignTypeSelect.innerHTML='<option value="">(Nenhum tipo configurado)</option>';
        return;
    }
    const typesObj=docSnap.data()||{};
    Object.keys(typesObj).forEach(id=>{
        const t=typesObj[id]||{};
        campaignTypesCache.push({
            id,
            label: t.label || id,
            active: t.active !== false,
            order: t.order || 0,
            color: t.color || 'green'
        });
    });
    campaignTypesCache.sort((a,b)=>(a.order - b.order)||(a.label.localeCompare(b.label,'pt-BR')));
    let currentTypeData=null;
    if(selectedTypeId){
        currentTypeData=campaignTypesCache.find(t=>t.id===selectedTypeId);
        if(!currentTypeData && typesObj[selectedTypeId]){
            const t=typesObj[selectedTypeId];
            currentTypeData={
                id:selectedTypeId,
                label:t.label || selectedTypeId,
                active:t.active !== false,
                order:t.order || 0,
                color:t.color || 'green'
            };
            campaignTypesCache.push(currentTypeData);
        }
    }
    const activeTypes=campaignTypesCache.filter(t=>t.active);
    const hasActive=activeTypes.length>0;
    if(!hasActive && !isEditMode){
        campaignTypeStatusBanner.innerHTML=`
          <div class="error-banner bg-red-50 border-l-4 border-red-500 p-3 rounded">
            <p class="text-sm text-red-700 font-medium">Não há tipos ativos. Ative em Configurações para criar campanhas.</p>
          </div>`;
        campaignTypeSelect.innerHTML='<option value="">— nenhum tipo ativo —</option>';
        campaignTypeSelect.disabled=true;
        submitCampaignBtn.disabled=true;
        return;
    } else {
        campaignTypeSelect.disabled=false;
        submitCampaignBtn.disabled=false;
    }
    let optionsHtml='<option value="">Selecione...</option>';
    activeTypes.forEach(t=>{
        optionsHtml+=`<option value="${t.id}">${t.label}</option>`;
    });
    if(isEditMode && currentTypeData && !currentTypeData.active){
        optionsHtml+=`<option value="${currentTypeData.id}" selected>${currentTypeData.label} (inativo)</option>`;
        campaignTypeStatusBanner.innerHTML=`
          <div class="warning-banner bg-orange-50 border-l-4 border-orange-400 p-3 rounded">
            <p class="text-sm text-orange-700 font-medium">O tipo desta campanha está inativo. Considere trocar antes de salvar.</p>
          </div>`;
    } else {
        campaignTypeStatusBanner.innerHTML='';
    }
    campaignTypeSelect.innerHTML=optionsHtml;
    if(selectedTypeId && campaignTypeSelect.querySelector(`option[value="${selectedTypeId}"]`)){
        campaignTypeSelect.value=selectedTypeId;
    }
}

function populateForm(data){
    document.getElementById('campaign-title').value=data.title || '';
    document.getElementById('campaign-description').value=data.description || '';
    campaignTypeSelect.value=data.type || '';
    document.getElementById('campaign-goal').value=data.goal || '';
    document.getElementById('campaign-priority').value=data.priority || 'normal';
    document.getElementById('campaign-slots').value=data.slots || '1';
    if(data.deliveryAddress){
        cepInput.value=data.deliveryAddress.cep || '';
        logradouroInput.value=data.deliveryAddress.logradouro || '';
        document.getElementById('campaign-numero').value=data.deliveryAddress.numero || '';
        document.getElementById('campaign-complemento').value=data.deliveryAddress.complemento || '';
        bairroInput.value=data.deliveryAddress.bairro || '';
        cidadeInput.value=data.deliveryAddress.cidade || '';
        estadoInput.value=data.deliveryAddress.estado || '';
        telefoneInput.value=data.deliveryAddress.telefone || '';
    }
    if(data.startsAt){ try { startsAtInput.value=data.startsAt.toDate().toISOString().split('T')[0]; } catch{} }
    if(data.durationInDays) durationSelect.value=data.durationInDays;
    if(data.images?.length) renderMediaPreview(data.images);
    if(data.videoUrl){
        videoPreviewContainer.classList.remove('hidden');
        videoPreview.src=data.videoUrl;
        videoFileName.textContent="Vídeo atual. Envie um novo para substituir.";
    }
}

async function fetchAddressFromCEP(cep){
    const clean=cep.replace(/\D/g,'');
    if(clean.length!==8) return;
    const fields=document.querySelectorAll('.address-field');
    fields.forEach(f=>f.disabled=true);
    try{
        const resp=await fetch(`https://viacep.com.br/ws/${clean}/json/`);
        if(!resp.ok) throw new Error('CEP não encontrado');
        const data=await resp.json();
        if(data.erro){ alert('CEP não encontrado'); return; }
        logradouroInput.value=data.logradouro;
        bairroInput.value=data.bairro;
        cidadeInput.value=data.localidade;
        estadoInput.value=data.uf;
        document.getElementById('campaign-numero').focus();
    }catch(err){
        console.error(err);
        alert('Não foi possível buscar o endereço.');
    }finally{
        fields.forEach(f=>f.disabled=false);
    }
}

cepInput.addEventListener('blur', ()=>fetchAddressFromCEP(cepInput.value));
replicateBtn.addEventListener('click', ()=>{
    const firstDayCheckboxes=document.querySelectorAll('.time-slot-checkbox[data-day-index="0"]');
    const otherCheckboxes=document.querySelectorAll('.time-slot-checkbox:not([data-day-index="0"])');
    const copySet=new Set();
    firstDayCheckboxes.forEach(cb=>{ if(cb.checked) copySet.add(cb.value);});
    otherCheckboxes.forEach(cb=> cb.checked = copySet.has(cb.value));
});
durationSelect.addEventListener('change', ()=>renderAvailabilityGrid());
startsAtInput.addEventListener('change', ()=>renderAvailabilityGrid());
mediaUploadInput.addEventListener('change', e=>{
    campaignMediaFiles = Array.from(e.target.files).slice(0,5);
    if(e.target.files.length>5) alert("Máximo de 5 imagens.");
    renderMediaPreview(campaignMediaFiles.map(f=>URL.createObjectURL(f)));
});
videoUploadInput.addEventListener('change', e=>{
    const file=e.target.files[0];
    if(!file){ campaignVideoFile=null; videoPreviewContainer.classList.add('hidden'); return; }
    campaignVideoFile=file;
    videoPreview.src=URL.createObjectURL(file);
    videoFileName.textContent=file.name;
    videoPreviewContainer.classList.remove('hidden');
});
availabilityContainer.addEventListener('change', ()=>{ /* espaço para lógica adicional se necessário */ });

createCampaignForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    formError.classList.add('hidden');
    if(!campaignTypeSelect.value){
        formError.textContent='Selecione um tipo de campanha.';
        formError.classList.remove('hidden');
        return;
    }
    showLoadingButton(true);
    const user = auth.currentUser;
    try{
        let imageUrls;
        if(campaignMediaFiles.length>0){
            imageUrls=await Promise.all(campaignMediaFiles.map(file=>{
                const fileRef=storageRef(storage,`campaigns/${user.uid}_${Date.now()}_${file.name}`);
                return uploadBytes(fileRef,file).then(s=>getDownloadURL(s.ref));
            }));
        }
        let videoUrl;
        if(campaignVideoFile){
            const videoRef=storageRef(storage,`campaigns/${user.uid}_${Date.now()}_${campaignVideoFile.name}`);
            videoUrl = await uploadBytes(videoRef,campaignVideoFile).then(s=>getDownloadURL(s.ref));
        }
        const durationInDays=parseInt(durationSelect.value,10);
        const startsAtDate= startsAtInput.value ? new Date(startsAtInput.value+'T00:00:00') : new Date();
        const startsAt=Timestamp.fromDate(startsAtDate);
        const expiresAt=Timestamp.fromMillis(startsAt.toMillis() + durationInDays*24*60*60*1000);
        const availability={};
        document.querySelectorAll('.time-slot-checkbox:checked').forEach(cb=>{
            const dateString = cb.dataset.dateString;
            if(!availability[dateString]) availability[dateString]=[];
            availability[dateString].push(cb.value);
        });
        for(const d in availability) availability[d].sort();
        const deliveryAddress={
            cep: cepInput.value,
            logradouro: logradouroInput.value,
            numero: document.getElementById('campaign-numero').value,
            complemento: document.getElementById('campaign-complemento').value,
            bairro: bairroInput.value,
            cidade: cidadeInput.value,
            estado: estadoInput.value,
            telefone: telefoneInput.value
        };
        const dataToSave={
            title: document.getElementById('campaign-title').value,
            description: document.getElementById('campaign-description').value,
            type: document.getElementById('campaign-type').value,
            goal: document.getElementById('campaign-goal').value || null,
            priority: document.getElementById('campaign-priority').value,
            slots: parseInt(document.getElementById('campaign-slots').value,10)||1,
            durationInDays,
            disponibilidade: availability,
            startsAt,
            expiresAt,
            status: startsAt.toDate() > new Date() ? 'upcoming':'active',
            deliveryAddress,
            ...(imageUrls && { images:imageUrls }),
            ...(videoUrl !== undefined && { videoUrl: videoUrl || null })
        };
        if(isEditMode){
            const campaignRef=doc(db, paths.campaignDoc(campaignIdToEdit));
            await updateDoc(campaignRef, dataToSave);
            document.getElementById('submit-feedback').textContent='Campanha atualizada!';
        } else {
            let entityInfo;
            const entitySelector=document.getElementById('entity-selector');
            if(entitySelector){
                const selectedId=entitySelector.value;
                const selectedEntity=allEntities.find(e=>e.id===selectedId);
                entityInfo = (selectedId==='app_faz_bem')
                  ? { name:"App Faz Bem", uid:"app_faz_bem" }
                  : { name: selectedEntity.dadosEntidade?.nomeFantasia || selectedEntity.publicName, uid:selectedId };
            } else {
                const entityName=currentUserSession.profile.dadosEntidade?.nomeFantasia || currentUserSession.profile.publicName;
                entityInfo={ name:entityName, uid: currentUserSession.auth.uid };
            }
            const finalData={
                ...dataToSave,
                entityName: entityInfo.name,
                creatorId: user.uid,
                entityId: entityInfo.uid,
                entityVerified: true,
                currentAmount: 0,
                createdAt: Timestamp.now()
            };
            await addDoc(collection(db, paths.campaigns), finalData);
            document.getElementById('submit-feedback').textContent='Campanha publicada!';
        }
        setTimeout(()=>{ window.location.href = user.email===ADMIN_EMAIL ? 'superadmin.html':'admin.html'; }, 2000);
    }catch(error){
        console.error("Erro ao salvar campanha: ", error);
        formError.textContent=`Erro ao salvar: ${error.message}`;
        formError.classList.remove('hidden');
    }finally{
        showLoadingButton(false);
    }
});

function toggleFab(){
    const fab=document.getElementById('fab-bar');
    if(window.innerWidth<=640){
        fab.style.display='flex';
        document.body.classList.add('has-fab-bottom-padding');
    } else {
        fab.style.display='none';
        document.body.classList.remove('has-fab-bottom-padding');
    }
}
window.addEventListener('resize',toggleFab);
document.getElementById('fab-scroll-top').onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
document.getElementById('fab-submit').onclick=()=>submitCampaignBtn?.click();

async function initializeApp(){
    const canProceed=await injectHeader();
    if(!canProceed) return;
    currentUserSession=await guard({
        requireAuth:true,
        requiredRoles:['superadmin','entidade'],
        requireApprovedEntity:true
    });
    if(!currentUserSession) return;
    if(currentUserSession.profile.role==='entidade' && currentUserSession.profile.status!=='ativo'){
        alert('Sua entidade precisa estar aprovada.');
        window.location.href='admin.html';
        return;
    }
    const user=currentUserSession.auth;
    let campaignDataForEdit=null;
    if(isEditMode){
        setupEditModeUI();
        document.getElementById('loading-text').textContent='A carregar dados da campanha...';
        const campaignRef=doc(db, paths.campaignDoc(campaignIdToEdit));
        const campaignSnap=await getDoc(campaignRef);
        if(!campaignSnap.exists()){
            alert('Campanha não encontrada.');
            window.location.href='index.html';
            return;
        }
        campaignDataForEdit=campaignSnap.data();
        if(user.uid!==campaignDataForEdit.creatorId && user.email!==ADMIN_EMAIL){
            alert('Sem permissão para editar.');
            window.location.href='index.html';
            return;
        }
        await loadCampaignTypes(campaignDataForEdit.type);
        populateForm(campaignDataForEdit);
        renderAvailabilityGrid(campaignDataForEdit.disponibilidade || {});
    } else {
        await loadCampaignTypes();
        renderAvailabilityGrid();
    }
    if(user.email===ADMIN_EMAIL){
        const q=query(collection(db, paths.entidades), where("status","==","ativo"));
        const querySnapshot=await getDocs(q);
        allEntities=querySnapshot.docs.map(d=>({id:d.id, ...d.data()}));
        let optionsHtml='<option value="app_faz_bem">App Faz Bem (Campanha Geral)</option>';
        allEntities.forEach(entity=>{
            const displayName=entity.dadosEntidade?.nomeFantasia || entity.publicName;
            optionsHtml+=`<option value="${entity.id}">${displayName}</option>`;
        });
        entityInfoContainer.innerHTML=`
          <label for="entity-selector" class="block text-sm font-medium text-gray-700 mb-2">Publicar em nome de:</label>
          <select id="entity-selector" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 bg-yellow-50">${optionsHtml}</select>`;
        if(isEditMode){
            const entitySelector=document.getElementById('entity-selector');
            entitySelector.value=campaignDataForEdit.entityId;
            entitySelector.disabled=true;
        }
    } else {
        renderEntityHeader(currentUserSession.profile);
    }
    loadingView.classList.add('hidden');
    formView.classList.remove('hidden');
    IMask(cepInput,{mask:'00000-000'});
    IMask(telefoneInput,{mask:'(00) 00000-0000'});
    toggleFab();
}

initializeApp();

if('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
</script>
</body>
</html>
