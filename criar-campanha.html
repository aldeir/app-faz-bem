<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Nova Campanha - Faz Bem</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .media-preview { max-height: 200px; }
        #submit-campaign-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">
        <div id="loading-view" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">A verificar permissões...</p>
            </div>
        </div>

        <div id="form-view" class="hidden">
            <nav class="bg-white shadow-sm">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-bold text-green-600">Faz Bem</span>
                            <span class="font-semibold text-gray-500">Nova Campanha</span>
                        </div>
                        <div class="flex items-center">
                             <a href="javascript:history.back()" class="text-sm text-gray-500 hover:text-green-600">← Voltar</a>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="max-w-5xl mx-auto py-8 px-4">
                <form id="create-campaign-form" class="bg-white p-8 rounded-xl shadow-lg" novalidate>
                    <h3 class="text-2xl font-semibold mb-6 border-b pb-4">Detalhes da Campanha</h3>
                    
                    <div id="entity-info-container" class="mb-6">
                        </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-4">
                            <div><label for="campaign-title" class="block text-sm font-medium text-gray-700">Título da Campanha*</label><input type="text" id="campaign-title" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label for="campaign-description" class="block text-sm font-medium text-gray-700">Descrição*</label><textarea id="campaign-description" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>
                            <div><label for="campaign-type" class="block text-sm font-medium text-gray-700">Tipo*</label><select id="campaign-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="agasalho">Agasalho</option><option value="alimento">Alimento</option><option value="sangue">Doação de Sangue</option><option value="default">Outro</option></select></div>
                            <div><label for="campaign-goal" class="block text-sm font-medium text-gray-700">Meta (Unidades)</label><input type="number" id="campaign-goal" placeholder="Ex: 100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label for="campaign-duration" class="block text-sm font-medium text-gray-700">Duração*</label><select id="campaign-duration" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="86400">1 dia</option><option value="259200">3 dias</option><option value="604800">7 dias</option><option value="1296000">15 dias</option><option value="2592000">30 dias</option></select></div>
                        </div>
                        <div class="space-y-4">
                            <div><label for="campaign-media-upload" class="block text-sm font-medium text-gray-700">Imagens da Campanha (até 5)*</label><input type="file" id="campaign-media-upload" accept="image/jpeg, image/png, image/webp" required multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"></div>
                            <div id="media-preview-container" class="hidden grid grid-cols-3 gap-2">
                                </div>
                            <div class="pt-4 border-t">
                                <h4 class="text-lg font-medium text-gray-800 mb-2">Local da Ação (se aplicável)</h4>
                                <div class="space-y-3">
                                    <input type="text" id="campaign-address" placeholder="Endereço (Rua, Av.)" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <input type="text" id="campaign-map-link" placeholder="Link do Google Maps" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <input type="text" id="campaign-hours" placeholder="Horário de funcionamento" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <textarea id="campaign-docs" rows="2" placeholder="Documentos necessários ou outras instruções" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="form-error" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div class="mt-8 pt-6 border-t flex justify-end items-center">
                        <span id="submit-feedback" class="text-sm text-green-700 mr-4"></span>
                        <button type="submit" id="submit-campaign-btn" class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-6 py-3 bg-green-600 text-base font-medium text-white hover:bg-green-700">
                           <span id="submit-btn-text">Publicar Campanha</span>
                           <div id="submit-btn-spinner" class="hidden loader"></div>
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, onAuthStateChanged, getCurrentUser, ADMIN_EMAIL, firebaseConfig } from './app-config.js';
        import { collection, addDoc, query, where, onSnapshot, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Elementos do DOM
        const loadingView = document.getElementById('loading-view');
        const formView = document.getElementById('form-view');
        const entityInfoContainer = document.getElementById('entity-info-container');
        const createCampaignForm = document.getElementById('create-campaign-form');
        const formError = document.getElementById('form-error');
        const submitCampaignBtn = document.getElementById('submit-campaign-btn');
        const mediaUploadInput = document.getElementById('campaign-media-upload');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        
        let campaignMediaFiles = [];
        let allEntities = [];

        // Função para renderizar o cabeçalho para Entidades
        const renderEntityHeader = (profile) => {
            entityInfoContainer.innerHTML = `
                <div class="p-4 bg-blue-50 rounded-lg flex items-center space-x-4">
                    <img src="${profile.logoUrl || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Logo'}" class="w-16 h-16 rounded-full object-cover border-2 border-blue-200">
                    <div>
                        <p class="font-bold text-lg text-gray-800">${profile.publicName}</p>
                        <p class="text-sm text-gray-600">Publicando campanha como Entidade Verificada.</p>
                    </div>
                </div>`;
        };

        // Função para renderizar o cabeçalho para o Super Admin
        const renderSuperAdminHeader = (entities) => {
            let optionsHtml = '<option value="app_faz_bem">App Faz Bem (Campanha Geral)</option>';
            entities.forEach(entity => {
                optionsHtml += `<option value="${entity.id}">${entity.publicName}</option>`;
            });
            entityInfoContainer.innerHTML = `
                <label for="entity-selector" class="block text-sm font-medium text-gray-700 mb-2">Publicar campanha em nome de:</label>
                <select id="entity-selector" class="block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 bg-yellow-50">${optionsHtml}</select>`;
        };

        const showLoadingButton = (isSaving) => {
            document.getElementById('submit-btn-text').classList.toggle('hidden', isSaving);
            document.getElementById('submit-btn-spinner').classList.toggle('hidden', !isSaving);
            submitCampaignBtn.disabled = isSaving;
        };

        // Verifica o utilizador e prepara o formulário
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userSession = await getCurrentUser();
                
                if (user.email === ADMIN_EMAIL) {
                    const entitiesPath = `/artifacts/${firebaseConfig.projectId}/public/data/entidades`;
                    const q = query(collection(db, entitiesPath), where("status", "==", "ativo"));
                    const querySnapshot = await getDocs(q);
                    allEntities = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    renderSuperAdminHeader(allEntities);
                    loadingView.classList.add('hidden');
                    formView.classList.remove('hidden');

                } else if (userSession?.profile?.role === 'entidade' && userSession.profile.status === 'ativo') {
                    renderEntityHeader(userSession.profile);
                    loadingView.classList.add('hidden');
                    formView.classList.remove('hidden');
                } else {
                    alert('Acesso negado. Você precisa ser uma entidade aprovada para criar campanhas.');
                    window.location.href = 'index.html'; 
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        mediaUploadInput.addEventListener('change', (e) => {
            campaignMediaFiles = Array.from(e.target.files).slice(0, 5); // Limita a 5 arquivos
            mediaPreviewContainer.innerHTML = '';
            mediaPreviewContainer.classList.remove('hidden');

            campaignMediaFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'w-full h-24 object-cover rounded-md border';
                    mediaPreviewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        createCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('hidden');
            const user = auth.currentUser;
            if (!user) return;
            if (campaignMediaFiles.length === 0) {
                formError.textContent = 'Por favor, selecione pelo menos uma imagem para a campanha.';
                formError.classList.remove('hidden');
                return;
            }

            showLoadingButton(true);

            try {
                // 1. Determinar a informação da entidade
                let entityInfo;
                const entitySelector = document.getElementById('entity-selector');
                
                if (entitySelector) { // Modo Super Admin
                    const selectedId = entitySelector.value;
                    if (selectedId === 'app_faz_bem') {
                        entityInfo = { name: "App Faz Bem", uid: "app_faz_bem" };
                    } else {
                        const selectedEntity = allEntities.find(e => e.id === selectedId);
                        entityInfo = { name: selectedEntity.publicName, uid: selectedEntity.id };
                    }
                } else { // Modo Entidade
                    const userSession = await getCurrentUser();
                    entityInfo = { name: userSession.profile.publicName, uid: user.uid };
                }

                // 2. Upload das imagens
                const uploadPromises = campaignMediaFiles.map(file => {
                    const mediaFileName = `campaigns/${user.uid}_${Date.now()}_${file.name}`;
                    const mediaRef = ref(storage, mediaFileName);
                    return uploadBytes(mediaRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                });
                const imageUrls = await Promise.all(uploadPromises);

                // 3. Criação do documento da campanha
                const now = Timestamp.now();
                const durationInSeconds = parseInt(document.getElementById('campaign-duration').value, 10);
                const expiresAt = new Timestamp(now.seconds + durationInSeconds, now.nanoseconds);
                
                const newCampaign = {
                    title: document.getElementById('campaign-title').value,
                    description: document.getElementById('campaign-description').value,
                    type: document.getElementById('campaign-type').value,
                    goal: document.getElementById('campaign-goal').value || null,
                    progress: 0,
                    entityName: entityInfo.name,
                    creatorId: user.uid,
                    entityId: entityInfo.uid,
                    images: imageUrls,
                    address: {
                        street: document.getElementById('campaign-address').value || null,
                        mapLink: document.getElementById('campaign-map-link').value || null,
                    },
                    operation: {
                        hours: document.getElementById('campaign-hours').value || null,
                        requiredDocs: document.getElementById('campaign-docs').value || null,
                    },
                    status: 'active',
                    createdAt: now,
                    expiresAt: expiresAt,
                };

                const campaignsColPath = `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`;
                await addDoc(collection(db, campaignsColPath), newCampaign);
                
                document.getElementById('submit-feedback').textContent = 'Campanha publicada com sucesso!';
                createCampaignForm.reset();
                mediaPreviewContainer.innerHTML = '';

                setTimeout(() => {
                   window.location.href = user.email === ADMIN_EMAIL ? 'superadmin.html' : 'admin.html';
                }, 2000);

            } catch (error) {
                console.error("Erro ao criar campanha: ", error);
                formError.textContent = `Erro ao publicar: ${error.message}`;
                formError.classList.remove('hidden');
            } finally {
                showLoadingButton(false);
            }
        });
    </script>
</body>
</html>
