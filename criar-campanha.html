<!DOCTYPE html>
<html lang="pt-BR">
<head>
    </head>
<body class="bg-gray-100">
    <div id="app-container">
        <div id="form-view" class="hidden">
            <main class="max-w-5xl mx-auto py-8 px-4">
                <form id="create-campaign-form" class="bg-white p-8 rounded-xl shadow-lg" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-4">
                            </div>

                        <div class="space-y-4">
                             <div>
                                <label for="campaign-media-upload" class="block text-sm font-medium text-gray-700">Imagens da Campanha (até 5)</label>
                                <input type="file" id="campaign-media-upload" accept="image/jpeg, image/png, image/webp" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <p class="text-xs text-gray-500 mt-1">Modo Edição: Enviar novas imagens substituirá as antigas.</p>
                            </div>
                            <div id="media-preview-container" class="grid grid-cols-3 gap-2"></div>
                            
                            <div class="pt-4 border-t">
                                <label for="campaign-video-upload" class="block text-sm font-medium text-gray-700">Vídeo de Destaque (MP4, Opcional)</label>
                                <input type="file" id="campaign-video-upload" accept="video/mp4" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <div id="video-preview-container" class="mt-2 hidden">
                                    <video id="video-preview" class="w-full rounded-md border bg-gray-100" controls></video>
                                    <p id="video-file-name" class="text-sm text-gray-500 mt-1"></p>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t">
                                </div>
                        </div>
                    </div>
                    </form>
            </main>
        </div>
    </div>

    <script type="module">
        import { auth, db, storage, onAuthStateChanged, getCurrentUser, ADMIN_EMAIL, firebaseConfig } from './app-config.js';
        import { collection, addDoc, doc, getDoc, updateDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ... constantes do DOM ...
        const videoUploadInput = document.getElementById('campaign-video-upload');
        const videoPreviewContainer = document.getElementById('video-preview-container');
        const videoPreview = document.getElementById('video-preview');
        const videoFileName = document.getElementById('video-file-name');

        let campaignMediaFiles = [];
        let campaignVideoFile = null; // Nova variável para o vídeo
        // ...

        const populateForm = (data) => {
            // ... preenche outros campos ...
            if (data.images && data.images.length > 0) { renderMediaPreview(data.images); }
            if (data.videoUrl) {
                videoPreviewContainer.classList.remove('hidden');
                videoPreview.src = data.videoUrl;
                videoFileName.textContent = "Vídeo atual.";
            }
        };

        // ... onAuthStateChanged e initializePage ...

        mediaUploadInput.addEventListener('change', (e) => { /* ... código inalterado ... */ });
        
        // Novo event listener para o input de vídeo
        videoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                campaignVideoFile = null;
                videoPreviewContainer.classList.add('hidden');
                return;
            }
            campaignVideoFile = file;
            videoPreview.src = URL.createObjectURL(file);
            videoFileName.textContent = file.name;
            videoPreviewContainer.classList.remove('hidden');
        });

        createCampaignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // ...
            showLoadingButton(true);
            try {
                // Upload de imagens
                let imageUrls;
                if (campaignMediaFiles.length > 0) { /* ... */ }

                // Upload do vídeo (se houver)
                let videoUrl;
                if (campaignVideoFile) {
                    const videoRef = ref(storage, `campaigns/${auth.currentUser.uid}_${Date.now()}_${campaignVideoFile.name}`);
                    const snapshot = await uploadBytes(videoRef, campaignVideoFile);
                    videoUrl = await getDownloadURL(snapshot.ref);
                }

                const dataToSave = {
                    // ... outros dados ...
                    ...(imageUrls && { images: imageUrls }),
                    ...(videoUrl && { videoUrl: videoUrl }), // Adiciona videoUrl se existir
                };

                if (isEditMode) {
                    // Se não houver novo vídeo, não sobrescreve o campo
                    if (videoUrl === undefined) {
                       delete dataToSave.videoUrl;
                    }
                    // ...
                    await updateDoc(doc(db, campaignsColPath, campaignIdToEdit), dataToSave);
                } else {
                    const finalData = {
                        // ... outros dados da campanha ...
                        videoUrl: videoUrl || null,
                        // ...
                    };
                    await addDoc(collection(db, campaignsColPath), finalData);
                }
                
                // ... resto da lógica de sucesso ...
            } // ... catch e finally ...
        });
    </script>
</body>
</html>
