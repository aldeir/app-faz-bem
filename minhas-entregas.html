<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Minhas Doações / Entregas - Faz Bem</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#22c55e" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0f2917" media="(prefers-color-scheme: dark)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.png">
<link rel="icon" href="logo.png" type="image/png">
<link rel="preconnect" href="https://firestore.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="/app-faz-bem/style.css" rel="stylesheet">
<link href="mobile-enhancements.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<style>
body { font-family:'Inter',sans-serif; }
.loader { border:4px solid #f3f3f3;border-top:4px solid #22c55e;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}
@keyframes spin { to { transform:rotate(360deg);} }
.tab-button.active { border-color:#16a34a; color:#16a34a; background:#f0fdf4; }
.item-card { transition:.18s ease; }
.item-card:hover { transform:translateY(-2px); box-shadow:0 4px 14px -4px rgba(0,0,0,.08); }
.status-chip { font-size:.625rem; letter-spacing:.5px; text-transform:uppercase; font-weight:600; padding:2px 6px; border-radius:999px; }
.status-chip.scheduled { background:#f0fdf4; color:#166534; }
.status-chip.overdue { background:#fef2f2; color:#991b1b; }
.status-chip.cancelled { background:#fffbeb; color:#92400e; }
.status-chip.completed { background:#ecfdf5; color:#065f46; }
.status-chip.reagendado { background:#e0f2fe; color:#075985; }
.badge-small { font-size:.625rem; font-weight:600; padding:2px 6px; border-radius:6px; }
.qr-container img { width:100%; height:100%; object-fit:contain; }
.filter-pill { padding:.45rem .8rem; border-radius:999px; background:#f1f5f9; font-size:.75rem; font-weight:600; color:#475569; display:inline-flex; align-items:center; gap:.25rem; cursor:pointer; }
.filter-pill.active { background:#16a34a; color:#fff; }
#quick-filters::-webkit-scrollbar { display:none; }
#quick-filters { -ms-overflow-style:none; scrollbar-width:none; }
.skeleton-block { height:110px; border-radius:1rem; background:#f1f5f9; position:relative; overflow:hidden; }
.skeleton-block::after { content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.55),transparent); animation:skeleton 1.2s infinite; }
@keyframes skeleton { 0% {transform:translateX(-100%);} 100% {transform:translateX(100%);} }
.card-border-green { border-left:4px solid #16a34a; }
.card-border-red { border-left:4px solid #dc2626; }
.card-border-yellow { border-left:4px solid #d97706; }
.card-border-gray { border-left:4px solid #64748b; }
.card-border-blue { border-left:4px solid #2563eb; }
</style>
</head>
<body class="bg-gray-50">
<div id="global-aria-live" aria-live="polite" data-visually-hidden="true"></div>
<div id="app-header"></div>

<main id="page-content">
  <div id="loading-view" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
    <div class="text-center">
      <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
      <p class="mt-4 text-gray-600">Carregando suas doações...</p>
    </div>
  </div>

  <div id="deliveries-view" class="hidden container mx-auto max-w-4xl p-4 sm:p-6 my-8">
    <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Minhas Doações</h1>
        <p class="text-sm text-gray-500 mt-1" id="subtitle-helper">Gerencie seus agendamentos de entrega.</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="refresh-btn" class="hidden sm:inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6"/><path stroke-linecap="round" stroke-linejoin="round" d="M20 4l-5.172 5.172a4 4 0 00-5.656 0L4 14"/></svg>
          Atualizar
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-4">
      <nav id="tabs-container" class="-mb-px flex overflow-x-auto no-scrollbar space-x-6" aria-label="Tabs">
        <button data-tab="scheduled" class="tab-button active relative whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm focus:outline-none">Agendadas</button>
        <button data-tab="overdue" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Vencidas</button>
        <button data-tab="cancelled" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Canceladas</button>
        <button data-tab="history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
      </nav>
    </div>

    <!-- Quick filters (ex: próximo 7 dias) -->
    <div id="quick-filters" class="flex gap-2 overflow-x-auto pb-2 mb-4">
      <div class="filter-pill" data-filter="next7">Próx. 7 dias</div>
      <div class="filter-pill" data-filter="morning">Manhã</div>
      <div class="filter-pill" data-filter="afternoon">Tarde</div>
      <div class="filter-pill" data-filter="withImages">Com fotos</div>
      <div class="filter-pill" data-filter="withoutImages">Sem foto</div>
      <div class="filter-pill" data-filter="hasMultipleItems">Múltiplos Itens</div>
    </div>

    <!-- Search -->
    <div class="mb-6 flex items-center gap-3">
      <div class="flex-1 relative">
        <input id="search-input" type="search" placeholder="Buscar por campanha ou código..."
               class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm">
        <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      </div>
      <button id="clear-filters" class="text-xs font-semibold text-gray-500 hover:text-gray-700">Limpar</button>
    </div>

    <!-- Live status / offline -->
    <div id="live-status" class="hidden mb-4 text-xs font-medium text-blue-700 bg-blue-50 px-3 py-2 rounded-md flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> Atualização em tempo real
    </div>
    <div id="offline-banner" class="hidden mb-4 text-xs font-medium text-yellow-700 bg-yellow-50 px-3 py-2 rounded-md flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M3 12l9-9 9 9-9 9-9-9z"/></svg>
      Offline - exibindo dados em cache
    </div>

    <!-- List -->
    <div id="deliveries-list" class="space-y-8"></div>
    <p id="no-deliveries-placeholder" class="hidden text-center text-gray-500 py-10 bg-white rounded-lg shadow text-sm">Nenhuma doação encontrada para este conjunto de filtros.</p>

    <div id="load-more-container" class="text-center mt-8 hidden">
      <button id="load-more-btn" class="bg-gray-200 text-gray-800 font-semibold py-2.5 px-8 rounded-lg hover:bg-gray-300 transition-colors text-sm btn-touch">
        Carregar mais
      </button>
    </div>
  </div>
</main>

<!-- Modal base -->
<div id="app-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
    <div id="app-modal-content" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div id="modal-icon-wrapper" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h2 class="text-lg leading-6 font-semibold text-gray-900" id="modal-title"></h2>
            <div class="mt-2">
              <div id="modal-message-body" class="text-sm text-gray-600 space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="modal-buttons" class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container" id="toast-container"></div>

<!-- FAB mobile -->
<div class="fab-bar" id="fab-bar" style="display:none;">
  <button id="fab-scroll-top" class="bg-blue-600 text-white">Topo</button>
  <button id="fab-refresh" class="bg-green-600 text-white">Atualizar</button>
</div>

<script type="module">
/* Imports */
import { db, paths } from './app-config.js';
import { collection, query, where, onSnapshot, doc, getDoc } from './firebase-services.js';
import { injectHeader } from './app-header.js';
import { getCurrentUser } from './auth-service.js';
import { showDetailsModal, showConfirmationModal } from './modal-handler.js';
import { createNotification } from './notification-service.js';

/* State */
let loadingView, deliveriesView, deliveriesList, noDeliveriesPlaceholder;
let tabsContainer, loadMoreContainer, loadMoreBtn, searchInput, quickFiltersContainer;
let liveStatusEl, offlineBanner, refreshBtn;
let allUserDonations = [];
let filteredWorkingList = [];
let campaignsCache = new Map();
let campaignTypeSettings = {};
let currentPage = 1;
const DONATIONS_PER_PAGE = 6;
let activeExtraFilters = new Set();
let searchQuery = '';
let currentUserId = null;
let unsubscribeSnapshot = null;
let intersectionObserver = null;
const DEBUG = new URLSearchParams(location.search).has('debug');

/* Utility / helpers */
function showToast(message, type='success', ttl=3500){
  const c=document.getElementById('toast-container');
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span>${message}</span>`;
  c.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, ttl);
}
window.addEventListener('message',(e)=>{
  if(e.data?.type==='toast'){ showToast(e.data.message, e.data.status==='success'?'success':'error'); }
});

function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function formatDateTime(ts){
  if(!ts?.toDate) return { date:'--', time:'--' };
  const d=ts.toDate();
  return {
    date: d.toLocaleDateString('pt-BR',{ day:'2-digit', month:'long'}),
    time: d.toLocaleTimeString('pt-BR',{ hour:'2-digit', minute:'2-digit'})
  };
}
function isOverdue(donation){
  if(!donation.scheduledAt?.toDate) return false;
  return donation.status==='scheduled' && donation.scheduledAt.toDate() < new Date();
}
function computeItemGroupStatus(donation){
  if(donation.status==='reagendado') return 'reagendado';
  if(donation.status==='cancelled_by_entity') return 'cancelled';
  if(donation.status==='cancelled_by_user') return 'cancelled';
  if(donation.status==='scheduled'){
    if(isOverdue(donation)) return 'overdue';
    return 'scheduled';
  }
  const allCompleted = Array.isArray(donation.items) && donation.items.length>0 && donation.items.every(i=>i.status==='completed');
  if(donation.status==='completed' || allCompleted) return 'completed';
  return donation.status || 'unknown';
}
function statusChipClass(status){
  switch(status){
    case 'scheduled': return 'scheduled';
    case 'overdue': return 'overdue';
    case 'cancelled':
    case 'cancelled_by_entity':
    case 'cancelled_by_user': return 'cancelled';
    case 'completed': return 'completed';
    case 'reagendado': return 'reagendado';
    default: return 'scheduled';
  }
}
function cardBorderClass(status){
  switch(status){
    case 'overdue': return 'card-border-red';
    case 'cancelled': return 'card-border-yellow';
    case 'completed': return 'card-border-green';
    case 'reagendado': return 'card-border-blue';
    default: return 'card-border-green';
  }
}
function openAppModal({title, bodyHtml, buttons=[], iconHtml=null}){
  const modal=document.getElementById('app-modal');
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-message-body').innerHTML=bodyHtml;
  const btns=document.getElementById('modal-buttons');
  btns.innerHTML='';
  buttons.forEach(b=>{
    const el=document.createElement('button');
    el.type='button';
    el.className=b.className || 'mt-3 w-full inline-flex justify-center rounded-md bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 sm:ml-3 sm:w-auto';
    el.textContent=b.label;
    el.addEventListener('click',()=>b.onClick?.(()=>closeAppModal()));
    btns.appendChild(el);
  });
  if(iconHtml){
    document.getElementById('modal-icon-wrapper').innerHTML=iconHtml;
  }
  modal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  setTimeout(()=>document.getElementById('modal-title').focus(),30);
}
function closeAppModal(){
  const modal=document.getElementById('app-modal');
  modal.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') closeAppModal();
});
/* Accessibility live region */
function announce(msg){
  const reg=document.getElementById('global-aria-live');
  if(reg){ reg.textContent=''; setTimeout(()=>reg.textContent=msg,50); }
}

/* Offline detection */
function updateOnlineStatus(){
  const offlineBanner=document.getElementById('offline-banner');
  if(!navigator.onLine){
    offlineBanner.classList.remove('hidden');
    announce('Sem conexão. Alguns dados podem estar desatualizados.');
  } else {
    offlineBanner.classList.add('hidden');
  }
}
window.addEventListener('online',updateOnlineStatus);
window.addEventListener('offline',updateOnlineStatus);

/* FAB */
function toggleFab(){
  const fab=document.getElementById('fab-bar');
  if(window.innerWidth<=640){
    fab.style.display='flex';
    document.body.classList.add('has-fab-bottom-padding');
  } else {
    fab.style.display='none';
    document.body.classList.remove('has-fab-bottom-padding');
  }
}

/* QR Code generation deferred */
function generateQRCode(elementId, text){
  const el=document.getElementById(elementId);
  if(!el) return;
  try{
    const qr=qrcode(0,'L');
    qr.addData(text);
    qr.make();
    el.innerHTML=qr.createImgTag(4,4);
  }catch(err){
    console.error('Erro QR', elementId, err);
    el.innerHTML='<p class="text-xs text-red-500">QR erro</p>';
  }
}

/* Details builder */
function generateItemDetailsHtml(item, campaignType){
  let detailsHtml='<div class="space-y-1">';
  const cfgRaw = campaignTypeSettings[campaignType]?.fields;
  const fields= Array.isArray(cfgRaw) ? cfgRaw : Object.values(cfgRaw||{});
  let has=false;
  fields
    .filter(f=>f && f.id && f.active!==false)
    .sort((a,b)=>(a.order||0)-(b.order||0))
    .forEach(field=>{
      const key=field.id;
      if(!key) return;
      const value=item[key];
      const isMediaField = ['image','camera','video'].includes(field.type);
      if(value && key!=='type' && key!=='photoURL' && !isMediaField){
        has=true;
        detailsHtml+=`<p><span class="text-gray-500">${field.label}:</span> <span class="font-medium text-gray-800">${value}</span></p>`;
      }
    });
  if(!has) detailsHtml+='<p class="text-gray-400 text-xs">Sem detalhes adicionais.</p>';
  detailsHtml+='</div>';
  return detailsHtml;
}

/* Filter pipeline */
function applyFilters(baseList){
  let list=[...baseList];
  // search
  if(searchQuery){
    const q=searchQuery.toLowerCase();
    list=list.filter(d=>{
      const ct = (d.campaignTitle||'').toLowerCase();
      const codes = (d.items||[]).some(i=> (i.uniqueCode||'').toLowerCase().includes(q));
      return ct.includes(q) || codes;
    });
  }
  // quick filters
  activeExtraFilters.forEach(f=>{
    switch(f){
      case 'next7':
        const limit=new Date();
        limit.setDate(limit.getDate()+7);
        list=list.filter(d=>d.scheduledAt?.toDate && d.scheduledAt.toDate() <= limit && d.scheduledAt.toDate()> new Date());
        break;
      case 'morning':
        list=list.filter(d=>{
          if(!d.scheduledAt?.toDate) return false;
            const h=d.scheduledAt.toDate().getHours();
          return h>=6 && h<12;
        });
        break;
      case 'afternoon':
        list=list.filter(d=>{
          if(!d.scheduledAt?.toDate) return false;
          const h=d.scheduledAt.toDate().getHours();
          return h>=12 && h<19;
        });
        break;
      case 'withImages':
        list=list.filter(d=> (d.items||[]).some(i=>i.photoURL));
        break;
      case 'withoutImages':
        list=list.filter(d=> (d.items||[]).every(i=>!i.photoURL));
        break;
      case 'hasMultipleItems':
        list=list.filter(d=>(d.items||[]).length>1);
        break;
    }
  });
  return list;
}

/* Tab filter */
function filterByTab(list, tab){
  const now=new Date();
  switch(tab){
    case 'scheduled':
      return list.filter(d=>{
        if(d.status!=='scheduled') return false;
        if(!d.scheduledAt?.toDate) return false;
        if(d.scheduledAt.toDate()<now) return false;
        if(!Array.isArray(d.items) || !d.items.some(i=>i.status!=='completed')) return false;
        return true;
      });
    case 'overdue':
      return list.filter(d=>{
        if(d.status!=='scheduled') return false;
        if(!d.scheduledAt?.toDate) return false;
        if(d.scheduledAt.toDate()>=now) return false;
        if(!Array.isArray(d.items) || !d.items.some(i=>i.status!=='completed')) return false;
        return true;
      });
    case 'cancelled':
      return list.filter(d=> d.status==='cancelled_by_entity' || d.status==='cancelled_by_user');
    case 'history':
      return list.filter(d=>{
        const finalStatuses=['completed','reagendado','cancelled_by_user','cancelled_by_entity'];
        const allItemsDone=Array.isArray(d.items)&&d.items.length>0&&d.items.every(i=>i.status==='completed');
        return finalStatuses.includes(d.status) || allItemsDone;
      });
    default:
      return list;
  }
}

/* Pagination & rendering */
function renderActiveTabData(append=false){
  const activeTab = tabsContainer.querySelector('.tab-button.active')?.dataset.tab || 'scheduled';
  if(!append){
    deliveriesList.innerHTML='';
    currentPage=1;
  }
  // pipeline
  const base = allUserDonations.filter(d=> d.donorId===currentUserId);
  const withTab = filterByTab(base, activeTab);
  filteredWorkingList = applyFilters(withTab).sort((a,b)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0));

  if(filteredWorkingList.length===0){
    noDeliveriesPlaceholder.classList.remove('hidden');
    loadMoreContainer.classList.add('hidden');
    if(!append) deliveriesList.innerHTML='';
    return;
  } else {
    noDeliveriesPlaceholder.classList.add('hidden');
  }

  const startIndex = (currentPage-1)*DONATIONS_PER_PAGE;
  const endIndex = startIndex + DONATIONS_PER_PAGE;
  const slice = filteredWorkingList.slice(startIndex, endIndex);

  slice.forEach(donation=>{
    const campaign = campaignsCache.get(donation.campaignId);
    const card = createDonationCard(donation, campaign, activeTab);
    if(card) deliveriesList.appendChild(card);
  });

  if(filteredWorkingList.length > endIndex){
    loadMoreContainer.classList.remove('hidden');
  } else {
    loadMoreContainer.classList.add('hidden');
  }

  hydrateQRCodesDeferred();
  announce(`${filteredWorkingList.length} doações encontradas`);
}

function hydrateQRCodesDeferred(){
  if(intersectionObserver) intersectionObserver.disconnect();
  intersectionObserver = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting){
        const el=ent.target;
        const code=el.dataset.qr;
        const target=el.id;
        if(code && target){
          generateQRCode(target, code);
          intersectionObserver.unobserve(el);
        }
      }
    });
  },{
    root:null,
    rootMargin:'50px',
    threshold:0.1
  });
  qsa('[data-qr]').forEach(el=>intersectionObserver.observe(el));
}

/* Card creation */
function createDonationCard(donation, campaign, tab){
  const items = (donation.items||[]);
  // Filter items for scheduled/overdue (hide completed)
  const itemsToDisplay = (tab==='scheduled'||tab==='overdue')
    ? items.filter(i=>i.status!=='completed')
    : items;

  if(itemsToDisplay.length===0 && (tab==='scheduled'||tab==='overdue')) return null;

  const groupStatus = computeItemGroupStatus(donation);
  const borderClass = cardBorderClass(groupStatus);
  const {date, time} = formatDateTime(donation.scheduledAt);
  const campaignType = campaign?.type || 'default';
  const typeSettings = campaignTypeSettings[campaignType] || {};
  const typeColor = typeSettings.color || 'gray';
  const chips = `<span class="status-chip ${statusChipClass(groupStatus)}">${groupStatus.replace('_',' ')}</span>`;
  const itemsCount = itemsToDisplay.length;
  const multipleBadge = itemsCount>1 ? `<span class="ml-2 badge-small bg-${typeColor}-100 text-${typeColor}-700">${itemsCount} itens</span>` : '';

  const canReschedule = (groupStatus==='overdue' || groupStatus==='cancelled') &&
                        campaign && campaign.expiresAt?.toDate && campaign.expiresAt.toDate()> new Date() &&
                        !alreadyRescheduled(donation);

  let headerHTML='';
  if(tab==='scheduled'){
    headerHTML=`<div class="p-4 sm:p-5 bg-green-50 flex flex-col gap-1">
      <div class="flex flex-wrap items-center gap-3">
        <h2 class="text-lg font-bold text-green-800">${donation.campaignTitle}</h2>
        ${chips} ${multipleBadge}
      </div>
      <p class="text-sm text-green-700">Agendado para <strong>${date}</strong> às <strong>${time}</strong></p>
    </div>`;
  } else if(tab==='overdue'){
    headerHTML=`<div class="p-4 sm:p-5 bg-red-50 flex flex-col gap-2">
      <div class="flex flex-wrap items-center gap-3">
        <h2 class="text-lg font-bold text-red-800">${donation.campaignTitle}</h2>
        ${chips} ${multipleBadge}
      </div>
      <p class="text-sm text-red-700 font-medium">Entrega marcada para ${date} às ${time} não foi realizada.</p>
      ${canReschedule ? `<button class="text-xs font-semibold inline-flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" data-action="reschedule" data-id="${donation.id}">
          Reagendar
        </button>` :
        `<span class="text-[11px] font-semibold text-gray-500 bg-gray-200 rounded px-2 py-1 inline-block">
          ${alreadyRescheduled(donation)?'Reagendada':'Campanha encerrada'}
        </span>`}
    </div>`;
  } else if(tab==='cancelled'){
    headerHTML=`<div class="p-4 sm:p-5 bg-yellow-50 flex flex-col gap-2">
      <div class="flex flex-wrap items-center gap-3">
        <h2 class="text-lg font-bold text-yellow-800">${donation.campaignTitle}</h2>
        ${chips} ${multipleBadge}
      </div>
      <p class="text-sm text-yellow-700 font-medium">Agendamento cancelado pela entidade.</p>
      ${canReschedule ? `<button class="text-xs font-semibold inline-flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" data-action="reschedule" data-id="${donation.id}">
          Reagendar
        </button>` :
        `<span class="text-[11px] font-semibold text-gray-500 bg-gray-200 rounded px-2 py-1 inline-block">
          ${alreadyRescheduled(donation)?'Reagendada':'Campanha encerrada'}
        </span>`}
    </div>`;
  } else {
    let histStatus='Não entregue';
    if(groupStatus==='completed') histStatus='Entregue com sucesso';
    else if(groupStatus==='reagendado') histStatus='Reagendada';
    headerHTML=`<div class="p-4 sm:p-5 bg-gray-100 flex flex-col gap-1">
      <div class="flex flex-wrap items-center gap-3">
        <h2 class="text-lg font-bold text-gray-800">${donation.campaignTitle}</h2>
        ${chips} ${multipleBadge}
      </div>
      <p class="text-xs text-gray-600">Status final: ${histStatus}</p>
    </div>`;
  }

  const addressHTML = campaign?.deliveryAddress
    ? `<div class="p-4 border-t">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a 2 2 0 01-2.828 0L6.343 16.657a 8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a 3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <div class="text-xs leading-5">
            <p class="font-semibold text-gray-700">Local de Entrega</p>
            <p class="text-gray-600">
              ${campaign.deliveryAddress.logradouro||''}, ${campaign.deliveryAddress.numero||'S/N'} - ${campaign.deliveryAddress.bairro||''}<br>
              ${campaign.deliveryAddress.cidade||''} - ${campaign.deliveryAddress.estado||''} CEP: ${campaign.deliveryAddress.cep||''}
              ${campaign.deliveryAddress.complemento ? `<br>Compl.: ${campaign.deliveryAddress.complemento}`:''}
              ${campaign.deliveryAddress.telefone ? `<br>Contato: ${campaign.deliveryAddress.telefone}`:''}
            </p>
          </div>
        </div>
      </div>` : '';

  const itemsHTML = itemsToDisplay.map((item, idx)=>{
    const itemIndex = donation.items.indexOf(item);
    const details = generateItemDetailsHtml(item, campaignType);
    const isCompleted = item.status==='completed';
    const qrPlaceholder = isCompleted
      ? `<div class="flex items-center justify-center w-20 h-20"><span class="text-xs font-semibold text-green-600">Entregue</span></div>`
      : `<div id="qr-${donation.id}-${itemIndex}" class="qr-container w-20 h-20" data-qr="${donation.id}|${itemIndex}"></div>`;
    return `<div class="item-card flex items-start gap-4 p-3 bg-gray-50 rounded-lg border group hover:bg-white cursor-pointer"
                data-action="open-item" data-donation-id="${donation.id}" data-item-index="${itemIndex}">
              <img src="${item.photoURL || 'https://placehold.co/64x64/e2e8f0/cbd5e0?text=Item'}"
                   class="w-16 h-16 rounded-md object-cover flex-shrink-0 border">
              <div class="flex-1 space-y-1">
                <p class="font-bold text-sm text-gray-800 flex items-center gap-2">
                  ${item.type || 'Item'} 
                  ${item.uniqueCode ? `<span class="badge-small bg-gray-800 text-white font-mono">${item.uniqueCode}</span>`:''}
                </p>
                <div class="text-xs">${details}</div>
              </div>
              ${qrPlaceholder}
            </div>`;
  }).join('');

  const wrapper=document.createElement('div');
  wrapper.className=`bg-white rounded-xl shadow-lg overflow-hidden border ${borderClass}`;
  wrapper.innerHTML=`
    ${headerHTML}
    <div class="p-4 sm:p-6">
      <h3 class="font-semibold text-gray-800 mb-3 text-sm">Itens da Doação</h3>
      <div class="space-y-3">${itemsHTML}</div>
    </div>
    ${addressHTML}
  `;
  return wrapper;
}

function alreadyRescheduled(donation){
  // Heurística: status 'reagendado' marca o antigo
  return donation.status==='reagendado';
}

/* Delegated events */
function setupDelegation(){
  deliveriesList.addEventListener('click', async (e)=>{
    const el=e.target.closest('[data-action]');
    if(!el) return;
    const action=el.dataset.action;
    if(action==='open-item'){
      const donationId=el.dataset.donationId;
      const itemIndex=parseInt(el.dataset.itemIndex,10);
      const donation=allUserDonations.find(d=>d.id===donationId);
      if(!donation) return;
      const item=donation.items[itemIndex];
      const campaign=campaignsCache.get(donation.campaignId);
      const details=generateItemDetailsHtml(item, campaign?.type || 'default');
      const modalHtml=`
        <div class="space-y-4">
          <div class="text-center">
            <img src="${item.photoURL || 'https://placehold.co/400x240/e2e8f0/cbd5e0?text=Sem+Imagem'}" class="w-full max-h-60 object-contain rounded-md bg-gray-100">
            <p class="mt-2 text-xs text-gray-500">Campanha: ${donation.campaignTitle}</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg border text-xs space-y-2">${details}</div>
          <div class="text-center">
            <div id="modal-item-qrcode" class="mx-auto w-40 h-40"></div>
            ${item.uniqueCode ? `<p class="mt-2 font-mono text-xs text-gray-600">${item.uniqueCode}</p>`:''}
            <p class="text-[11px] text-gray-500 mt-1">Apresente este QR Code para confirmação.</p>
          </div>
        </div>`;
      showDetailsModal(item.type || 'Detalhes do Item', modalHtml);
      setTimeout(()=> generateQRCode('modal-item-qrcode', `${donationId}|${itemIndex}`),60);
    } else if(action==='reschedule'){
      const donationId=el.dataset.id;
      const donation=allUserDonations.find(d=>d.id===donationId);
      if(!donation) return;
      // guarda dados para reagendamento
      localStorage.setItem('rescheduleData', JSON.stringify({
        oldDonationId: donationId,
        campaignId: donation.campaignId,
        items: donation.items,
        privacy: donation.privacy || 'public'
      }));
      window.location.href=`registrar-doacao.html?id=${donation.campaignId}&reschedule=true`;
    }
  });

  tabsContainer.addEventListener('click', (e)=>{
    const btn=e.target.closest('.tab-button');
    if(!btn) return;
    tabsContainer.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentPage=1;
    renderActiveTabData(false);
  });

  quickFiltersContainer.addEventListener('click',(e)=>{
    const pill=e.target.closest('.filter-pill');
    if(!pill) return;
    const filter=pill.dataset.filter;
    if(activeExtraFilters.has(filter)) activeExtraFilters.delete(filter);
    else activeExtraFilters.add(filter);
    pill.classList.toggle('active');
    renderActiveTabData(false);
  });
}

/* Search & filter events */
function setupUIEvents(){
  searchInput.addEventListener('input',()=>{
    searchQuery = searchInput.value.trim();
    renderActiveTabData(false);
  });
  document.getElementById('clear-filters').addEventListener('click',()=>{
    activeExtraFilters.clear();
    qsa('.filter-pill.active').forEach(p=>p.classList.remove('active'));
    searchQuery='';
    searchInput.value='';
    renderActiveTabData(false);
  });
  loadMoreBtn.addEventListener('click',()=>{
    currentPage++;
    renderActiveTabData(true);
  });
  refreshBtn.addEventListener('click',()=>{
    showToast('Atualizando...', 'success', 1200);
    // Snapshot já atualizado em tempo real, apenas re-render
    renderActiveTabData(false);
  });
  document.getElementById('fab-scroll-top').addEventListener('click',()=> window.scrollTo({top:0,behavior:'smooth'}));
  document.getElementById('fab-refresh').addEventListener('click',()=> refreshBtn.click());
}

/* Data loading */
async function loadCampaignTypes(){
  const snap = await getDoc(doc(db, paths.configDoc('campaignTypes')));
  campaignTypeSettings = snap.exists()? snap.data(): {};
}

function listenUserDonations(){
  if(unsubscribeSnapshot) unsubscribeSnapshot();
  const qRef=query(collection(db, paths.donations), where("donorId","==",currentUserId));
  unsubscribeSnapshot = onSnapshot(qRef, async (snapshot)=>{
    allUserDonations = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
    await cacheCampaigns(allUserDonations.map(d=>d.campaignId));
    renderActiveTabData(false);
    liveStatusEl.classList.remove('hidden');
    setTimeout(()=>liveStatusEl.classList.add('hidden'), 3500);
  }, err=>{
    console.error('Erro snapshot', err);
    showToast('Erro em tempo real','error');
  });
}

async function cacheCampaigns(ids){
  const unique=[...new Set(ids.filter(Boolean))];
  for(const id of unique){
    if(!campaignsCache.has(id)){
      try{
        const snap=await getDoc(doc(db, paths.campaignDoc(id)));
        if(snap.exists()){
          campaignsCache.set(id, { id:snap.id, ...snap.data() });
        }
      }catch(e){
        console.warn('Falha ao obter campanha', id, e);
      }
    }
  }
}

/* Initialization */
function initSkeleton(){
  const skeletonWrap=document.createElement('div');
  skeletonWrap.className='space-y-4';
  for(let i=0;i<3;i++){
    const sk=document.createElement('div');
    sk.className='skeleton-block';
    skeletonWrap.appendChild(sk);
  }
  loadingView.innerHTML='';
  loadingView.appendChild(skeletonWrap);
}

async function initializeApp(){
  const canProceed = await injectHeader();
  if(!canProceed) return;
  const userSession = await getCurrentUser();
  if(!userSession){
    window.location.href='login.html';
    return;
  }
  currentUserId = userSession.auth.uid;
  await loadCampaignTypes();
  listenUserDonations();
  updateOnlineStatus();
  toggleFab();
  window.addEventListener('resize', toggleFab);
  deliveriesView.classList.remove('hidden');
  loadingView.classList.add('hidden');
}

/* DOM ready */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Cache DOM
  loadingView = qs('#loading-view');
  deliveriesView = qs('#deliveries-view');
  deliveriesList = qs('#deliveries-list');
  noDeliveriesPlaceholder = qs('#no-deliveries-placeholder');
  tabsContainer = qs('#tabs-container');
  loadMoreContainer = qs('#load-more-container');
  loadMoreBtn = qs('#load-more-btn');
  searchInput = qs('#search-input');
  quickFiltersContainer = qs('#quick-filters');
  liveStatusEl = qs('#live-status');
  offlineBanner = qs('#offline-banner');
  refreshBtn = qs('#refresh-btn');

  initSkeleton();
  setupDelegation();
  setupUIEvents();
  await initializeApp();
});

/* Public function showDetailsModal already used */
if('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(console.error);
</script>
</body>
</html>
