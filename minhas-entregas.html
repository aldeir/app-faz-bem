<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Entregas - Faz Bem</title>
    
    <meta name="theme-color" content="#22c55e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="/app-faz-bem/images/icons/icon-192x192.png">
    <link rel="icon" href="/app-faz-bem/images/icons/icon-72x72.png" type="image/png">

    <link href="/app-faz-bem/style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #22c55e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .item-card:hover { transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-button.active { border-color: #16a34a; color: #16a34a; background-color: #f0fdf4; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-header"></div>

    <main id="page-content">
        <div id="loading-view" class="min-h-[calc(100vh-80px)] flex items-center justify-center">
            <div class="text-center">
                <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
                <p class="mt-4 text-gray-600">A carregar suas entregas...</p>
            </div>
        </div>

        <div id="deliveries-view" class="hidden container mx-auto max-w-4xl p-4 sm:p-6 my-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Minhas Doações</h1>
            
            <div class="border-b border-gray-200 mb-6">
                <nav id="tabs-container" class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-tab="scheduled" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Agendadas</button>
                    <button data-tab="overdue" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Vencidas</button>
                    <button data-tab="cancelled" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Canceladas</button>
                    <button data-tab="history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                </nav>
            </div>
            
            <div id="deliveries-list" class="space-y-8"></div>
            <p id="no-deliveries-placeholder" class="hidden text-center text-gray-500 py-10 bg-white rounded-lg shadow">Nenhuma doação encontrada para esta categoria.</p>
            
            <div id="load-more-container" class="text-center mt-8 hidden">
                <button id="load-more-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">Carregar Mais</button>
            </div>
        </div>
    </main>

    <div id="app-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                            <div class="mt-2"><div class="text-sm text-gray-600 space-y-2" id="modal-message-body"></div></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse" id="modal-buttons"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, paths } from './app-config.js';
        import { collection, query, where, onSnapshot, doc, getDoc } from "./firebase-services.js";
        import { injectHeader } from './app-header.js';
        import { getCurrentUser } from './auth-service.js';
        import { showDetailsModal } from './modal-handler.js';

        const loadingView = document.getElementById('loading-view');
        const deliveriesView = document.getElementById('deliveries-view');
        const deliveriesList = document.getElementById('deliveries-list');
        const noDeliveriesPlaceholder = document.getElementById('no-deliveries-placeholder');
        const tabsContainer = document.getElementById('tabs-container');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');

        let allUserDonations = [];
        let campaignsCache = new Map();
        let campaignTypeSettings = {};

        // Utility functions for dynamic field rendering and border classes
        function asDate(v) {
            try { return v?.toDate ? v.toDate() : v ? new Date(v) : null; } catch { return null; }
        }

        // Tailwind-safe border mapping
        const BORDER_COLOR_MAP = {
            green: 'border-green-500',
            blue: 'border-blue-500',
            yellow: 'border-yellow-500',
            red: 'border-red-500',
            purple: 'border-purple-500',
            gray: 'border-gray-500',
            default: 'border-gray-500'
        };
        function getBorderClass(typeConfig) {
            return BORDER_COLOR_MAP[typeConfig?.color] || BORDER_COLOR_MAP.default;
        }

        // Dynamic fields normalization and rendering
        function normalizeFieldsConfig(campaignType, campaignTypeSettings) {
            const cfg = campaignTypeSettings?.[campaignType];
            const fieldsRaw = Array.isArray(cfg?.fields) ? cfg.fields : Object.values(cfg?.fields || {});
            return fieldsRaw.map(f => ({
                id: f.id || f.key || f.name,
                label: f.label || f.title || f.name || f.id || f.key,
                type: f.type || 'text',
                options: f.options || f.choices || f.values || []
            })).filter(f => f.id && !['type','photoURL'].includes(f.id));
        }

        function resolveFieldValue(field, raw) {
            if (raw === null || raw === undefined || raw === '') return null;
            if (Array.isArray(raw)) return raw.map(v => resolveFieldValue(field, v)).filter(Boolean).join(', ');
            if (typeof raw === 'boolean') return raw ? 'Sim' : 'Não';
            if (['select','radio','dropdown'].includes(field.type)) {
                const opts = field.options || [];
                const m = opts.find(o => String(o.value ?? o.id ?? o.key ?? o.code ?? o.label) === String(raw));
                return m ? (m.label ?? m.name ?? String(raw)) : String(raw);
            }
            if (field.type === 'date' || field.type === 'datetime') {
                const d = asDate(raw);
                return d && !isNaN(d) ? d.toLocaleString('pt-BR') : String(raw);
            }
            return String(raw);
        }

        function generateItemDetailsHtml(item, campaignType, campaignTypeSettings) {
            const fields = normalizeFieldsConfig(campaignType, campaignTypeSettings)
                .filter(f => !['image','camera','video'].includes(f.type));
            let hasVisible = false;
            const lines = fields.map(f => {
                const v = resolveFieldValue(f, item?.[f.id]);
                if (v === null || v === '') return '';
                hasVisible = true;
                return `<p><strong class="font-semibold">${f.label}:</strong> ${v}</p>`;
            }).filter(Boolean);
            if (!hasVisible) lines.push('<p>Nenhum detalhe adicional.</p>');
            return `<div class="space-y-1">${lines.join('')}</div>`;
        }
        let currentPage = 1;
        const DONATIONS_PER_PAGE = 5;

        async function initializeApp() {
            const canProceed = await injectHeader();
            if (!canProceed) { return; }

            const userSession = await getCurrentUser();
            if (userSession) {
                const typesSnap = await getDoc(doc(db, paths.configDoc('campaignTypes')));
                campaignTypeSettings = typesSnap.exists() ? typesSnap.data() : {};
                loadUserDeliveries(userSession.auth.uid);
            } else {
                window.location.href = 'login.html';
            }
        }

        function loadUserDeliveries(userId) {
            const q = query(collection(db, paths.donations), where("donorId", "==", userId));
            onSnapshot(q, async (snapshot) => {
                allUserDonations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const campaignIds = [...new Set(allUserDonations.map(d => d.campaignId))];
                for (const id of campaignIds) {
                    if (!campaignsCache.has(id)) {
                        const campaignRef = doc(db, paths.campaignDoc(id));
                        const campaignSnap = await getDoc(campaignRef);
                        if (campaignSnap.exists()) {
                            campaignsCache.set(id, { id: campaignSnap.id, ...campaignSnap.data() });
                        }
                    }
                }
                
                currentPage = 1;
                renderActiveTabData();
                loadingView.classList.add('hidden');
                deliveriesView.classList.remove('hidden');
            });
        }

        function renderActiveTabData(append = false) {
            if (!append) {
                deliveriesList.innerHTML = '';
            }

            const activeTab = tabsContainer.querySelector('.tab-button.active').dataset.tab;
            const now = new Date();
            let filteredDonations = [];

            try {
                if (activeTab === 'scheduled') {
                    filteredDonations = allUserDonations.filter(d => 
                        d.status === 'scheduled' && 
                        d.scheduledAt?.toDate() >= now &&
                        Array.isArray(d.items) && d.items.some(item => item.status !== 'completed')
                    );
                } else if (activeTab === 'overdue') {
                    filteredDonations = allUserDonations.filter(d => 
                        d.status === 'scheduled' && 
                        d.scheduledAt?.toDate() < now &&
                        Array.isArray(d.items) && d.items.some(item => item.status !== 'completed')
                    );
                } else if (activeTab === 'cancelled') {
                    filteredDonations = allUserDonations.filter(d => d.status === 'cancelled_by_entity');
                } else if (activeTab === 'history') {
                    filteredDonations = allUserDonations.filter(d => {
                        const isFinalStatus = ['completed', 'reagendado', 'cancelled_by_user'].includes(d.status);
                        const allItemsDone = Array.isArray(d.items) && d.items.every(item => item.status === 'completed');
                        return isFinalStatus || allItemsDone;
                    });
                }
            } catch (error) {
                console.error("Erro ao filtrar doações:", error);
                loadingView.classList.add('hidden');
                deliveriesView.classList.remove('hidden');
                deliveriesList.innerHTML = `<p class="text-red-500 text-center p-4">Ocorreu um erro ao processar os dados das doações.</p>`;
                return;
            }

            filteredDonations.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            
            if (filteredDonations.length === 0 && !append) {
                noDeliveriesPlaceholder.classList.remove('hidden');
                loadMoreContainer.classList.add('hidden');
                deliveriesList.innerHTML = '';
                return;
            }

            noDeliveriesPlaceholder.classList.add('hidden');

            const startIndex = (currentPage - 1) * DONATIONS_PER_PAGE;
            const endIndex = startIndex + DONATIONS_PER_PAGE;
            const donationsToRender = filteredDonations.slice(startIndex, endIndex);

            donationsToRender.forEach(donation => {
                const campaign = campaignsCache.get(donation.campaignId);
                const card = createDeliveryCard(donation, campaign, activeTab);
                if (card) {
                    deliveriesList.appendChild(card);
                }
            });

            if (filteredDonations.length > endIndex) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }
        
        function createDeliveryCard(donation, campaign, tab) {
            const itemsToDisplay = (donation.items || []).filter(item => {
                if ((tab === 'scheduled' || tab === 'overdue') && item.status === 'completed') {
                    return false;
                }
                return true;
            });

            if (itemsToDisplay.length === 0 && (tab === 'scheduled' || tab === 'overdue')) {
                return null;
            }

            const card = document.createElement('div');
            const campaignType = campaign?.type || 'default';
            const typeSettings = campaignTypeSettings[campaignType] || { color: 'gray' };
            const borderColorClass = getBorderClass(typeSettings);
            card.className = `bg-white rounded-xl shadow-lg overflow-hidden border-l-4 ${borderColorClass}`;

            const scheduledDate = asDate(donation.scheduledAt);
            const formattedDate = scheduledDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });
            const formattedTime = scheduledDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            let headerHtml = '';
            const now = new Date();
            const isCampaignActive = campaign && campaign.expiresAt.toDate() > now;
            
            const photoURLsInThisDonation = new Set(donation.items.map(item => item.photoURL).filter(Boolean));
            const hasBeenRescheduled = allUserDonations.some(d => 
                d.status === 'reagendado' &&
                Array.isArray(d.items) && d.items.some(item => photoURLsInThisDonation.has(item.photoURL))
            );

            switch(tab) {
                case 'scheduled':
                    headerHtml = `<div class="bg-green-50 p-6">
                                    <h2 class="text-2xl font-bold text-green-800">${donation.campaignTitle}</h2>
                                    <p class="mt-1 text-green-700">Agendado para: <span class="font-semibold">${formattedDate} às ${formattedTime}</span></p>
                                  </div>`;
                    break;
                case 'overdue':
                    const rescheduleBtn = (isCampaignActive && !hasBeenRescheduled)
                        ? `<button data-action="reschedule" data-donation-id="${donation.id}" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Reagendar Entrega</button>`
                        : (hasBeenRescheduled ? `<p class="mt-4 text-sm font-semibold text-gray-600 bg-gray-200 px-4 py-2 rounded-lg inline-block">Reagendamento já utilizado</p>` : `<p class="mt-4 text-sm font-semibold text-gray-600 bg-gray-200 px-4 py-2 rounded-lg inline-block">Campanha Encerrada</p>`);

                    headerHtml = `<div class="bg-red-100 p-6">
                                    <h2 class="text-2xl font-bold text-red-800">${donation.campaignTitle}</h2>
                                    <div class="mt-2 border-l-4 border-red-500 text-red-700 pl-4">
                                        <p class="font-bold">Entrega Vencida</p>
                                        <p>Esta entrega estava agendada para ${formattedDate}.</p>
                                        ${rescheduleBtn}
                                    </div>
                                  </div>`;
                    break;
                case 'cancelled':
                      const rebookCancelledBtn = (isCampaignActive && !hasBeenRescheduled)
                        ? `<button data-action="reschedule" data-donation-id="${donation.id}" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Reagendar</button>`
                        : (hasBeenRescheduled ? `<p class="mt-2 text-sm font-semibold text-gray-600 bg-gray-200 px-4 py-2 rounded-lg inline-block">Reagendamento já utilizado</p>` : `<p class="mt-2 text-sm font-semibold text-gray-600 bg-gray-200 px-4 py-2 rounded-lg inline-block">Campanha Encerrada</p>`);

                    headerHtml = `<div class="bg-yellow-100 p-6">
                                    <h2 class="text-2xl font-bold text-yellow-800">${donation.campaignTitle}</h2>
                                    <p class="mt-1 font-semibold text-yellow-700">Agendamento cancelado pela entidade.</p>
                                    ${rebookCancelledBtn}
                                  </div>`;
                    break;
                case 'history':
                    let historyStatusText = 'Não entregue (campanha encerrada)';
                    if (donation.status === 'completed' || (Array.isArray(donation.items) && donation.items.every(i => i.status === 'completed'))) {
                        historyStatusText = `Entregue com sucesso!`;
                    } else if (donation.status === 'reagendado') {
                        historyStatusText = 'Esta doação foi reagendada com sucesso.';
                    }
                    headerHtml = `<div class="bg-gray-100 p-6">
                                    <h2 class="text-2xl font-bold text-gray-800">${donation.campaignTitle}</h2>
                                    <p class="mt-1 font-semibold text-gray-700">${historyStatusText}</p>
                                  </div>`;
                    break;
            }
            
            let addressHtml = '';
            if (campaign?.deliveryAddress) {
                const addr = campaign.deliveryAddress;
                addressHtml = `
                    <div class="border-t p-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 pt-1">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Local de Entrega</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    ${addr.logradouro || ''}, ${addr.numero || 'S/N'} - ${addr.bairro || ''}<br>
                                    ${addr.cidade || ''} - ${addr.estado || ''}, CEP: ${addr.cep || ''}
                                    ${addr.complemento ? `<br>Complemento: ${addr.complemento}` : ''}
                                    ${addr.telefone ? `<br>Contato: ${addr.telefone}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }

            let itemsHtml = itemsToDisplay.map((item) => {
                const itemDetailsHtml = generateItemDetailsHtml(item, campaignType, campaignTypeSettings);
                return `
                <div class="item-card flex items-start space-x-4 p-3 bg-gray-50 rounded-md border transition-all ${item.status !== 'completed' ? 'cursor-pointer' : ''}" 
                     ${item.status !== 'completed' ? `data-donation-id="${donation.id}" data-item-index="${donation.items.indexOf(item)}"` : ''}>
                    <img src="${item.photoURL || 'https://placehold.co/64x64/e2e8f0/e2e8f0?text=Item'}" class="w-16 h-16 rounded-md object-cover flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-bold">${item.type || 'Item sem título'}</p>
                        ${itemDetailsHtml}
                    </div>
                    ${item.status !== 'completed' ? `<div id="qr-${donation.id}-${donation.items.indexOf(item)}" class="w-20 h-20 pointer-events-none flex-shrink-0"></div>` : '<div class="w-20 h-20 flex items-center justify-center"><span class="text-sm font-bold text-green-600">Entregue</span></div>'}
                </div>`;
            }).join('');
            
            card.innerHTML = `${headerHtml}
                <div class="p-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-4">Itens da Doação</h3>
                    <div class="space-y-3">${itemsHtml}</div>
                </div>
                ${addressHtml}`;

            setTimeout(() => {
                itemsToDisplay.forEach((item) => {
                    if (item.status !== 'completed') {
                        const index = donation.items.indexOf(item);
                        generateQRCode(`qr-${donation.id}-${index}`, `${donation.id}|${index}`);
                    }
                });
            }, 0);

            return card;
        }

        function generateQRCode(elementId, text) {
            const element = document.getElementById(elementId);
            if (!element) return;
            try {
                const qr = qrcode(0, 'L');
                qr.addData(text);
                qr.make();
                element.innerHTML = qr.createImgTag(4, 4);
            } catch (e) {
                console.error(`Erro ao gerar QR code para ${elementId}:`, e);
                element.innerHTML = '<p class="text-xs text-red-500">Erro QR</p>';
            }
        }

        tabsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button.tab-button');
            if (button) {
                tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentPage = 1;
                renderActiveTabData();
            }
        });

        loadMoreBtn.addEventListener('click', () => {
            currentPage++;
            renderActiveTabData(true);
        });
        
        // --- INÍCIO DA ALTERAÇÃO ---
        deliveriesList.addEventListener('click', async (e) => {
            const itemCard = e.target.closest('.item-card[data-donation-id]');
            const rescheduleBtn = e.target.closest('[data-action="reschedule"]');

            if (itemCard) {
                const { donationId, itemIndex } = itemCard.dataset;
                const donation = allUserDonations.find(d => d.id === donationId);
                const item = donation.items[itemIndex];
                const campaign = campaignsCache.get(donation.campaignId);
                
                // A função agora retorna apenas o HTML dos detalhes em texto
                const detailsHtml = generateItemDetailsHtml(item, campaign?.type || 'default', campaignTypeSettings);

                // Construímos o conteúdo do modal de forma segura, com uma imagem principal e os detalhes
                const modalContentHtml = `
                    <div class="text-center">
                        <img src="${item.photoURL || 'https://placehold.co/400x400/e2e8f0/e2e8f0?text=Sem+Imagem'}" class="w-full h-64 object-contain rounded-md mb-4 bg-gray-100">
                        <p class="text-sm text-gray-500 mb-4">Campanha: ${donation.campaignTitle}</p>
                        <div class="text-left text-sm space-y-2 p-4 bg-gray-50 rounded-lg border">${detailsHtml}</div>
                        <div class="mt-6">
                            <div id="modal-item-qrcode" class="mx-auto w-40 h-40"></div>
                            <p class="text-sm text-gray-500 mt-2">Apresente este QR Code para a entidade confirmar o recebimento.</p>
                        </div>
                    </div>
                `;

                // Usamos o modal handler padrão da aplicação
                showDetailsModal(item.type || 'Detalhes do Item', modalContentHtml);

                // Geramos o QR Code dentro do novo modal depois que ele é exibido
                setTimeout(() => {
                    generateQRCode('modal-item-qrcode', `${donationId}|${itemIndex}`);
                }, 50);
            }
            
            if (rescheduleBtn) {
                const donationId = rescheduleBtn.dataset.donationId;
                const donationData = allUserDonations.find(d => d.id === donationId);
                
                if (donationData) {
                    localStorage.setItem('rescheduleData', JSON.stringify({
                        oldDonationId: donationId,
                        campaignId: donationData.campaignId,
                        items: donationData.items,
                        privacy: donationData.privacy || 'public'
                    }));
                    
                    window.location.href = `registrar-doacao.html?id=${donationData.campaignId}&reschedule=true`;
                }
            }
        });
        // --- FIM DA ALTERAÇÃO ---
        
        initializeApp();
    </script>
</body>
</html>
