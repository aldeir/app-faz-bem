<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrar Doação</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icons/icon-192x192.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <header id="app-header"></header>
  <main class="container mx-auto py-8 px-4 max-w-3xl">
    <h1 class="text-2xl font-bold mb-6">Registrar Doação</h1>

    <form id="donation-form" class="space-y-6">
      <div>
        <label for="delivery-date" class="block font-medium mb-2">Data de Entrega</label>
        <input type="date" id="delivery-date" class="w-full p-2 border rounded-md" required>
      </div>

      <div id="custom-fields-container"></div>

      <button type="button" id="add-item-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        <i class="fas fa-plus-circle mr-2"></i>Adicionar Item
      </button>

      <div id="donated-items-preview" class="space-y-4 mt-6"></div>

      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded">
        <i class="fas fa-paper-plane mr-2"></i>Finalizar Doação
      </button>
    </form>
  </main>

  <div id="modal-placeholder"></div>

  <script type="module">
    import { db, auth } from './app-config.js';
    import { loadHeader } from './app-header.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDoc, getDocs, addDoc, doc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    loadHeader();

    const customFieldsContainer = document.getElementById('custom-fields-container');
    const previewContainer = document.getElementById('donated-items-preview');
    const addItemBtn = document.getElementById('add-item-btn');
    const donationForm = document.getElementById('donation-form');

    let customFields = [];
    let donatedItems = [];
    let userId = null;
    let campaignId = new URLSearchParams(window.location.search).get('id');

    onAuthStateChanged(auth, async user => {
      if (!user || !user.emailVerified) {
        alert('Você precisa estar logado e com e-mail confirmado para registrar uma doação.');
        window.location.href = 'login.html';
        return;
      }
      userId = user.uid;
      await loadCustomFields();
    });

    async function loadCustomFields() {
      try {
        const configRef = doc(db, 'tiposCampanha', campaignId);
        const snap = await getDoc(configRef);
        if (!snap.exists()) throw new Error('Campos personalizados não encontrados.');

        customFields = snap.data().campos || [];
      } catch (error) {
        console.error('Erro ao carregar campos personalizados:', error);
        customFields = [];
      }
    }

    addItemBtn.addEventListener('click', () => {
      const newItem = {};
      const inputs = [];

      const itemCard = document.createElement('div');
      itemCard.className = 'bg-white p-4 rounded-md shadow-sm border';

      customFields.forEach(field => {
        const id = `item-${field.nome}-${Date.now()}`;
        const label = document.createElement('label');
        label.className = 'block font-medium mt-2';
        label.textContent = field.nome;

        let input;
        if (field.tipo === 'imagem') {
          input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
        } else {
          input = document.createElement('input');
          input.type = field.tipo;
        }
        input.className = 'w-full p-2 border rounded-md';
        input.name = field.nome;
        input.required = true;
        input.id = id;

        inputs.push(input);
        itemCard.appendChild(label);
        itemCard.appendChild(input);
      });

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remover';
      removeBtn.type = 'button';
      removeBtn.className = 'text-red-600 font-medium mt-4';
      removeBtn.addEventListener('click', () => itemCard.remove());

      itemCard.appendChild(removeBtn);
      previewContainer.appendChild(itemCard);

      donatedItems.push({ inputs });
    });

    donationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const deliveryDate = document.getElementById('delivery-date').value;
      if (!deliveryDate) return alert('Data de entrega obrigatória');

      const itens = [];
      for (const group of donatedItems) {
        const itemData = {};
        for (const input of group.inputs) {
          const value = input.type === 'file' ? input.files[0] : input.value.trim();
          if (!value) return alert(`Preencha o campo ${input.name}`);

          itemData[input.name] = value.name || value;
        }
        itens.push(itemData);
      }

      try {
        const agendamento = {
          campanhaId,
          doadorId: userId,
          dataAgendamento: Timestamp.fromDate(new Date(deliveryDate)),
          status: 'agendado',
          itens
        };

        await addDoc(collection(db, 'agendamentos'), agendamento);
        alert('Doação registrada com sucesso!');
        window.location.href = 'minhas-entregas.html';
      } catch (err) {
        console.error('Erro ao registrar doação:', err);
        alert('Erro ao registrar doação.');
      }
    });
  </script>
</body>
</html>
