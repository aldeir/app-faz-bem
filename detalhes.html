<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Campanha - App Faz Bem</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #help-button:disabled { background-color: #4ade80; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- O cabeçalho agora é injetado dinamicamente -->
    <div id="app-header"></div>

    <div id="loading-container" class="flex items-center justify-center h-screen">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg text-gray-600">A carregar detalhes...</p>
        </div>
    </div>

    <main id="campaign-content" class="hidden container mx-auto max-w-5xl p-4 sm:p-6 my-8">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-5">
                <div class="lg:col-span-3 p-6">
                    <div id="media-gallery" class="mb-6">
                        <div class="w-full h-96 bg-black rounded-xl shadow-md mb-4 flex items-center justify-center">
                            <img id="main-image" src="https://placehold.co/800x600/e2e8f0/e2e8f0" class="w-full h-full object-cover rounded-xl" alt="Imagem principal">
                            <video id="main-video" class="hidden w-full h-full rounded-xl" controls></video>
                        </div>
                        <div id="thumbnail-container" class="flex space-x-2 overflow-x-auto p-1">
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sobre a Campanha</h2>
                    <p id="campaign-description" class="text-gray-600 leading-relaxed"></p>
                </div>
                <div class="lg:col-span-2 bg-gray-50 p-6">
                    <div class="sticky top-24">
                        <h1 id="campaign-title" class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight"></h1>
                        <p class="mt-2 text-md text-gray-500">por <span id="entity-name" class="font-semibold text-gray-700"></span></p>
                        <div id="countdown-container" class="mt-6 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-r-lg">
                            <h3 class="font-bold">Esta campanha termina em:</h3>
                            <div id="countdown-timer" class="text-2xl font-mono font-bold"></div>
                        </div>
                        <div id="goal-container" class="mt-6">
                            <div class="flex justify-between items-end">
                                <span class="text-lg font-bold text-green-600">Meta: <span id="goal-value"></span></span>
                                <span id="progress-percentage" class="text-sm font-medium text-gray-600"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                                <div id="progress-bar" class="bg-green-500 h-4 rounded-full"></div>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Como Ajudar</h3>
                            <div class="space-y-4">
                                <div id="address-block" class="flex items-start">
                                    <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    <div>
                                        <h4 class="font-semibold">Local de Entrega</h4>
                                        <p id="campaign-address" class="text-gray-600"></p>
                                    </div>
                                </div>
                                <div id="hours-block" class="flex items-start">
                                    <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div>
                                        <h4 class="font-semibold">Horário</h4>
                                        <p id="campaign-hours" class="text-gray-600"></p>
                                    </div>
                                </div>
                                <div id="docs-block" class="flex items-start">
                                    <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <div>
                                        <h4 class="font-semibold">Documentos Necessários</h4>
                                        <p id="campaign-docs" class="text-gray-600"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <button id="help-button" class="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 text-lg transition-colors">
                                Eu Quero Ajudar!
                            </button>
                            <p id="helpers-count-text" class="text-center text-sm text-gray-500 mt-2"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { db, auth, onAuthStateChanged, firebaseConfig, getCurrentUser } from './app-config.js';
        import { doc, getDoc, collection, getDocs, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { injectHeader } from './app-header.js';

        const loadingContainer = document.getElementById('loading-container');
        const campaignContent = document.getElementById('campaign-content');
        const helpButton = document.getElementById('help-button');
        const helpersCountText = document.getElementById('helpers-count-text');
        
        let currentUserSession = null;
        let campaignId = null;
        let countdownInterval;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!user.emailVerified && user.providerData.some(p => p.providerId === 'password')) {
                    window.location.href = 'verificar-email.html';
                    return;
                }
                currentUserSession = await getCurrentUser();
                injectHeader();
                loadCampaignDetails();
            } else {
                const destination = window.location.href;
                window.location.href = `login.html?redirect=${encodeURIComponent(destination)}`;
            }
        });

        function updateCountdown(expiresAt) {
            if (countdownInterval) clearInterval(countdownInterval);
            const timerEl = document.getElementById('countdown-timer');
            const countdownContainer = document.getElementById('countdown-container');
            
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = expiresAt.getTime() - now;
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownContainer.innerHTML = '<h3 class="font-bold text-red-700">Campanha Encerrada</h3>';
                    countdownContainer.classList.replace('bg-yellow-100', 'bg-red-100');
                    countdownContainer.classList.replace('border-yellow-400', 'border-red-400');
                    helpButton.disabled = true;
                    helpButton.textContent = 'Campanha Encerrada';
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerEl.innerHTML = `${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
            }, 1000);
        }

        async function loadCampaignDetails() {
            const params = new URLSearchParams(window.location.search);
            campaignId = params.get('id');

            if (!campaignId) {
                loadingContainer.innerHTML = '<p class="text-red-500 text-center">Erro: ID da campanha não encontrado.</p>';
                return;
            }

            try {
                const campaignRef = doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/campaigns`, campaignId);
                const docSnap = await getDoc(campaignRef);

                if (docSnap.exists()) {
                    const campaign = docSnap.data();
                    
                    document.getElementById('campaign-title').textContent = campaign.title;
                    document.getElementById('entity-name').textContent = campaign.entityName;
                    document.getElementById('campaign-description').textContent = campaign.description;
                    
                    const mainImage = document.getElementById('main-image');
                    const mainVideo = document.getElementById('main-video');
                    const thumbContainer = document.getElementById('thumbnail-container');
                    thumbContainer.innerHTML = '';

                    const showImage = (url) => {
                        mainVideo.classList.add('hidden'); mainVideo.pause();
                        mainImage.classList.remove('hidden'); mainImage.src = url;
                    };
                    const showVideo = (url) => {
                        mainImage.classList.add('hidden');
                        mainVideo.classList.remove('hidden'); mainVideo.src = url;
                    };

                    if (campaign.videoUrl) {
                        const thumb = document.createElement('div');
                        thumb.className = 'w-20 h-16 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500 flex-shrink-0 bg-black flex items-center justify-center';
                        thumb.innerHTML = `<svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
                        thumb.onclick = () => showVideo(campaign.videoUrl);
                        thumbContainer.appendChild(thumb);
                    }

                    (campaign.images || []).forEach(imgUrl => {
                        const thumb = document.createElement('img');
                        thumb.src = imgUrl;
                        thumb.className = 'w-20 h-16 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-green-500 flex-shrink-0';
                        thumb.onclick = () => showImage(imgUrl);
                        thumbContainer.appendChild(thumb);
                    });

                    if (campaign.videoUrl) { showVideo(campaign.videoUrl); }
                    else if (campaign.images && campaign.images.length > 0) { showImage(campaign.images[0]); }
                    else { showImage('https://placehold.co/800x600/e2e8f0/e2e8f0?text=Sem+Mídia'); }

                    if(campaign.goal) {
                        const progress = campaign.progress || 0;
                        document.getElementById('goal-value').textContent = `${campaign.goal} unidades`;
                        document.getElementById('progress-percentage').textContent = `${progress}%`;
                        document.getElementById('progress-bar').style.width = `${progress}%`;
                    } else {
                        document.getElementById('goal-container').style.display = 'none';
                    }

                    const address = campaign.address || {};
                    const operation = campaign.operation || {};
                    document.getElementById('campaign-address').textContent = `${address.street || ''}, ${address.number || ''} - ${address.district || ''}`;
                    if(!address.street) document.getElementById('address-block').style.display = 'none';
                    if(operation.hours) { document.getElementById('campaign-hours').textContent = operation.hours; } else { document.getElementById('hours-block').style.display = 'none'; }
                    if(operation.requiredDocs) { document.getElementById('campaign-docs').textContent = operation.requiredDocs; } else { document.getElementById('docs-block').style.display = 'none'; }
                    
                    if (campaign.expiresAt) { updateCountdown(campaign.expiresAt.toDate()); }

                    const interactionsColRef = collection(db, campaignRef.path, 'interactions');
                    const interactionsSnapshot = await getDocs(interactionsColRef);
                    const helpersCount = interactionsSnapshot.size;
                    helpersCountText.textContent = helpersCount > 0 ? `Junte-se a ${helpersCount} pessoa(s) que já decidiram ajudar!` : 'Seja o primeiro a ajudar!';
                    
                    const userInteractionRef = doc(db, interactionsColRef.path, currentUserSession.auth.uid);
                    const userInteractionSnap = await getDoc(userInteractionRef);
                    if (userInteractionSnap.exists()) {
                        helpButton.textContent = 'Obrigado por Ajudar!';
                        helpButton.disabled = true;
                    }

                    loadingContainer.classList.add('hidden');
                    campaignContent.classList.remove('hidden');
                } else {
                    loadingContainer.innerHTML = '<p class="text-red-500 text-center">Campanha não encontrada.</p>';
                }
            } catch (error) {
                console.error("Erro ao procurar detalhes:", error);
                loadingContainer.innerHTML = '<p class="text-red-500 text-center">Ocorreu um erro ao carregar.</p>';
            }
        }

        helpButton.addEventListener('click', async () => {
            if (!currentUserSession?.auth || !campaignId) return;

            const profile = currentUserSession.profile;
            if (!profile || !profile.phone || !profile.address?.cep) {
                alert("Para continuar, por favor, complete seu perfil de doador. Você será redirecionado agora.");
                const destination = `registrar-doacao.html?id=${campaignId}`;
                localStorage.setItem('postProfileUpdateRedirect', destination);
                window.location.href = 'perfil-doador.html';
                return;
            }
            
            window.location.href = `registrar-doacao.html?id=${campaignId}`;
        });
    </script>
</body>
</html>
